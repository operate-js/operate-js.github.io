<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>23级护理四班交流论坛</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4e73df;
            --secondary: #858796;
            --success: #1cc88a;
            --info: #36b9cc;
            --warning: #f6c23e;
            --danger: #e74a3b;
            --light: #f8f9fc;
            --dark: #5a5c69;
            --admin: #e74a3b;
            --teacher: #4e73df;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fc;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 头部导航样式 */
        header {
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            color: white;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 10px;
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .admin-avatar {
            background-color: var(--admin);
        }

        .teacher-avatar {
            background-color: var(--teacher);
        }

        /* 导航栏样式 */
        .sidebar {
            width: 250px;
            background-color: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            padding: 20px 0;
            position: sticky;
            top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .nav-item i {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .nav-item:hover {
            background-color: #f0f3ff;
        }

        .nav-item.active {
            background-color: #4e73df;
            color: white;
        }

        /* 主内容区样式 */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 60px);
        }

        .page-content {
            display: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }

        .page-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f3ff;
            color: var(--dark);
        }

        /* 学习资料卡片样式 */
        .material-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            overflow: hidden;
            transition: transform 0.3s;
        }

        .material-card:hover {
            transform: translateY(-5px);
        }

        .material-header {
            background: linear-gradient(to right, #4e73df, #224abe);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .teacher-badge {
            background-color: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .material-body {
            padding: 20px;
        }

        .file-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .file-list li:last-child {
            border-bottom: none;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        /* 帖子列表样式 */
        .post-item {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 20px;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .post-author {
            display: flex;
            align-items: center;
        }

        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--info);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .author-name {
            font-weight: 600;
        }

        .post-time {
            font-size: 0.85rem;
            color: var(--secondary);
        }

        .post-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .post-content {
            line-height: 1.7;
        }

        /* 聊天区域样式 */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9ff;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            margin-bottom: 20px;
            max-width: 80%;
            display: flex;
            flex-direction: column;
        }

        .current-user-message {
            align-self: flex-end;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .message-sender {
            font-weight: 600;
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--secondary);
        }

        .message-content {
            background: #e9ecef;
            padding: 12px 15px;
            border-radius: 18px;
            display: inline-block;
        }

        .current-user-message .message-content {
            background: #4e73df;
            color: white;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 30px;
            margin-right: 10px;
            font-size: 1rem;
        }

        /* 荣誉墙样式 */
        .honor-wall {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .honor-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .honor-img-container {
            height: 200px;
            overflow: hidden;
            position: relative;
        }

        .honor-img {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-color: #f0f3ff;
            transition: transform 0.3s;
        }

        .honor-img:hover {
            transform: scale(1.05);
        }

        .honor-body {
            padding: 20px;
        }

        .honor-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .honor-desc {
            margin-bottom: 15px;
            color: var(--secondary);
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background-color: #f8fbff;
        }

        /* 模态框样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.2);
            transform: translateY(-20px);
            transition: transform 0.4s;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--dark);
        }

        .close-modal {
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--secondary);
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--dark);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            text-align: right;
        }

        

        

        /* 响应式设计 */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
            }
            
            .main-content {
                max-height: none;
            }
            
            .chat-container {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .honor-wall {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
            }
        }
    .skeleton-card {
    background: #fff;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}
.skeleton-img {
    height: 150px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 4px;
}
.skeleton-text {
    height: 12px;
    background: #f0f0f0;
    margin: 10px 0;
    border-radius: 4px;
}
.skeleton-list {
    margin-top: 15px;
}
.skeleton-item {
    height: 50px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    margin-bottom: 10px;
    border-radius: 4px;
}
.error-message {
    color: #e74a3b;
    padding: 15px;
    text-align: center;
}
@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
</style>
</head>
<body>
    <!-- 头部导航 -->
    <header>
        <div class="logo">
            <i class="fas fa-users"></i>
            <span>23级护理四班交流论坛</span>
        </div>
        <div class="user-controls">
            <button id="loginBtn" class="btn btn-primary">登录</button>
            <div id="userAvatar" class="user-avatar" style="display: none;">U</div>
        </div>
    </header>

    <div class="container">
        <!-- 侧边导航栏 -->
        <div class="sidebar">
            <div class="nav-item active" data-page="home">
                <i class="fas fa-home"></i>
                <span>首页</span>
            </div>
            <div class="nav-item" data-page="forum">
                <i class="fas fa-comments"></i>
                <span>班级论坛</span>
            </div>
            <div class="nav-item" data-page="chat">
                <i class="fas fa-comment-dots"></i>
                <span>实时聊天</span>
            </div>
            <div class="nav-item" data-page="honor">
                <i class="fas fa-trophy"></i>
                <span>荣誉墙</span>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 首页 -->
            <div id="homePage" class="page-content active">
                <h2 class="page-title">班级公告</h2>
                <div class="announcement">
                    <p>欢迎来到23级护理四班交流论坛！</p>
                    <p>这里是班级信息发布、学习资源共享和同学交流的平台。</p>
                </div>
                
                <h2 class="page-title">学习资料</h2>
                <div id="materialsContainer">
                    <div class="skeleton-list" style="display:none;">
                        <div class="skeleton-item"></div>
                        <div class="skeleton-item"></div>
                        <div class="skeleton-item"></div>
                    </div>
                </div>
                <div id="materialError" class="error-message" style="display:none;"></div>
                <div id="materialLoading" style="display: none;"></div>
                <div id="materialUploadSection" style="display: none; margin-top: 20px;">
                    <h3>上传学习资料</h3>
                    <div class="form-group">
                        <label class="form-label">上传文件</label>
                        <div class="upload-area">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: #ccc; margin-bottom: 10px;"></i>
                            <p>点击或拖拽文件到此处上传</p>
                            <input type="file" id="materialFileInput" style="display: none;">
                        </div>
                    </div>
                    <button id="uploadMaterialBtn" class="btn btn-primary">上传</button>
                </div>
                <div id="materialUploadSection" style="display: none; margin-top: 20px;">
                    <h3>上传学习资料</h3>
                    <div class="form-group">
                        <label class="form-label">上传文件</label>
                        <div class="upload-area">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: #ccc; margin-bottom: 10px;"></i>
                            <p>点击或拖拽文件到此处上传</p>
                            <input type="file" id="materialFileInput" style="display: none;">
                        </div>
                    </div>
                    <button id="uploadMaterialBtn" class="btn btn-primary">上传</button>
                </div>
            </div>

            <!-- 班级论坛 -->
            <div id="forumPage" class="page-content">
                <h2 class="page-title">班级论坛</h2>
                <div class="form-group">
                    <input type="text" id="postTitle" class="form-control" placeholder="帖子标题">
                </div>
                <div class="form-group">
                    <textarea id="postContent" class="form-control" placeholder="帖子内容"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">上传图片（可选）</label>
                    <input type="file" id="postImage" accept="image/*">
                </div>
                <button id="postSubmitBtn" class="btn btn-primary">发布帖子</button>
                
                <div class="posts-container" style="margin-top: 30px;">
                    <h3>最新帖子</h3>
                    <ul id="postList" class="post-list">
                        <!-- 帖子动态加载 -->
                    </ul>
                </div>
            </div>

            <!-- 实时聊天 -->
            <div id="chatPage" class="page-content">
                <h2 class="page-title">班级聊天室</h2>
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages">
                        <!-- 聊天消息动态加载 -->
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="输入消息...">
                        <button id="sendMessageBtn" class="btn btn-primary">发送</button>
                    </div>
                </div>
            </div>

            <!-- 荣誉墙 -->
            <div id="honorPage" class="page-content">
                <h2 class="page-title">班级荣誉墙</h2>
                <div id="honorWall" class="honor-wall">
                    <div class="skeleton-card" style="display:none;">
                        <div class="skeleton-img"></div>
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text"></div>
                    </div>
                </div>
                <div id="honorError" class="error-message" style="display:none;"></div>
                <div id="honorLoading" style="display: none;"></div>
                
                <div id="honorEditSection" style="margin-top: 40px; display: none;">
                    <h3>添加荣誉</h3>
                    <div class="form-group">
                        <input type="text" id="honorTitle" class="form-control" placeholder="荣誉标题">
                    </div>
                    <div class="form-group">
                        <textarea id="honorDescription" class="form-control" placeholder="荣誉描述"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">荣誉图片</label>
                        <div class="upload-area">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: #ccc; margin-bottom: 10px;"></i>
                            <p>点击或拖拽文件到此处上传</p>
                            <input type="file" id="honorImage" style="display: none;">
                        </div>
                    </div>
                    <button id="addHonorBtn" class="btn btn-primary">添加荣誉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">用户登录</h3>
                <span class="close-modal" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">邮箱地址</label>
                    <input type="email" id="email" class="form-control" placeholder="请输入邮箱">
                </div>
                <div class="form-group">
                    <label class="form-label">姓名</label>
                    <input type="text" id="userName" class="form-control" placeholder="请输入您的真实姓名">
                </div>
                <div class="form-group">
                    <label class="form-label">验证码</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="code" class="form-control" placeholder="请输入验证码">
                        <button id="getCodeBtn" class="btn btn-primary">获取验证码</button>
                    </div>
                </div>
                <div id="loginStatus" style="margin-top: 15px; color: var(--danger);"></div>
            </div>
            <div class="modal-footer">
                <button id="submitLogin" class="btn btn-primary">登录</button>
            </div>
        </div>
    </div>

    <script>
        // 全局错误处理
        window.addEventListener('error', function(event) {
            console.error('全局错误:', event.error);
        });

        // 全局变量
        const USER_DATA_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Forum/User%20Data/";
        const USER_SET_PATH = "https://api.github.com/repos/operate-js/text-3/contents/User-set/";
        const CHAT_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Chat/Chat%20room/";
        const POST_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Chat/Post/";
        const TEACHER_PATH = "https://api.github.com/repos/operate-js/text-3/contents/root/Teacher%20List/";
        const HONOR_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Wall%20of%20Fame/";
        const MATERIALS_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Learning%20materials/";
        
        const EMAIL_API = "https://api.github.com/repos/operate-js/Emailregistration/dispatches";
        
        // 解密5次的密钥
        const decryptBase64 = (str, times) => {
            for (let i = 0; i < times; i++) {
                str = atob(str);
            }
            return str;
        };
        
        const API_KEY = decryptBase64("VmpKd1MyTXdNVWhTYTJ4WFlsZDRXbFJVUWt0aU1YQkdWMVJTYkZKVVJsZFZNblJUVldzeFIyTkdhRlZXUlVwNVdrUktWMUpYU2tkaFJuQnBVak5vTVZkc1pEUlNNRFZIVjJ0V1UySkhhRnBVVlZKelpHeHNXV05IT1ZaU01GcDVXbFZTVDFaWFNsZFRWRUpYVWpOb2VsWnJWVEZXTVZaeVpFZHdUbUpGY0hwV1YzUnJWREF3ZVZWdVVsTmhiRnBSVld0a2IxVkdXa2RWYXpsVFZtdHNNMXBJY0ZkaFJscDBXa1JPVm1GclduSlpiWGhhWld4T1ZWRnNTbGRXVm5CS1ZteFdWMk14V1hoVVdHUlRZa1p3VkZsc1pGTmxiR3QzVm01a1QxcDZNRGs9", 5);
        
        let currentUser = null;
        let isAdmin = false;
        let isTeacher = false;
        
        // DOM元素
        const loginBtn = document.getElementById('loginBtn');
        const userAvatar = document.getElementById('userAvatar');
        const loginModal = document.getElementById('loginModal');
        const closeModal = document.getElementById('closeModal');
        const getCodeBtn = document.getElementById('getCodeBtn');
        const submitLogin = document.getElementById('submitLogin');
        const loginStatus = document.getElementById('loginStatus');
        const navItems = document.querySelectorAll('.nav-item');
        const pageContents = document.querySelectorAll('.page-content');
        
        // 页面导航
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                navItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                const pageId = this.dataset.page + 'Page';
                pageContents.forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById(pageId).classList.add('active');
                
                switch(pageId) {
                    case 'homePage':
                        loadMaterials();
                        break;
                    case 'forumPage':
                        loadPosts();
                        break;
                    case 'chatPage':
                        loadChatMessages();
                        break;
                    case 'honorPage':
                        loadHonors();
                        break;
                }
            });
        });
        
        // 登录模态框控制
        loginBtn.addEventListener('click', () => {
            loginModal.classList.add('active');
            
            // 预填充邮箱和姓名
            const savedEmail = localStorage.getItem('userEmail');
            const savedUserName = localStorage.getItem('userName');
            const emailInput = document.getElementById('email');
            const userNameInput = document.getElementById('userName');
            
            if (savedEmail && emailInput) {
                emailInput.value = savedEmail;
            }
            if (savedUserName && userNameInput) {
                userNameInput.value = savedUserName;
            }
        });
        
        closeModal.addEventListener('click', () => {
            loginModal.classList.remove('active');
        });
        
        loginModal.addEventListener('click', (e) => {
            if (e.target === loginModal) {
                loginModal.classList.remove('active');
            }
        });
        
        // 获取验证码
        getCodeBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!emailRegex.test(email)) {
                loginStatus.textContent = '请输入有效的邮箱地址';
                return;
            }
            
            // 验证姓名
            const userName = document.getElementById('userName').value;
            const nameRegex = /^[\u4e00-\u9fa5·]+$/;
            if (!nameRegex.test(userName)) {
                loginStatus.textContent = '请输入有效的中国姓名（仅限汉字和·）';
                return;
            }
            
            getCodeBtn.disabled = true;
            let countdown = 30;
            
            // 生成6位随机验证码
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            
            // 存储验证码和时间戳
            localStorage.setItem('verificationCode', code);
            localStorage.setItem('codeTimestamp', Date.now());
            localStorage.setItem('userEmail', email);
            localStorage.setItem('userName', userName);
            
            try {
                const response = await fetch(EMAIL_API, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        event_type: 'send_email_request',
                        client_payload: {
                            email: email,
                            code: code
                        }
                    })
                });
                
                if (response.ok) {
                    loginStatus.textContent = `验证码已发送至 ${email}，有效期为5分钟`;
                } else {
                    const errorData = await response.json();
                    loginStatus.textContent = `发送失败: ${errorData.message || response.status}`;
                }
            } catch (error) {
                loginStatus.textContent = `API错误: ${error.message}`;
            }
            
            // 倒计时
            const timer = setInterval(() => {
                getCodeBtn.textContent = `重新获取(${countdown})`;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(timer);
                    getCodeBtn.disabled = false;
                    getCodeBtn.textContent = '获取验证码';
                }
            }, 1000);
        });
        
        // 提交登录
        submitLogin.addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const userName = document.getElementById('userName').value;
            const code = document.getElementById('code').value;
            
            if (!email) {
                loginStatus.textContent = '请输入邮箱地址';
                return;
            }
            
            if (!userName) {
                loginStatus.textContent = '请输入姓名';
                return;
            }
            
            if (!code || code.length !== 6) {
                loginStatus.textContent = '请输入6位验证码';
                return;
            }
            
            const storedCode = localStorage.getItem('verificationCode');
            const timestamp = localStorage.getItem('codeTimestamp');
            
            if (!storedCode || !timestamp) {
                loginStatus.textContent = '请先获取验证码';
                return;
            }
            
            // 检查验证码是否在5分钟内
            const currentTime = Date.now();
            const timeDiff = (currentTime - parseInt(timestamp)) / (1000 * 60);
            
            if (timeDiff > 5) {
                loginStatus.textContent = '验证码已过期';
                return;
            }
            
            if (code === storedCode) {
                loginStatus.textContent = '登录成功！';
                
                setTimeout(() => {
                    loginModal.classList.remove('active');
                    loginBtn.style.display = 'none';
                    userAvatar.style.display = 'flex';
                    userAvatar.textContent = userName.charAt(0).toUpperCase();
                    
                    currentUser = email;
                    isAdmin = (email === '3343363350@qq.com');
                    isTeacher = isAdmin || email.includes('teacher');
                    
                    updateUIPermissions();
                    saveUserData(userName);
                }, 1000);
            } else {
                loginStatus.textContent = '验证码错误，请重新输入';
            }
        });
        
        // 更新UI权限
        function updateUIPermissions() {
            document.getElementById('honorEditSection').style.display = isTeacher ? 'block' : 'none';
            document.getElementById('materialUploadSection').style.display = isTeacher ? 'block' : 'none';
            
            if (isAdmin) {
                userAvatar.classList.add('admin-avatar');
            } else if (isTeacher) {
                userAvatar.classList.add('teacher-avatar');
            }
        }
        
        // 保存用户数据到云存储
        async function saveUserData(userName) {
            if (!currentUser) return;
            
            const userData = {
                email: currentUser,
                name: userName,
                isAdmin: isAdmin,
                isTeacher: isTeacher,
                lastLogin: new Date().toISOString()
            };
            
            try {
                // 保存到论坛用户数据
                await fetch(`${USER_DATA_PATH}${encodeURIComponent(currentUser)}.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        message: `Add user data for ${currentUser}`,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(userData))))
                    })
                });
                
                // 保存到用户设置
                const userSetData = {
                    name: userName
                };
                
                // 对数据进行 Base64 加密
                const jsonString = JSON.stringify(userSetData);
                const encodedContent = btoa(unescape(encodeURIComponent(jsonString)));
                
                // 创建包含加密内容的请求体
                const requestBody = {
                    message: `Update user name for ${currentUser}`,
                    content: encodedContent
                };
                
                await fetch(`${USER_SET_PATH}${encodeURIComponent(currentUser)}/用户数据.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify(requestBody)
                });
            } catch (error) {
                console.error('保存用户数据失败:', error);
            }
        }
        
        // 安全的数据解析函数
        const safeParseData = (content) => {
            try {
                return JSON.parse(content);
            } catch (e1) {
                try {
                    const decoded = atob(content);
                    return JSON.parse(decoded);
                } catch (e2) {
                    console.error('无法解析的数据内容:', content);
                    return null;
                }
            }
        };
        
        // 获取所有用户数据
        let userNamesCache = {};
        async function loadAllUserNames() {
            try {
                const response = await fetch(USER_SET_PATH, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                if (!Array.isArray(data)) return;
                
                for (const userFolder of data) {
                    if (userFolder.type === 'dir') {
                        try {
                            const userResponse = await fetch(`${USER_SET_PATH}${encodeURIComponent(userFolder.name)}/用户数据.json`, {
                                headers: {
                                    'Authorization': `Bearer ${API_KEY}`,
                                    'Accept': 'application/vnd.github+json'
                                }
                            });
                            
                            if (userResponse.ok) {
                                const userData = await userResponse.json();
                                try {
                                    // 尝试直接解析 JSON（如果未加密）
                                    const parsedData = JSON.parse(userData.content);
                                    userNamesCache[userFolder.name] = parsedData.name;
                                } catch (e) {
                                    // 如果解析失败，尝试 Base64 解码
                                    const decodedContent = atob(userData.content);
                                    const parsedData = JSON.parse(decodedContent);
                                    userNamesCache[userFolder.name] = parsedData.name;
                                }
                            }
                        } catch (error) {
                            console.error(`加载用户 ${userFolder.name} 数据失败:`, error);
                        }
                    }
                }
            } catch (error) {
                console.error('加载用户数据失败:', error);
            }
        }
        
        // 加载学习资料
        async function loadMaterials() {
            const materialsContainer = document.getElementById('materialsContainer');
            if (!materialsContainer) return;
            
            // 保留现有内容，仅追加新数据
            const existingFiles = new Set();
            materialsContainer.querySelectorAll('.material-card').forEach(card => {
                card.querySelectorAll('li').forEach(li => {
                    existingFiles.add(li.querySelector('span').textContent);
                });
            });
            
            try {
                const response = await fetch(`${MATERIALS_PATH}?recursive=1`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                const teachers = {};
                
                // 组织教师资料
                data.forEach(item => {
                    if (item.type === 'dir') {
                        teachers[item.name] = {
                            name: item.name,
                            files: []
                        };
                    }
                });
                
                for (const teacher of Object.values(teachers)) {
                    try {
                        const teacherResponse = await fetch(`${MATERIALS_PATH}${encodeURIComponent(teacher.name)}`, {
                            headers: {
                                'Authorization': `Bearer ${API_KEY}`,
                                'Accept': 'application/vnd.github+json'
                            }
                        });
                        
                        if (teacherResponse.ok) {
                            const teacherData = await teacherResponse.json();
                            teacher.files = teacherData.map(file => ({
                                name: file.name,
                                download_url: file.download_url
                            }));
                        }
                    } catch (error) {
                        console.error('加载教师资料错误:', error);
                    }
                }
                
                materialsContainer.innerHTML = '';
                Object.values(teachers).forEach(teacher => {
                    if (teacher.files.length === 0) return;
                    
                    const materialCard = document.createElement('div');
                    materialCard.className = 'material-card';
                    materialCard.innerHTML = `
                        <div class="material-header">
                            <h3>${teacher.name}</h3>
                            <span class="teacher-badge">教师</span>
                        </div>
                        <div class="material-body">
                            <ul class="file-list">
                                ${teacher.files.map(file => `
                                    <li>
                                        <span>${file.name}</span>
                                        <div class="file-actions">
                                            <button class="btn btn-primary download-btn" data-url="${file.download_url}">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            ${isTeacher ? `<button class="btn btn-danger delete-file-btn" data-path="${MATERIALS_PATH}${encodeURIComponent(teacher.name)}/${encodeURIComponent(file.name)}">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                    materialsContainer.insertBefore(materialCard, materialsContainer.firstChild);
                });
                
                // 添加下载和删除事件
                document.querySelectorAll('.download-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const url = btn.dataset.url;
                        // 直接下载文件
                        fetch(url)
                            .then(response => response.blob())
                            .then(blob => {
                                const a = document.createElement('a');
                                a.href = URL.createObjectURL(blob);
                                a.download = url.split('/').pop();
                                a.style.display = 'none';
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(a.href);
                            })
                            .catch(() => {
                                alert('下载失败，请联系管理员');
                            });
                    });
                });
                
                document.querySelectorAll('.delete-file-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('确定要删除这个文件吗？')) {
                            try {
                                const response = await fetch(btn.dataset.path, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${API_KEY}`,
                                        'Accept': 'application/vnd.github+json',
                                        'X-GitHub-Api-Version': '2022-11-28'
                                    },
                                    body: JSON.stringify({
                                        message: `Delete file ${btn.dataset.path.split('/').pop()}`,
                                        sha: btn.dataset.sha
                                    })
                                });
                                
                                if (response.ok) {
                                    loadMaterials();
                                } else {
                                    alert('删除文件失败');
                                }
                            } catch (error) {
                                console.error('删除文件错误:', error);
                            }
                        }
                    });
                });
                
            } catch (error) {
                console.error('加载学习资料错误:', error);
            }
        }
        
        // 加载帖子
        async function loadPosts() {
            const postList = document.getElementById('postList');
            if (!postList) return;
            
            try {
                const response = await fetch(POST_PATH + '?sort=updated&direction=desc', {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                const existingPostIds = new Set();
                postList.querySelectorAll('[data-id]').forEach(el => {
                    existingPostIds.add(el.dataset.id);
                });
                
                data.forEach(item => {
                    try {
                        // 从文件名解析数据
                        const fileName = item.name;
                        const dataPart = fileName.split('.')[0];
                        const base64Decoded = atob(dataPart);
                        const decodedStr = decodeURIComponent(escape(base64Decoded));
                        const postData = JSON.parse(decodedStr);
                        
                        // 跳过已存在的帖子
                        if (existingPostIds.has(postData.id)) return;
                        
                        const email = postData.email || 'unknown@example.com';
                        const userName = userNamesCache[email] || localStorage.getItem('userName') || email;
                        
                        const postItem = document.createElement('li');
                        postItem.className = 'post-item';
                        postItem.dataset.id = postData.id;
                        postItem.innerHTML = `
                            <div class="post-header">
                                <div class="post-author">
                                    <div class="author-avatar ${postData.isAdmin ? 'admin-avatar' : (postData.isTeacher ? 'teacher-avatar' : '')}">
                                        ${userName.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div class="author-name">${userName}</div>
                                        <div class="post-time">${new Date(postData.timestamp).toLocaleString()}</div>
                                    </div>
                                </div>
                                <div class="post-actions">
                                    ${(currentUser === email || isAdmin) ? 
                                        `<button class="btn btn-danger delete-post-btn" 
                                            data-id="${postData.id}"
                                            data-filename="${fileName}"
                                            data-sha="${item.sha}">
                                            <i class="fas fa-trash"></i>
                                        </button>` : ''}
                                </div>
                            </div>
                            <h3 class="post-title">${postData.title}</h3>
                            <div class="post-content">
                                <p>${postData.content}</p>
                            </div>
                        `;
                        
                        // 如果有图片，显示图片
                        if (item.size > 0) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'image-preview-container';
                            imgContainer.style.maxWidth = '100%';
                            imgContainer.style.overflow = 'hidden';
                            
                            // 确保图片内容正确加载
                            fetch(item.download_url)
                                .then(response => response.blob())
                                .then(blob => {
                                    const reader = new FileReader();
                                    reader.onload = function() {
                                        const img = document.createElement('img');
                                        img.src = reader.result;
                                        img.alt = '帖子图片';
                                        img.className = 'image-preview';
                                        img.style.maxWidth = '100%';
                                        img.style.height = 'auto';
                                        img.style.cursor = 'pointer';
                                        
                                        // 点击图片时打开原始URL
                                        img.addEventListener('click', () => {
                                            window.open(item.download_url, '_blank');
                                        });
                                        
                                        imgContainer.appendChild(img);
                                    };
                                    reader.readAsDataURL(blob);
                                })
                                .catch(() => {
                                    console.error('图片加载失败');
                                });
                            
                            postItem.querySelector('.post-content').appendChild(imgContainer);
                        }
                        
                        postList.insertBefore(postItem, postList.firstChild);
                    } catch (e) {
                        console.error('解析帖子错误:', e, item);
                    }
                });
                
                // 添加删除事件
                document.querySelectorAll('.delete-post-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('确定要删除这个帖子吗？')) {
                            try {
                                // 直接使用按钮中存储的文件名和SHA值
                                const fileName = btn.dataset.filename;
                                const fileSha = btn.dataset.sha;
                                
                                if (!fileName || !fileSha) {
                                    alert('删除失败：缺少必要的文件信息');
                                    return;
                                }
                                
                                // 执行删除操作
                                const response = await fetch(`${POST_PATH}${fileName}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${API_KEY}`,
                                        'Accept': 'application/vnd.github+json',
                                        'X-GitHub-Api-Version': '2022-11-28'
                                    },
                                    body: JSON.stringify({
                                        message: `Delete post ${btn.dataset.id}`,
                                        sha: fileSha
                                    })
                                });
                                
                                if (response.ok) {
                                    loadPosts();
                                } else {
                                    alert('删除帖子失败');
                                }
                            } catch (error) {
                                console.error('删除帖子错误:', error);
                            }
                        }
                    });
                });
                
                // 加载完成后显示帖子列表
                postLoading.style.display = 'none';
                postList.style.display = 'block';
                
            } catch (error) {
                console.error('加载帖子错误:', error);
                postLoading.innerHTML = `<p style="color: var(--danger);">加载失败: ${error.message}</p>`;
            }
        }
        
        // 发布帖子
        document.getElementById('postSubmitBtn').addEventListener('click', async () => {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const imageInput = document.getElementById('postImage');
            
            if (!title || !content) {
                alert('请填写标题和内容');
                return;
            }
            
            if (!currentUser) {
                alert('请先登录');
                return;
            }
            
            const postData = {
                id: Date.now().toString(),
                title: title,
                content: content,
                email: currentUser,
                isAdmin: isAdmin,
                isTeacher: isTeacher,
                timestamp: new Date().toISOString()
            };
            
            // 将数据编码为Base64作为文件名
            const dataBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(postData))));
            const fileName = `${dataBase64}.json.png`;
            
            let fileContent = '';
            if (imageInput.files.length) {
                const file = imageInput.files[0];
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片大小不能超过5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function() {
                    fileContent = reader.result.split(',')[1];
                    uploadPostFile(fileName, fileContent);
                };
                reader.readAsDataURL(file);
            } else {
                uploadPostFile(fileName, fileContent);
            }
        });
        
        // 上传帖子文件
        async function uploadPostFile(fileName, content) {
            try {
                const response = await fetch(`${POST_PATH}${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        message: `New post by ${currentUser}`,
                        content: content
                    })
                });
                
                if (response.ok) {
                    alert('帖子发布成功');
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postContent').value = '';
                    document.getElementById('postImage').value = '';
                    loadPosts();
                } else {
                    alert('帖子发布失败');
                }
            } catch (error) {
                console.error('发布帖子错误:', error);
            }
        }
        
        // 加载聊天消息（智能滚动模式）
        async function loadChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            // 保存当前滚动位置和高度
            const scrollBefore = chatMessages.scrollTop;
            const scrollHeightBefore = chatMessages.scrollHeight;
            
            try {
                const response = await fetch(CHAT_PATH, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                if (!Array.isArray(data)) return;
                
                // 获取当前已显示的消息ID
                const existingMessageIds = new Set();
                chatMessages.querySelectorAll('.message').forEach(el => {
                    const id = el.dataset.id;
                    if (id) existingMessageIds.add(id);
                });
                
                // 只添加新消息
                let hasNewMessages = false;
                for (const item of data) {
                    try {
                        // 从文件名解析数据
                        const fileName = item.name;
                        const dataPart = fileName.split('.')[0];
                        const base64Decoded = atob(dataPart);
                        const decodedStr = decodeURIComponent(escape(base64Decoded));
                        const messageData = JSON.parse(decodedStr);
                        
                        // 如果消息已存在则跳过
                        if (existingMessageIds.has(messageData.id)) continue;
                        
                        const userName = localStorage.getItem('userName') || messageData.sender;
                        
                        const messageEl = document.createElement('div');
                        messageEl.className = `message ${messageData.sender === currentUser ? 'current-user-message' : ''}`;
                        messageEl.dataset.id = messageData.id;
                        messageEl.innerHTML = `
                            <div class="message-header">
                                <span class="message-sender">${userName}</span>
                                <span class="message-time">${new Date(messageData.timestamp).toLocaleTimeString()}</span>
                            </div>
                            <div class="message-content">${messageData.content}</div>
                        `;
                        
                        chatMessages.appendChild(messageEl);
                        hasNewMessages = true;
                    } catch (e) {
                        console.error('解析聊天消息错误:', e, item);
                    }
                }
                
                // 如果有新消息
                if (hasNewMessages) {
                    // 计算是否在底部附近（距离底部小于100px）
                    const isNearBottom = (scrollHeightBefore - scrollBefore - chatMessages.clientHeight) < 100;
                    
                    // 如果在底部附近或者这是初始加载，则滚动到底部
                    if (isNearBottom || scrollHeightBefore === chatMessages.clientHeight) {
                        scrollChatToBottom();
                    }
                }
                
            } catch (error) {
                console.error('加载聊天记录错误:', error);
            }
        }
        
        // 滚动到聊天底部
        function scrollChatToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                // 使用平滑滚动
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }
        
        
        
        // 智能聊天滚动控制器
        function initSmartChatScroll() {
            // 确保只在聊天界面激活时执行
            const chatContainer = document.querySelector('.chat-container');
            if (!chatContainer || window.getComputedStyle(chatContainer).display === 'none') {
                console.log('[ChatScroll] 聊天界面未激活，跳过初始化');
                return;
            }
            
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) {
                console.error('[ChatScroll] 错误：未找到聊天区域元素');
                return;
            }
            
            // 定义滚动执行函数
            const executeScroll = () => {
                console.log('[ChatScroll] 执行滚动');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };
            
            // 立即执行一次
            executeScroll();
            
            // 监听内容变化（仅当界面可见时）
            const observer = new MutationObserver((mutations) => {
                if (window.getComputedStyle(chatContainer).display !== 'none') {
                    executeScroll();
                }
            });
            
            observer.observe(chatMessages, {
                childList: true,
                subtree: true
            });
            
            // 暴露控制器方法
            window.chatScrollController = {
                refresh: executeScroll,
                dispose: () => observer.disconnect()
            };
        }
        
        // 延迟初始化（确保界面切换完成）
        const initDelayedScroll = () => {
            setTimeout(initSmartChatScroll, 300);
        };
        
        // 通过事件监听触发（替代直接执行）
        document.addEventListener('chatActivated', initDelayedScroll);
        
        // 开发调试接口
        window.debugChatScroll = initSmartChatScroll;
        
        // 发送消息
        document.getElementById('sendMessageBtn').addEventListener('click', async () => {
            const messageInput = document.getElementById('chatInput');
            let content = messageInput.value.trim();
            
            if (!content) {
                alert('请输入消息内容');
                return;
            }
            
            if (!currentUser) {
                alert('请先登录');
                return;
            }
            
            // 修复编码问题
            // 确保UTF-8编码处理
            content = content;
            
            const messageData = {
                id: Date.now().toString(),
                sender: currentUser,
                content: content,
                timestamp: new Date().toISOString()
            };
            
            // 将数据编码为Base64作为文件名
            const dataBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(messageData))));
            const fileName = `${dataBase64}.json.png`;
            
            try {
                const response = await fetch(`${CHAT_PATH}${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        message: `New chat message from ${currentUser}`,
                        content: '' // 聊天消息没有图片
                    })
                });
                
                if (response.ok) {
                    messageInput.value = '';
                    loadChatMessages();
                    scrollChatToBottom();
                } else {
                    alert('发送消息失败');
                }
            } catch (error) {
                console.error('发送消息错误:', error);
            }
        });
        
        // 加载荣誉墙
        async function loadHonors() {
            const honorWall = document.getElementById('honorWall');
            if (!honorWall) return;
            
            // 保留现有内容，仅追加新数据
            const existingIds = new Set();
            honorWall.querySelectorAll('.honor-card').forEach(card => {
                existingIds.add(card.dataset.id);
            });
            
            try {
                const response = await fetch(HONOR_PATH, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                honorWall.innerHTML = '';
                
                if (!Array.isArray(data)) return;
                
                data.forEach(item => {
                    try {
                        // 从文件名解析数据
                        const fileName = item.name;
                        const dataPart = fileName.split('.')[0];
                        const base64Decoded = atob(dataPart);
                        // 修复编码问题
            const decodedStr = decodeURIComponent(escape(base64Decoded)); // 确保UTF-8编码正确解析 // 确保UTF-8编码正确解析
                        const honorData = JSON.parse(decodedStr);
                        
                        const honorCard = document.createElement('div');
                        honorCard.className = 'honor-card';
                        honorCard.innerHTML = `
                            <div class="honor-body">
                                <h3 class="honor-title">${honorData.title}</h3>
                                <p class="honor-desc">${honorData.description}</p>
                                <button class="btn btn-primary">
                                    <i class="fas fa-share"></i> 分享荣誉
                                </button>
                                ${isTeacher ? `<button class="btn btn-danger delete-honor-btn" data-id="${honorData.id}">
                                    <i class="fas fa-trash"></i>
                                </button>` : ''}
                            </div>
                        `;
                        
                        // 如果有图片，显示图片（与论坛帖子相同的方式）
                        if (item.size > 0) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'image-preview-container';
                            imgContainer.style.maxWidth = '100%';
                            imgContainer.style.overflow = 'hidden';
                            
                            // 确保图片内容正确加载
                            fetch(item.download_url)
                                .then(response => response.blob())
                                .then(blob => {
                                    const reader = new FileReader();
                                    reader.onload = function() {
                                        const img = document.createElement('img');
                                        img.src = reader.result;
                                        img.alt = '荣誉图片';
                                        img.className = 'image-preview';
                                        img.style.maxWidth = '100%';
                                        img.style.height = 'auto';
                                        img.style.cursor = 'pointer';
                                        
                                        // 点击图片时打开原始URL
                                        img.addEventListener('click', () => {
                                            window.open(item.download_url, '_blank');
                                        });
                                        
                                        imgContainer.appendChild(img);
                                    };
                                    reader.readAsDataURL(blob);
                                })
                                .catch(() => {
                                    console.error('图片加载失败');
                                });
                            
                            honorCard.insertBefore(imgContainer, honorCard.firstChild);
                        }
                        honorWall.insertBefore(honorCard, honorWall.firstChild);
                        
                        if (isTeacher) {
                            honorCard.querySelector('.delete-honor-btn').addEventListener('click', async () => {
                                if (confirm('确定要删除这个荣誉吗？')) {
                                    try {
                                        const response = await fetch(item.url, {
                                            method: 'DELETE',
                                            headers: {
                                                'Authorization': `Bearer ${API_KEY}`,
                                                'Accept': 'application/vnd.github+json',
                                                'X-GitHub-Api-Version': '2022-11-28'
                                            },
                                            body: JSON.stringify({
                                                message: `Delete honor ${item.name}`,
                                                sha: item.sha
                                            })
                                        });
                                        
                                        if (response.ok) {
                                            loadHonors();
                                        } else {
                                            alert('删除荣誉失败');
                                        }
                                    } catch (error) {
                                        console.error('删除荣誉错误:', error);
                                    }
                                }
                            });
                        }
                    } catch (e) {
                        console.error('解析荣誉数据错误:', e, item);
                    }
                });
                
            } catch (error) {
                console.error('加载荣誉墙错误:', error);
            }
        }
        
        // 添加荣誉
        document.getElementById('addHonorBtn').addEventListener('click', async () => {
            const title = document.getElementById('honorTitle').value;
            const description = document.getElementById('honorDescription').value;
            const imageInput = document.getElementById('honorImage');
            
            if (!title || !description) {
                alert('请填写标题和描述');
                return;
            }
            
            const honorData = {
                id: Date.now().toString(),
                title: title,
                description: description,
                timestamp: new Date().toISOString()
            };
            
            // 将数据编码为Base64作为文件名
            const dataBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(honorData))));
            const fileName = `${dataBase64}.json.png`;
            
            let fileContent = '';
            if (imageInput.files.length) {
                const file = imageInput.files[0];
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片大小不能超过5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function() {
                    fileContent = reader.result.split(',')[1];
                    uploadHonorFile(fileName, fileContent);
                };
                reader.readAsDataURL(file);
            } else {
                uploadHonorFile(fileName, fileContent);
            }
        });
        
        // 上传荣誉文件
        async function uploadHonorFile(fileName, content) {
            try {
                const response = await fetch(`${HONOR_PATH}${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        message: `Add honor: ${fileName}`,
                        content: content
                    })
                });
                
                if (response.ok) {
                    alert('荣誉添加成功');
                    document.getElementById('honorTitle').value = '';
                    document.getElementById('honorDescription').value = '';
                    document.getElementById('honorImage').value = '';
                    loadHonors();
                } else {
                    const errorData = await response.json();
                    alert(`添加荣誉失败: ${errorData.message || response.status}`);
                }
            } catch (error) {
                console.error('添加荣誉错误:', error);
                alert(`添加荣誉时出错: ${error.message}`);
            }
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 预填充邮箱和姓名
            const savedEmail = localStorage.getItem('userEmail');
            const savedUserName = localStorage.getItem('userName');
            const emailInput = document.getElementById('email');
            const userNameInput = document.getElementById('userName');
            
            if (savedEmail && emailInput) {
                emailInput.value = savedEmail;
            }
            if (savedUserName && userNameInput) {
                userNameInput.value = savedUserName;
            }
            
            // 初始加载数据
            loadAllUserNames().then(() => {
                loadMaterials();
                loadPosts();
                loadChatMessages();
                loadHonors();
            });
            
            // 初始滚动聊天到底部
            initChatScroll();
            
            // 设置定时器，每5秒静默刷新局部数据（不刷新整个页面）
            setInterval(() => {
                try {
                    loadAllUserNames().then(() => {
                        loadMaterials();
                        loadPosts();
                        loadChatMessages();
                        loadHonors();
                    });
                } catch (error) {
                    console.error('静默刷新失败:', error);
                }
            }, 5000);
            
            // 绑定上传按钮事件
            document.getElementById('uploadMaterialBtn')?.addEventListener('click', async () => {
                const fileInput = document.getElementById('materialFileInput');
                
                if (!fileInput || !currentUser) return;
                
                const files = fileInput.files;
                
                if (files.length === 0) {
                    alert('请选择文件');
                    return;
                }
                
                const file = files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert('文件大小不能超过5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async function() {
                    const content = reader.result.split(',')[1];
                    const fileName = file.name;
                    const filePath = `${MATERIALS_PATH}${encodeURIComponent(currentUser)}/${encodeURIComponent(fileName)}`;
                    
                    try {
                        const response = await fetch(filePath, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${API_KEY}`,
                                'Accept': 'application/json; charset=utf-8',
                                'Content-Type': 'application/json; charset=utf-8'
                            },
                            body: JSON.stringify({
                                message: `Upload material: ${fileName}`,
                                content: content
                            })
                        });
                        
                        if (response.ok) {
                            alert('文件上传成功');
                            fileInput.value = '';
                            loadMaterials();
                        } else {
                            alert('文件上传失败');
                        }
                    } catch (error) {
                        console.error('上传文件错误:', error);
                        alert('上传文件时出错');
                    }
                };
                reader.readAsDataURL(file);
            });
            
            // 点击上传区域触发文件选择
            document.querySelector('.upload-area')?.addEventListener('click', () => {
                document.getElementById('materialFileInput').click();
            });
        });
    </script>
</body>
</html>
