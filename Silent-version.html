<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>23级护理四班交流论坛</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    .author-avatar, .avatar-img {
        border-radius: 50%;
        overflow: hidden;
        width: 40px;
        height: 40px;
        background-image: url('https://operate-js.github.io/text/logo.svg');
        background-size: cover;
        background-position: center;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .loading-spinner {
        background-color: #fff;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        font-size: 16px;
        color: #4e73df;
    }
    
    .loading-spinner i {
        margin-right: 10px;
    }
        :root {
            --primary: #4e73df;
            --secondary: #858796;
            --success: #1cc88a;
            --info: #36b9cc;
            --warning: #f6c23e;
            --danger: #e74a3b;
            --light: #f8f9fc;
            --dark: #5a5c69;
            --admin: #e74a3b;
            --teacher: #4e73df;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fc;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 头部导航样式 */
        header {
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            color: white;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 10px;
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .admin-avatar {
            background-color: var(--admin);
        }

        .teacher-avatar {
            background-color: var(--teacher);
        }

        /* 导航栏样式 */
        .sidebar {
            width: 250px;
            background-color: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            padding: 20px 0;
            position: sticky;
            top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .nav-item i {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .nav-item:hover {
            background-color: #f0f3ff;
        }

        .nav-item.active {
            background-color: #4e73df;
            color: white;
        }

        /* 主内容区样式 */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 60px);
        }

        .page-content {
            display: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }

        .page-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f3ff;
            color: var(--dark);
        }

        /* 学习资料卡片样式 */
        .material-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            overflow: hidden;
            transition: transform 0.3s;
        }

        .material-card:hover {
            transform: translateY(-5px);
        }

        .material-header {
            background: linear-gradient(to right, #4e73df, #224abe);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .teacher-badge {
            background-color: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .material-body {
            padding: 20px;
        }

        .file-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .file-list li:last-child {
            border-bottom: none;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        /* 帖子列表样式 */
        .post-item {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 20px;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .post-author {
            display: flex;
            align-items: center;
        }

        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--info);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .author-name {
            font-weight: 600;
        }

        .post-time {
            font-size: 0.85rem;
            color: var(--secondary);
        }

        .post-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .post-content {
            line-height: 1.7;
        }

        /* 聊天区域样式 */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9ff;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            margin-bottom: 20px;
            max-width: 80%;
            display: flex;
            flex-direction: column;
        }

        .current-user-message {
            align-self: flex-end;
        }

        .message-header {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 5px;
        }
        
        .message-header .post-author {
            display: flex;
            align-items: center;
        }
        
        .message-header .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
        }

        .message-sender {
            font-weight: 600;
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--secondary);
        }

        .message-content {
            background: #e9ecef;
            padding: 12px 15px;
            border-radius: 18px;
            display: inline-block;
        }

        .current-user-message .message-content {
            background: #4e73df;
            color: white;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 30px;
            margin-right: 10px;
            font-size: 1rem;
        }

        /* 荣誉墙样式 */
        .honor-wall {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .honor-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .honor-img-container {
            height: 200px;
            overflow: hidden;
            position: relative;
        }

        .honor-img {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-color: #f0f3ff;
            transition: transform 0.3s;
        }

        .honor-img:hover {
            transform: scale(1.05);
        }

        .honor-body {
            padding: 20px;
        }

        .honor-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .honor-desc {
            margin-bottom: 15px;
            color: var(--secondary);
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background-color: #f8fbff;
        }

        /* 模态框样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.2);
            transform: translateY(-20px);
            transition: transform 0.4s;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--dark);
        }

        .close-modal {
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--secondary);
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--dark);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            text-align: right;
        }

        

        

        /* 响应式设计 */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
            }
            
            .main-content {
                max-height: none;
            }
            
            .chat-container {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .honor-wall {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
            }
        }
    .skeleton-card {
    background: #fff;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}
.skeleton-img {
    height: 150px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 4px;
}
.skeleton-text {
    height: 12px;
    background: #f0f0f0;
    margin: 10px 0;
    border-radius: 4px;
}
.skeleton-list {
    margin-top: 15px;
}
.skeleton-item {
    height: 50px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    margin-bottom: 10px;
    border-radius: 4px;
}
.error-message {
    color: #e74a3b;
    padding: 15px;
    text-align: center;
}
@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
</style>
</head>
<body>
    <!-- 头部导航 -->
    <header>
        <div class="logo">
            <i class="fas fa-users"></i>
            <span>23级护理四班交流论坛</span>
        </div>
        <div class="user-controls">
            <button id="loginBtn" class="btn btn-primary">登录</button>
            <div id="userAvatar" class="user-avatar" style="display: none; position: relative; cursor: pointer; overflow: hidden;">
    <span id="avatarInitial">U</span>
    <input type="file" id="avatarUpload" accept="image/*" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; font-size: 0; z-index: 1000;">
</div>

<script>

    // 从 GitHub API 下载用户数据并处理（仿造论坛数据下载功能）
    async function fetchUserData() {
        let retryCount = 0;
        const maxRetries = 3;
        
        while (retryCount < maxRetries) {
            try {
                // 检查API_KEY是否有效
                if (!API_KEY || API_KEY.trim() === '') {
                    throw new Error('GitHub API密钥未配置，请设置有效的API_KEY');
                }
                
                const response = await fetch(USER_DATA_PATH, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json',
                        'X-GitHub-Api-Version': '2022-11-28'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`获取用户数据失败: ${response.status} ${response.statusText}`);
                }
                
                // 验证响应内容类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`无效的响应类型: ${contentType}`);
                }
                
                // 读取响应文本以便调试
                const responseText = await response.text();
                if (!responseText) {
                    throw new Error('空响应内容');
                }
                
                // 尝试解析JSON
                const files = JSON.parse(responseText);
                const sha = response.headers.get('X-GitHub-SHA');
                
                // 处理403 Forbidden错误
                if (response.status === 403) {
                    const rateLimitRemaining = response.headers.get('X-RateLimit-Remaining');
                    const rateLimitReset = response.headers.get('X-RateLimit-Reset');
                    
                    if (rateLimitRemaining === '0') {
                        const resetTime = new Date(parseInt(rateLimitReset) * 1000);
                        throw new Error(`API请求次数已达上限，请在 ${resetTime.toLocaleTimeString()} 后重试`);
                    }
                    throw new Error('无权访问该资源，请检查API密钥权限');
                }
                
                // 验证数据格式
                if (!Array.isArray(files)) {
                    // 尝试处理可能的非数组响应
                    if (files && typeof files === 'object') {
                        files = [files]; // 转换为数组
                    } else {
                        throw new Error(`响应数据格式无效: ${typeof files}`);
                    }
                }
                
                for (const file of files) {
                    if (file.name.endsWith('.json')) {
                        const userResponse = await fetch(file.download_url, {
                            headers: {
                                'Authorization': `Bearer ${API_KEY}`,
                                'Accept': 'application/vnd.github+json'
                            }
                        });
                        
                        const userDataText = await userResponse.text();
                        const userData = JSON.parse(userDataText);

                        // 检查是否已存在相同的 email 或 avatar
                        const isDuplicate = userAvatars.some(item => 
                            item.email === userData.email || item.avatar === userData.avatar
                        );
                        
                        // 如果不重复，则添加到数组
                        if (!isDuplicate) {
                            userAvatars.push({
                                avatar: userData.avatar,
                                email: userData.email,
                                sha: sha || file.sha
                            });
                        }
                    }
                }
                
                // 保存到 localStorage，与论坛数据下载功能一致
                localStorage.setItem('userAvatars', JSON.stringify(userAvatars));
                localStorage.setItem('userDataSha', sha || '');
                console.log('用户头像数据已保存到 localStorage:', userAvatars);
                
                // 成功则退出重试循环
                return;
                
            } catch (error) {
                console.error(`下载或处理用户数据时出错(尝试 ${retryCount + 1}/${maxRetries}):`, error);
                
                if (retryCount === maxRetries - 1) {
                    // 最后一次尝试失败
                    if (error.message.includes('API请求次数已达上限')) {
                        // 显示更友好的限流提示
                        showErrorToast(error.message);
                    }
                    throw error;
                }
                
                // 根据错误类型设置不同的重试间隔
                const retryDelay = error.message.includes('API请求次数已达上限') 
                    ? 60000 // 限流时等待1分钟
                    : 3000 * (retryCount + 1); // 其他错误使用指数退避
                retryCount++;
            }
        }
    }

    // 调用函数
    fetchUserData();
    function initAvatarUpload() {
        const avatar = document.getElementById('userAvatar');
        const uploadInput = document.getElementById('avatarUpload');
        const avatarInitial = document.getElementById('avatarInitial');
        
        if (!avatar || !uploadInput) return;
        
        // 确保文件输入框在DOM中
        if (!document.body.contains(uploadInput)) {
            avatar.appendChild(uploadInput);
        }
        
        avatar.onclick = function() {
            console.log('触发文件选择');
            uploadInput.click();
        };
        
        console.log('验证上传输入框是否存在:', !!uploadInput);
            // 移除可能存在的重复事件监听器
            uploadInput.removeEventListener('change', arguments.callee);
            // 确保事件只绑定一次并完全阻止默认行为
            if (window.__fileUploadListenerBound) return;
            window.__fileUploadListenerBound = true;
            uploadInput.addEventListener('change', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('文件选择事件触发，已阻止默认行为和事件冒泡');

            const file = e.target.files[0];
            if (!file) return;
            
            // 预览图片
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const avatarInitial = document.getElementById('avatarInitial');
                    const avatar = document.getElementById('userAvatar');
                    
                    // 更新头像显示
                    if (avatarInitial && avatarInitial.parentNode) {
                        avatarInitial.remove(); // 完全移除DOM元素
                    }
                    if (avatar) {
                        avatar.style.background = `center/cover no-repeat url(${event.target.result})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.textContent = ''; // 确保没有残留文本
                    }
                } catch (e) {
                    console.error('图片处理错误:', e);
                }
            };
            reader.onerror = function() {
                console.error('文件读取失败');
            };
            reader.readAsDataURL(file);
        });
    }
    
    // 上传到云端的函数
    function uploadToCloud(file) {
        if (!file) {
            console.warn('没有可上传的文件');
            return;
        }
    }

    // 确保在DOM加载完成后初始化
    if (document.readyState === 'complete') {
        initAvatarUpload();
    } else {
        window.addEventListener('DOMContentLoaded', initAvatarUpload);
    }
</script>
        </div>
    </header>

    <div class="container">
        <!-- 侧边导航栏 -->
        <div class="sidebar">
            <div class="nav-item active" data-page="home" onclick="loadMaterials()">
                <i class="fas fa-home"></i>
                <span>首页</span>
            </div>
            <div class="nav-item" data-page="forum" onclick="loadPosts()">
                <i class="fas fa-comments"></i>
                <span>班级论坛</span>
            </div>
            <div class="nav-item" data-page="chat">
                <i class="fas fa-comment-dots"></i>
                <span>实时聊天</span>
            </div>
            <div class="nav-item" data-page="honor" onclick="loadHonorWall()">
                <i class="fas fa-trophy"></i>
                <span>荣誉墙</span>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 首页 -->
            <div id="homePage" class="page-content active">
                <div id="homeLoading" class="loading-overlay" style="display:none;">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
                <h2 class="page-title">班级公告</h2>
                <div class="announcement">
                    <p>欢迎来到23级护理四班交流论坛！</p>
                    <p>这里是班级信息发布、学习资源共享和同学交流的平台。</p>
                </div>
                
                <h2 class="page-title">学习资料</h2>
                <div id="materialsContainer">
                    <div class="skeleton-list" style="display:none;">
                        <div class="skeleton-item"></div>
                        <div class="skeleton-item"></div>
                        <div class="skeleton-item"></div>
                    </div>
                </div>
                <div id="materialError" class="error-message" style="display:none;"></div>
                <div id="materialLoading" style="display: none;"></div>
                <div id="materialUploadSection" style="display: none; margin-top: 20px;">
                    <h3>上传学习资料</h3>
                    <div class="form-group">
                        <label class="form-label">上传文件</label>
                        <div class="upload-area">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: #ccc; margin-bottom: 10px;"></i>
                            <p>点击或拖拽文件到此处上传</p>
                            <input type="file" id="materialFileInput" style="display: none;">
                        </div>
                    </div>
                    <button id="uploadMaterialBtn" class="btn btn-primary">上传</button>
                </div>
            </div>

            <!-- 班级论坛 -->
            <div id="forumPage" class="page-content">
                <div id="forumLoading" class="loading-overlay" style="display:none;">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
                <h2 class="page-title">班级论坛</h2>
                <div class="form-group">
                    <input type="text" id="postTitle" class="form-control" placeholder="帖子标题">
                </div>
                <div class="form-group">
                    <textarea id="postContent" class="form-control" placeholder="帖子内容"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">上传图片（可选）</label>
                    <input type="file" id="postImage" accept="image/*">
                </div>
                <button id="postSubmitBtn" class="btn btn-primary">发布帖子</button>
                
                <div class="posts-container" style="margin-top: 30px;">
                    <h3>最新帖子</h3>
                    <ul id="postList" class="post-list">
                        <!-- 帖子动态加载 -->
                    </ul>
                </div>
            </div>

            <!-- 实时聊天 -->
            <div id="chatPage" class="page-content">
                <h2 class="page-title">班级聊天室</h2>
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages">
                        <!-- 聊天消息动态加载 -->
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="输入消息...">
                        <button id="sendMessageBtn" class="btn btn-primary">发送</button>
                    </div>
                </div>
                <script>



                    // 监听回车键
                    document.getElementById('chatInput').addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            document.getElementById('sendMessageBtn').click();
                        }
                    });
                </script>
            </div>

            <!-- 荣誉墙 -->
            <div id="honorPage" class="page-content">
                <div id="honorLoading" class="loading-overlay" style="display:none;">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
                <h2 class="page-title">班级荣誉墙</h2>
                <div id="honorWall" class="honor-wall">
                    <div class="skeleton-card" style="display:none;">
                        <div class="skeleton-img"></div>
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text"></div>
                    </div>
                </div>
                <div id="honorError" class="error-message" style="display:none;"></div>
                <div id="honorLoading" style="display: none;"></div>
                
                <div id="honorEditSection" style="margin-top: 40px; display: none;">
                    <h3>添加荣誉</h3>
                    <div class="form-group">
                        <input type="text" id="honorTitle" class="form-control" placeholder="荣誉标题">
                    </div>
                    <div class="form-group">
                        <textarea id="honorDescription" class="form-control" placeholder="荣誉描述"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">荣誉图片</label>
                        <div class="upload-area" id="honorUploadArea">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: #ccc; margin-bottom: 10px;"></i>
                            <p>点击或拖拽文件到此处上传</p>
                            <input type="file" id="honorImage" accept="image/*,.svg" style="display: none;">
                            <div id="honorFileInfo" style="margin-top: 10px; display: none;">
                                <p>文件名: <span id="honorFileName"></span></p>
                                <p>文件大小: <span id="honorFileSize"></span></p>
                                <p>文件类型: <span id="honorFileType"></span></p>
                            </div>
                        </div>
                    </div>
                    <button id="addHonorBtn" class="btn btn-primary">添加荣誉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">用户登录</h3>
                <span class="close-modal" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">邮箱地址</label>
                    <input type="email" id="email" class="form-control" placeholder="请输入邮箱">
                </div>
                <div class="form-group">
                    <label class="form-label">姓名</label>
                    <input type="text" id="userName" class="form-control" placeholder="请输入您的真实姓名">
                </div>
                <div class="form-group">
                    <label class="form-label">验证码</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="code" class="form-control" placeholder="请输入验证码">
                        <button id="getCodeBtn" class="btn btn-primary">获取验证码</button>
                    </div>
                </div>
                <div id="loginStatus" style="margin-top: 15px; color: var(--danger);"></div>
            </div>
            <div class="modal-footer">
                <button id="submitLogin" class="btn btn-primary">登录</button>
            </div>
        </div>
    </div>

    <script>
    // 初始化 userAvatars 数组，从 localStorage 加载数据
    localStorage.setItem('userAvatars', JSON.stringify([]));
    let userAvatars = JSON.parse(localStorage.getItem('userAvatars')) || [];

    // 从 GitHub API 下载用户数据并处理
    async function fetchUserData() {
        try {
            // 检查GitHub访问令牌是否有效
            if (!API_KEY || API_KEY.trim() === '') {
                throw new Error('GitHub访问令牌未配置，请设置有效的API_KEY');
            }
            
            const response = await fetch(USER_DATA_PATH, {
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Accept': 'application/vnd.github+json'
                }
            });
            
            // 检查API响应状态
            if (!response.ok) {
                throw new Error(`GitHub API请求失败: ${response.status} ${response.statusText}`);
            }
            
            const files = await response.json();

            for (const file of files) {
                if (file.name.endsWith('.json')) {
                    const userResponse = await fetch(file.download_url);
                    const userData = await userResponse.json();

                    // 检查是否已存在相同的 email 或 avatar
                    const isDuplicate = userAvatars.some(item => 
                        item.email === userData.email || item.avatar === userData.avatar
                    );
                    
                    // 如果不重复，则添加到数组
                    if (!isDuplicate) {
                        userAvatars.push({
                            avatar: userData.avatar,
                            email: userData.email
                        });
                    }
                }
            }
            // 保存到 localStorage
            localStorage.setItem('userAvatars', JSON.stringify(userAvatars));
        } catch (error) {
            console.error('下载或处理用户数据时出错:', error);
        }
    }

    // 荣誉墙加载函数
    async function loadHonorWall() {
        const honorWall = document.getElementById('honorWall');
        if (!honorWall) return;
        
        try {
            honorWall.innerHTML = '<div class="loading">正在加载荣誉墙...</div>';
            
            await fetchUserData();
            await loadHonors(); // 使用统一的荣誉加载函数
        } catch (error) {
            console.error('荣誉墙加载失败:', error);
            honorWall.innerHTML = '<div class="error">荣誉墙加载失败</div>';
        }
    }
        // 全局错误处理
        window.addEventListener('error', function(event) {
            console.error('全局错误:', event.error);
            
            // 显示网络错误提示
            const errorContainer = document.createElement('div');
            errorContainer.style.position = 'fixed';
            errorContainer.style.bottom = '20px';
            errorContainer.style.right = '20px';
            errorContainer.style.padding = '15px';
            errorContainer.style.backgroundColor = '#ff4444';
            errorContainer.style.color = 'white';
            errorContainer.style.borderRadius = '5px';
            errorContainer.style.zIndex = '9999';
            errorContainer.innerHTML = '网络连接异常，请检查网络设置后刷新页面';
            
            document.body.appendChild(errorContainer);
            
            // 5秒后自动消失
            setTimeout(() => {
                errorContainer.remove();
            }, 5000);
        });

        // 全局变量
        const USER_DATA_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Forum/User%20Data/";
        const CHAT_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Chat/Chat%20room/";
        const POST_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Chat/Post/";
        const TEACHER_PATH = "https://api.github.com/repos/operate-js/text-3/contents/root/Teacher%20List/";
        const ADMIN_PATH = "https://api.github.com/repos/operate-js/text-3/contents/administrator/";
        const HONOR_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Wall%20of%20Fame/";
        const MATERIALS_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Learning%20materials/";
        const EMAIL_API = "https://api.github.com/repos/operate-js/Emailregistration/dispatches";
        const MSG_PATH = "https://api.github.com/repos/operate-js/text-3/contents/message/";
        // 初始化全部用户头像存储
        if (!localStorage.getItem('userAvatars')) {
            localStorage.setItem('userAvatars', JSON.stringify([]));
        }
        
        // 添加手动加载按钮事件
        document.getElementById('loadMaterialsBtn')?.addEventListener('click', loadMaterials);
        document.getElementById('loadForumBtn')?.addEventListener('click', loadPosts);
        document.getElementById('loadHonorBtn')?.addEventListener('click', loadHonorWall);
        
        // 解密5次的密钥
        const decryptBase64 = (str, times) => {
            for (let i = 0; i < times; i++) {
                str = atob(str);
            }
            return str;
        };
        
        const API_KEY = decryptBase64("VmpKd1MyTXdNVWhTYTJ4WFlsZDRXbFJVUWt0aU1YQkdWMVJTYkZKVVJsZFZNblJUVldzeFIyTkdhRlZXUlVwNVdrUktWMUpYU2tkaFJuQnBVak5vTVZkc1pEUlNNRFZIVjJ0V1UySkhhRnBVVlZKelpHeHNXV05IT1ZaU01GcDVXbFZTVDFaWFNsZFRWRUpYVWpOb2VsWnJWVEZXTVZaeVpFZHdUbUpGY0hwV1YzUnJWREF3ZVZWdVVsTmhiRnBSVld0a2IxVkdXa2RWYXpsVFZtdHNNMXBJY0ZkaFJscDBXa1JPVm1GclduSlpiWGhhWld4T1ZWRnNTbGRXVm5CS1ZteFdWMk14V1hoVVdHUlRZa1p3VkZsc1pGTmxiR3QzVm01a1QxcDZNRGs9", 5);
        
        let currentUser = null;
        let isAdmin = false;
        let isTeacher = false;
        
        // DOM元素
        const loginBtn = document.getElementById('loginBtn');
        const userAvatar = document.getElementById('userAvatar');
        const loginModal = document.getElementById('loginModal');
        const closeModal = document.getElementById('closeModal');
        const getCodeBtn = document.getElementById('getCodeBtn');
        const submitLogin = document.getElementById('submitLogin');
        const loginStatus = document.getElementById('loginStatus');
        const navItems = document.querySelectorAll('.nav-item');
        const pageContents = document.querySelectorAll('.page-content');
        
        // 页面导航
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                navItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                const pageId = this.dataset.page + 'Page';
                pageContents.forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById(pageId).classList.add('active');
                
                // 清除残留样式并显示加载提示
                document.querySelectorAll('.loading-overlay').forEach(el => {
                    el.style.display = 'none';
                });
                const loadingElement = document.getElementById(`${this.dataset.page}Loading`);
                if (loadingElement) loadingElement.style.display = 'flex';
                
                // 清除页面缓存数据
                switch(this.dataset.page) {
                    case 'home':
                        if (document.querySelector('#materialsContainer')) {
                            document.querySelector('#materialsContainer').innerHTML = '';
                        }
                        break;
                    case 'forum':
                        if (document.querySelector('#postList')) {
                            document.querySelector('#postList').innerHTML = '';
                        }
                        break;
                    case 'honor':
                        if (document.querySelector('#honorWall')) {
                            document.querySelector('#honorWall').innerHTML = '';
                        }
                        break;
                }
                
                switch(pageId) {
                    case 'homePage':
                        loadMaterials().finally(() => {
                            if (loadingElement) loadingElement.style.display = 'none';
                        });
                        break;
                    case 'forumPage':
                        loadPosts().finally(() => {
                            if (loadingElement) loadingElement.style.display = 'none';
                        });
                        break;
                    case 'chatPage':
                        loadChatMessages().then(() => {
                            // 确保聊天区加载完成后再滚动
                            scrollChatToBottom();
                        });
                        break;
                    case 'honorPage':
                        loadHonorWall().finally(() => {
                            if (loadingElement) loadingElement.style.display = 'none';
                        });
                        break;
                }
            });
        });
        
        // 登录模态框控制
        loginBtn.addEventListener('click', () => {
            loginModal.classList.add('active');
            
            // 预填充邮箱和姓名
            const savedEmail = localStorage.getItem('userEmail');
            const savedUserName = localStorage.getItem('userName');
            const savedAvatar = localStorage.getItem('userAvatar');
            const emailInput = document.getElementById('email');
            const userNameInput = document.getElementById('userName');
            
            // 加载用户头像
            if (savedAvatar) {
                document.getElementById('avatarInitial').style.display = 'none';
                document.getElementById('userAvatar').style.backgroundImage = `url(${savedAvatar})`;
                document.getElementById('userAvatar').style.backgroundSize = 'cover';
            }
            
            if (savedEmail && emailInput) {
                emailInput.value = savedEmail;
            }
            if (savedUserName && userNameInput) {
                userNameInput.value = savedUserName;
            }
        });
        
        closeModal.addEventListener('click', () => {
            loginModal.classList.remove('active');
        });
        
        loginModal.addEventListener('click', (e) => {
            if (e.target === loginModal) {
                loginModal.classList.remove('active');
            }
        });
        
        // 获取验证码
        getCodeBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!emailRegex.test(email)) {
                loginStatus.textContent = '请输入有效的邮箱地址';
                return;
            }
            
            // 验证姓名
            const userName = document.getElementById('userName').value;
            const nameRegex = /^[\u4e00-\u9fa5·]+$/;
            if (!nameRegex.test(userName)) {
                loginStatus.textContent = '请输入有效的中国姓名（仅限汉字和·）';
                return;
            }
            
            getCodeBtn.disabled = true;
            let countdown = 30;
            
            // 生成6位随机验证码
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            
            // 存储验证码和时间戳
            localStorage.setItem('verificationCode', code);
            localStorage.setItem('codeTimestamp', Date.now());
            localStorage.setItem('userEmail', email);
            localStorage.setItem('userName', userName);
            
            try {
                const response = await fetch(EMAIL_API, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        event_type: 'send_email_request',
                        client_payload: {
                            email: email,
                            code: code
                        }
                    })
                });
                
                if (response.ok) {
                    loginStatus.textContent = `验证码已发送至 ${email}，有效期为5分钟`;
                } else {
                    const errorData = await response.json();
                    loginStatus.textContent = `发送失败: ${errorData.message || response.status}`;
                }
            } catch (error) {
                loginStatus.textContent = `API错误: ${error.message}`;
            }
            
            // 倒计时
            const timer = setInterval(() => {
                getCodeBtn.textContent = `重新获取(${countdown})`;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(timer);
                    getCodeBtn.disabled = false;
                    getCodeBtn.textContent = '获取验证码';
                }
            }, 1000);
        });
        
        // 提交登录
        submitLogin.addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const userName = document.getElementById('userName').value;
            const code = document.getElementById('code').value;
            
            if (!email) {
                loginStatus.textContent = '请输入邮箱地址';
                return;
            }
            
            if (!userName) {
                loginStatus.textContent = '请输入姓名';
                return;
            }
            
            if (!code || code.length !== 6) {
                loginStatus.textContent = '请输入6位验证码';
                return;
            }
            
            const storedCode = localStorage.getItem('verificationCode');
            const timestamp = localStorage.getItem('codeTimestamp');
            
            if (!storedCode || !timestamp) {
                loginStatus.textContent = '请先获取验证码';
                return;
            }
            
            // 检查验证码是否在5分钟内
            const currentTime = Date.now();
            const timeDiff = (currentTime - parseInt(timestamp)) / (1000 * 60);
            
            if (timeDiff > 5) {
                loginStatus.textContent = '验证码已过期';
                return;
            }
            
            if (code === storedCode) {
                loginStatus.textContent = '登录成功！';
                
                setTimeout(() => {
                    loginModal.classList.remove('active');
                    loginBtn.style.display = 'none';
                    userAvatar.style.display = 'flex';
                    
                    // 确保没有文字内容
                    const avatarInitial = document.getElementById('avatarInitial');
                    if (avatarInitial) {
                        avatarInitial.remove();
                    }
                    userAvatar.textContent = '';
                    
                    currentUser = email;
                    isAdmin = (email === '3343363350@qq.com');
                    isTeacher = isAdmin || email.includes('teacher');
                    
                    updateUIPermissions();
                    saveUserData(userName);
                }, 1000);
            } else {
                loginStatus.textContent = '验证码错误，请重新输入';
            }
        });
        
        // 更新UI权限
        function updateUIPermissions() {
            // 确保邮箱匹配
            if (!currentUser) return;
            
            // 获取管理员列表并更新权限
            getAdminList().then(admins => {
                const adminEmails = admins.map(admin => admin.email);
                if (adminEmails.includes(currentUser)) {
                    isAdmin = true;
                    userAvatar.classList.add('admin-avatar');
                }
                
                // 管理员和教师都可以看到编辑区域
                const isEditor = isAdmin || isTeacher;
                document.getElementById('honorEditSection').style.display = isEditor ? 'block' : 'none';
                document.getElementById('materialUploadSection').style.display = isEditor ? 'block' : 'none';
                
                // 更新头像样式
                if (isAdmin) {
                    userAvatar.classList.add('admin-avatar');
                } else if (isTeacher) {
                    userAvatar.classList.add('teacher-avatar');
                }
                
                // 同步权限到本地存储
                localStorage.setItem('isAdmin', isAdmin);
                localStorage.setItem('isTeacher', isTeacher);
            });
        }
        
        // 保存用户数据到云存储
        async function saveUserData(userName, sha = null) {
            if (!currentUser) {
                console.warn('未登录用户，跳过保存');
                return;
            }
            
            const userData = {
                email: currentUser,
                name: userName,
                isAdmin: isAdmin,
                isTeacher: isTeacher,
                lastLogin: new Date().toISOString(),
                avatar: localStorage.getItem('userAvatar') || ""
            };
            
            console.log('准备保存用户数据:', userData);
            
            try {
                // 检查是否已存在用户数据
                let existingSha = null;
                try {
                    const checkResponse = await fetch(`${USER_DATA_PATH}${encodeURIComponent(currentUser)}.json`, {
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'Accept': 'application/vnd.github+json'
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const existingData = await checkResponse.json();
                        existingSha = existingData.sha;
                    }
                } catch (checkError) {
                    console.log('未找到现有用户数据，将创建新记录');
                }
                
                const payload = {
                    message: `Update user data for ${currentUser}`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(userData))))
                };
                
                // 如果存在SHA值，添加到payload中
                if (existingSha || sha) {
                    payload.sha = existingSha || sha;
                }
                
                const response = await fetch(`${USER_DATA_PATH}${encodeURIComponent(currentUser)}.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API返回错误: ${errorData.message || response.status}`);
                }
                
                const result = await response.json();
                console.log('用户数据保存成功:', result);
                return result;
            } catch (error) {
                console.error('保存用户数据失败:', error);
                throw error; // 重新抛出错误以便外部捕获
            }
        }
        
        // 安全的数据解析函数
        const safeParseData = (content) => {
            try {
                return JSON.parse(content);
            } catch (e1) {
                try {
                    const decoded = atob(content);
                    return JSON.parse(decoded);
                } catch (e2) {
                    console.error('无法解析的数据内容:', content);
                    return null;
                }
            }
        };
        
        // 获取用户头像
        function getUserAvatar(email, fallbackText) {
            if (!email) return fallbackText;
            
            try {
                // 从 userAvatars 数组中查找匹配的邮箱
                const userAvatars = JSON.parse(localStorage.getItem('userAvatars')) || [];
                const userData = userAvatars.find(item => item.email === email);
                
                if (userData && userData.avatar) {
                    return `<img src="${userData.avatar}" alt="用户头像" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                }
                
                
                // 检查旧版存储方式
                const avatars = localStorage.getItem('userAvatars = []');
                if (avatars) {
                    try {
                        const parsedAvatars = JSON.parse(avatars);
                        if (parsedAvatars && parsedAvatars[email]) {
                            return `<img src="${parsedAvatars[email]}" alt="用户头像" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        }
                    } catch (e) {
                        console.log('非JSON格式的头像数据，直接使用');
                        if (avatars[email]) {
                            return `<img src="${avatars[email]}" alt="用户头像" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        }
                    }
                }
            } catch (e) {
                console.error('获取头像数据错误:', e);
            }
            return fallbackText;
        }
        
        // 加载学习资料
        async function loadMaterials() {
            const materialsContainer = document.getElementById('materialsContainer');
            if (!materialsContainer) return;
            
            // 保留现有内容，仅追加新数据
            const existingFiles = new Set();
            materialsContainer.querySelectorAll('.material-card').forEach(card => {
                card.querySelectorAll('li').forEach(li => {
                    existingFiles.add(li.querySelector('span').textContent);
                });
            });
            
            try {
                const response = await fetch(`${MATERIALS_PATH}?recursive=1`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                const teachers = {};
                
                // 组织教师资料
                data.forEach(item => {
                    if (item.type === 'dir') {
                        teachers[item.name] = {
                            name: item.name,
                            files: []
                        };
                    }
                });
                
                for (const teacher of Object.values(teachers)) {
                    try {
                        const teacherResponse = await fetch(`${MATERIALS_PATH}${encodeURIComponent(teacher.name)}`, {
                            headers: {
                                'Authorization': `Bearer ${API_KEY}`,
                                'Accept': 'application/vnd.github+json'
                            }
                        });
                        
                        if (teacherResponse.ok) {
                            const teacherData = await teacherResponse.json();
                            teacher.files = teacherData
                                .filter(file => !file.name.endsWith('.E')) // 屏蔽.E文件
                                .map(file => ({
                                    name: file.name,
                                    download_url: file.download_url
                                }));
                        }
                    } catch (error) {
                        console.error('加载教师资料错误:', error);
                    }
                }
                
                materialsContainer.innerHTML = '';
                Object.values(teachers).forEach(teacher => {
                    if (teacher.files.length === 0) return;
                    
                    const materialCard = document.createElement('div');
                    materialCard.className = 'material-card';
                    materialCard.innerHTML = `
                        <div class="material-header">
                            <h3>${teacher.name}</h3>
                            <span class="teacher-badge">教师</span>
                        </div>
                        <div class="material-body">
                            <ul class="file-list">
                                ${teacher.files.map(file => `
                                    <li>
                                        <span>${file.name}</span>
                                        <div class="file-actions">
                                            <button class="btn btn-primary download-btn" data-url="${file.download_url}">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            ${(isTeacher || isAdmin) ? `<button class="btn btn-danger delete-file-btn" data-path="${MATERIALS_PATH}${encodeURIComponent(teacher.name)}/${encodeURIComponent(file.name)}">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                    materialsContainer.insertBefore(materialCard, materialsContainer.firstChild);
                });
                
                // 添加下载和删除事件
                document.querySelectorAll('.download-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const url = btn.dataset.url;
                        // 直接下载文件
                        fetch(url)
                            .then(response => response.blob())
                            .then(blob => {
                                const a = document.createElement('a');
                                a.href = URL.createObjectURL(blob);
                                a.download = url.split('/').pop();
                                a.style.display = 'none';
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(a.href);
                            })
                            .catch(() => {
                                alert('下载失败，请联系管理员');
                            });
                    });
                });
                
                document.querySelectorAll('.delete-file-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('确定要删除这个文件吗？')) {
                            try {
                                const response = await fetch(btn.dataset.path, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${API_KEY}`,
                                        'Accept': 'application/vnd.github+json',
                                        'X-GitHub-Api-Version': '2022-11-28'
                                    },
                                    body: JSON.stringify({
                                        message: `Delete file ${btn.dataset.path.split('/').pop()}`,
                                        sha: btn.dataset.sha
                                    })
                                });
                                
                                if (response.ok) {
                                    loadMaterials();
                                } else {
                                    alert('删除文件失败');
                                }
                            } catch (error) {
                                console.error('删除文件错误:', error);
                            }
                        }
                    });
                });
                
            } catch (error) {
                console.error('加载学习资料错误:', error);
            }
        }
        
        // 加载帖子
        async function loadPosts() {
            const postList = document.getElementById('postList');
            if (!postList) return;
            
            try {
                const response = await fetch(POST_PATH + '?sort=updated&direction=desc', {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                const existingPostIds = new Set();
                postList.querySelectorAll('[data-id]').forEach(el => {
                    existingPostIds.add(el.dataset.id);
                });
                
                data
                    .filter(item => !item.name.endsWith('.E')) // 屏蔽.E文件
                    .forEach(item => {
                    try {
                        // 从文件名解析数据
                        const fileName = item.name;
                        const dataPart = fileName.split('.')[0];
                        const base64Decoded = atob(dataPart);
                        const decodedStr = decodeURIComponent(escape(base64Decoded));
                        const postData = JSON.parse(decodedStr);
                        
                        // 跳过已存在的帖子
                        if (existingPostIds.has(postData.id)) return;
                        
                        const email = postData.email || 'unknown@example.com';
                        const userName = localStorage.getItem('userName') || email;
                        
                        const postItem = document.createElement('li');
                        postItem.className = 'post-item';
                        postItem.dataset.id = postData.id;
                        postItem.innerHTML = `
                            <div class="post-header">
                                <div class="post-author">
                                    <div class="author-avatar ${postData.isAdmin ? 'admin-avatar' : (postData.isTeacher ? 'teacher-avatar' : '')}">
                                        ${(() => {
                                            const userAvatar = userAvatars.find(item => item.email === postData.email);
                                            return userAvatar ? 
                                                `<img src="${userAvatar.avatar}" alt="用户头像" class="avatar-img" />` : 
                                                getUserAvatar(postData.email, (postData.name || userName).charAt(0).toUpperCase());
                                        })()}
                                    </div>
                                    <div>
                                        <div class="author-name">${postData.name || userName}</div>
                                        <div class="post-time">${new Date(postData.timestamp).toLocaleString()}</div>
                                    </div>
                                </div>
                                <div class="post-actions">
                                    ${(currentUser === email || isAdmin || isTeacher) ? 
                                        `<button class="btn btn-danger delete-post-btn" 
                                            data-id="${postData.id}"
                                            data-filename="${fileName}"
                                            data-sha="${item.sha}">
                                            <i class="fas fa-trash"></i>
                                        </button>` : ''}
                                </div>
                            </div>
                            <h3 class="post-title">${postData.title}</h3>
                            <div class="post-content">
                                <p>${postData.content}</p>
                            </div>
                        `;
                        
                        // 如果有图片，显示图片
                        if (item.size > 0) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'image-preview-container';
                            imgContainer.style.maxWidth = '100%';
                            imgContainer.style.overflow = 'hidden';
                            
                            // 确保图片内容正确加载
                            fetch(item.download_url)
                                .then(response => response.blob())
                                .then(blob => {
                                    const reader = new FileReader();
                                    reader.onload = function() {
                                        const img = document.createElement('img');
                                        img.src = reader.result;
                                        img.alt = '帖子图片';
                                        img.className = 'image-preview';
                                        img.style.maxWidth = '100%';
                                        img.style.height = 'auto';
                                        img.style.cursor = 'pointer';
                                        
                                        // 点击图片时打开原始URL
                                        img.addEventListener('click', () => {
                                            window.open(item.download_url, '_blank');
                                        });
                                        
                                        imgContainer.appendChild(img);
                                    };
                                    reader.readAsDataURL(blob);
                                })
                                .catch(() => {
                                    console.error('图片加载失败');
                                });
                            
                            postItem.querySelector('.post-content').appendChild(imgContainer);
                        }
                        
                        postList.insertBefore(postItem, postList.firstChild);
                    } catch (e) {
                        console.error('解析帖子错误:', e, item);
                    }
                });
                
                // 添加删除事件
                document.querySelectorAll('.delete-post-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('确定要删除这个帖子吗？')) {
                            try {
                                // 直接使用按钮中存储的文件名和SHA值
                                const fileName = btn.dataset.filename;
                                const fileSha = btn.dataset.sha;
                                
                                if (!fileName || !fileSha) {
                                    alert('删除失败：缺少必要的文件信息');
                                    return;
                                }
                                
                                // 执行删除操作
                                const response = await fetch(`${POST_PATH}${fileName}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${API_KEY}`,
                                        'Accept': 'application/vnd.github+json',
                                        'X-GitHub-Api-Version': '2022-11-28'
                                    },
                                    body: JSON.stringify({
                                        message: `Delete post ${btn.dataset.id}`,
                                        sha: fileSha
                                    })
                                });
                                
                                if (response.ok) {
                                    loadPosts();
                                } else {
                                    alert('删除帖子失败');
                                }
                            } catch (error) {
                                console.error('删除帖子错误:', error);
                            }
                        }
                    });
                });
                
                // 加载完成后显示帖子列表
                const postLoadingElement = document.getElementById('postLoading');
                if(postLoadingElement) {
                    postLoadingElement.style.display = 'none';
                }
                if(postList) {
                    postList.style.display = 'block';
                }
                
            } catch (error) {
                console.error('加载帖子错误:', error);
                postLoading.innerHTML = `<p style="color: var(--danger);">加载失败: ${error.message}</p>`;
            }
        }
        
        // 发布帖子
        document.getElementById('postSubmitBtn').addEventListener('click', async () => {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const imageInput = document.getElementById('postImage');
            
            if (!title || !content) {
                alert('请填写标题和内容');
                return;
            }
            
            if (!currentUser) {
                alert('请先登录');
                return;
            }
            
            const postData = {
                id: Date.now().toString(),
                title: title,
                content: content,
                email: currentUser,
                isAdmin: isAdmin,
                isTeacher: isTeacher,
                timestamp: new Date().toISOString(),
                name: localStorage.getItem('userName') || currentUser
            };
            
            // 将数据编码为Base64作为文件名
            const dataBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(postData))));
            const fileName = `${dataBase64}.json.png`;
            
            let fileContent = '';
            if (imageInput.files.length) {
                const file = imageInput.files[0];
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片大小不能超过5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function() {
                    fileContent = reader.result.split(',')[1];
                    uploadPostFile(fileName, fileContent);
                };
                reader.readAsDataURL(file);
            } else {
                uploadPostFile(fileName, fileContent);
            }
        });
        
        // 上传帖子文件
        async function uploadPostFile(fileName, content) {
            try {
                const response = await fetch(`${POST_PATH}${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        message: `New post by ${currentUser}`,
                        content: content
                    })
                });
                
                if (response.ok) {
                    alert('帖子发布成功');
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postContent').value = '';
                    document.getElementById('postImage').value = '';
                    loadPosts();
                } else {
                    alert('帖子发布失败');
                }
            } catch (error) {
                console.error('发布帖子错误:', error);
            }
        }
        
        // 加载聊天消息（智能滚动模式）
        async function loadChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            // 保存当前滚动位置和高度
            const scrollBefore = chatMessages.scrollTop;
            const scrollHeightBefore = chatMessages.scrollHeight;
            
            try {
                const response = await fetch(CHAT_PATH, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                if (!Array.isArray(data)) return;
                
                // 获取当前已显示的消息ID
                const existingMessageIds = new Set();
                chatMessages.querySelectorAll('.message').forEach(el => {
                    const id = el.dataset.id;
                    if (id) existingMessageIds.add(id);
                });
                
                // 只添加新消息
                let hasNewMessages = false;
                for (const item of data.filter(item => !item.name.endsWith('.E'))) { // 屏蔽.E文件
                    try {
                        // 从文件名解析数据
                        const fileName = item.name;
                        const dataPart = fileName.split('.')[0];
                        const base64Decoded = atob(dataPart);
                        const decodedStr = decodeURIComponent(escape(base64Decoded));
                        const messageData = JSON.parse(decodedStr);
                        
                        // 如果消息已存在则跳过
                        if (existingMessageIds.has(messageData.id)) continue;
                        
                        const userName = localStorage.getItem('userName') || messageData.sender;
                        
                        const messageEl = document.createElement('div');
                        messageEl.className = `message ${messageData.sender === currentUser ? 'current-user-message' : ''}`;
                        messageEl.dataset.id = messageData.id;
                        messageEl.innerHTML = `
                            <div class="message-header">
                                <div class="post-author">
                                    <div class="author-avatar">
                                        ${getUserAvatar(messageData.sender, (messageData.name || messageData.sender || userName).charAt(0).toUpperCase())}
                                    </div>
                                    <div>
                                        <span class="message-sender">${messageData.name || messageData.sender || userName}</span>
                                        <span class="message-time">${new Date(messageData.timestamp).toLocaleTimeString()}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="message-content">${messageData.content}</div>
                        `;
                        
                        chatMessages.appendChild(messageEl);
                        hasNewMessages = true;
                    } catch (e) {
                        console.error('解析聊天消息错误:', e, item);
                    }
                }
                
                // 如果有新消息
                if (hasNewMessages) {
                    // 计算是否在底部附近（距离底部小于100px）
                    const isNearBottom = (scrollHeightBefore - scrollBefore - chatMessages.clientHeight) < 100;
                    
                    // 如果在底部附近或者这是初始加载，则滚动到底部
                    if (isNearBottom || scrollHeightBefore === chatMessages.clientHeight) {
                        scrollChatToBottom();
                    }
                }
                
            } catch (error) {
                console.error('加载聊天记录错误:', error);
            }
        }
        
        // 滚动到聊天底部
        function scrollChatToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                // 使用平滑滚动
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }
        
        
        
        // 智能聊天滚动控制器
        function initSmartChatScroll() {
            // 确保只在聊天界面激活时执行
            const chatContainer = document.querySelector('.chat-container');
            if (!chatContainer || window.getComputedStyle(chatContainer).display === 'none') {
                console.log('[ChatScroll] 聊天界面未激活，跳过初始化');
                return;
            }
            
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) {
                console.error('[ChatScroll] 错误：未找到聊天区域元素');
                return;
            }
            
            // 定义滚动执行函数
            const executeScroll = () => {
                console.log('[ChatScroll] 执行滚动');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };
            
            // 立即执行一次
            executeScroll();
            
            // 监听内容变化（仅当界面可见时）
            const observer = new MutationObserver((mutations) => {
                if (window.getComputedStyle(chatContainer).display !== 'none') {
                    executeScroll();
                }
            });
            
            observer.observe(chatMessages, {
                childList: true,
                subtree: true
            });
            
            // 暴露控制器方法
            window.chatScrollController = {
                refresh: executeScroll,
                dispose: () => observer.disconnect()
            };
        }
        
        // 延迟初始化（确保界面切换完成）
        const initDelayedScroll = () => {
            setTimeout(initSmartChatScroll, 300);
        };
        
        // 通过事件监听触发（替代直接执行）
        document.addEventListener('chatActivated', initDelayedScroll);
        
        // 开发调试接口
        window.debugChatScroll = initSmartChatScroll;
        
        // 发送消息
        document.getElementById('sendMessageBtn').addEventListener('click', async () => {
            const messageInput = document.getElementById('chatInput');
            let content = messageInput.value.trim();
            
            if (!content) {
                alert('请输入消息内容');
                return;
            }
            
            if (!currentUser) {
                alert('请先登录');
                return;
            }
            
            // 确保UTF-8编码处理
            content = content;
            
            const messageData = {
                id: Date.now().toString(),
                sender: currentUser,
                content: content,
                timestamp: new Date().toISOString(),
                name: localStorage.getItem('userName') || currentUser
            };
            

            // 发送到 WebSocket
            try {
                if (typeof WebSocketManager === 'function') {
                    const webSocketManager = new WebSocketManager();
                    if (typeof webSocketManager.sendMessageToWebSocket === 'function') {
                        webSocketManager.sendMessageToWebSocket(messageData);
                    } else {
                        console.error('sendMessageToWebSocket 方法不存在');
                    }
                } else {
                    console.error('WebSocketManager 类未定义');
                }
            } catch (error) {
                console.error('WebSocket 消息发送失败:', error);
            }
            // 将数据编码为Base64作为文件名
            const dataBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(messageData))));
            const fileName = `${dataBase64}.json.png`;
            
            try {
                const response = await fetch(`${CHAT_PATH}${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        message: `New chat message from ${currentUser}`,
                        content: '' // 聊天消息没有图片
                    })
                });
                
                if (response.ok) {
                    messageInput.value = '';
                    loadChatMessages();
                    scrollChatToBottom();
                } else {
                    alert('发送消息失败');
                }
            } catch (error) {
                console.error('发送消息错误:', error);
            }
        });
        
        // 获取管理员列表
        async function getAdminList() {
            try {
                const response = await fetch(ADMIN_PATH, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return [];
                
                const data = await response.json();
                if (!Array.isArray(data)) return [];
                
                // 只获取文件名中的邮箱
                return data.filter(item => !item.name.endsWith('.E')).map(item => {
                    const fileName = item.name;
                    const emailMatch = fileName.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/);
                    return emailMatch ? { email: emailMatch[0] } : null;
                }).filter(Boolean);
            } catch (error) {
                console.error('获取管理员列表错误:', error);
                return [];
            }
        }

        // 加载荣誉墙
        async function loadHonors() {
            const honorWall = document.getElementById('honorWall');
            if (!honorWall) return;
            
            // 保留现有内容，仅追加新数据
            const existingIds = new Set();
            honorWall.querySelectorAll('.honor-card').forEach(card => {
                existingIds.add(card.dataset.id);
            });
            
            try {
                const response = await fetch(HONOR_PATH, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                honorWall.innerHTML = '';
                
                if (!Array.isArray(data)) return;
                
                data
                    .filter(item => !item.name.endsWith('.E')) // 屏蔽.E文件
                    .forEach(item => {
                    try {
                        // 从文件名解析数据
                        const fileName = item.name;
                        const dataPart = fileName.split('.')[0];
                        const base64Decoded = atob(dataPart);
                        // 修复编码问题
                        const decodedStr = decodeURIComponent(escape(base64Decoded)); // 确保UTF-8编码正确解析 // 确保UTF-8编码正确解析
                        const honorData = JSON.parse(decodedStr);
                        
                        const honorCard = document.createElement('div');
                        honorCard.className = 'honor-card';
                        honorCard.innerHTML = `
                            <div class="honor-body">
                                <h3 class="honor-title">${honorData.title}</h3>
                                <p class="honor-desc">${honorData.description}</p>
                                <button class="btn btn-primary">
                                    <i class="fas fa-share"></i> 分享荣誉
                                </button>
                                ${(isTeacher || isAdmin) ? `<button class="btn btn-danger delete-honor-btn" data-id="${honorData.id}">
                                    <i class="fas fa-trash"></i>
                                </button>` : ''}
                            </div>
                        `;
                        
                        // 如果有图片，显示图片（与论坛帖子相同的方式）
                        if (item.size > 0) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'image-preview-container';
                            imgContainer.style.maxWidth = '100%';
                            imgContainer.style.overflow = 'hidden';
                            
                            // 确保图片内容正确加载
                            if (item.name.toLowerCase().endsWith('.svg')) {
                                // 对于SVG文件，直接使用fetch获取内容
                                fetch(item.download_url)
                                    .then(response => response.text())
                                    .then(svgContent => {
                                        // 创建div容器来显示SVG
                                        const svgContainer = document.createElement('div');
                                        svgContainer.innerHTML = svgContent;
                                        svgContainer.style.maxWidth = '100%';
                                        svgContainer.style.height = 'auto';
                                        svgContainer.style.cursor = 'pointer';
                                        
                                        // 点击时打开原始URL
                                        svgContainer.addEventListener('click', () => {
                                            window.open(item.download_url, '_blank');
                                        });
                                        
                                        imgContainer.appendChild(svgContainer);
                                    })
                                    .catch(() => {
                                        console.error('SVG加载失败');
                                    });
                            } else {
                                // 处理非SVG图片
                                fetch(item.download_url)
                                    .then(response => response.blob())
                                    .then(blob => {
                                        const reader = new FileReader();
                                        reader.onload = function() {
                                            const img = document.createElement('img');
                                            img.src = reader.result;
                                            img.alt = '荣誉图片';
                                            img.className = 'image-preview';
                                            img.style.maxWidth = '100%';
                                            img.style.height = 'auto';
                                            img.style.cursor = 'pointer';
                                            
                                            // 点击图片时打开原始URL
                                            img.addEventListener('click', () => {
                                                window.open(item.download_url, '_blank');
                                            });
                                            
                                            imgContainer.appendChild(img);
                                        };
                                        reader.readAsDataURL(blob);
                                    })
                                    .catch(() => {
                                        console.error('图片加载失败');
                                    });
                            }
                            
                            honorCard.insertBefore(imgContainer, honorCard.firstChild);
                        }
                        honorWall.insertBefore(honorCard, honorWall.firstChild);
                        
                        if (isTeacher) {
                            honorCard.querySelector('.delete-honor-btn').addEventListener('click', async () => {
                                if (confirm('确定要删除这个荣誉吗？')) {
                                    try {
                                        const response = await fetch(item.url, {
                                            method: 'DELETE',
                                            headers: {
                                                'Authorization': `Bearer ${API_KEY}`,
                                                'Accept': 'application/vnd.github+json',
                                                'X-GitHub-Api-Version': '2022-11-28'
                                            },
                                            body: JSON.stringify({
                                                message: `Delete honor ${item.name}`,
                                                sha: item.sha
                                            })
                                        });
                                        
                                        if (response.ok) {
                                            loadHonors();
                                        } else {
                                            alert('删除荣誉失败');
                                        }
                                    } catch (error) {
                                        console.error('删除荣誉错误:', error);
                                    }
                                }
                            });
                        }
                    } catch (e) {
                        console.error('解析荣誉数据错误:', e, item);
                    }
                });
                
            } catch (error) {
                console.error('加载荣誉墙错误:', error);
            }
        }
        
        // 荣誉图片文件选择处理
        document.getElementById('honorImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 验证文件类型
            const isImage = file.type.startsWith('image/');
            const isSVG = file.name.toLowerCase().endsWith('.svg');
            
            if (!isImage && !isSVG) {
                alert('请选择图片文件（支持格式：jpg, png, gif, svg等）');
                e.target.value = '';
                return;
            }
            
            const fileInfo = document.getElementById('honorFileInfo');
            const fileName = document.getElementById('honorFileName');
            const fileSize = document.getElementById('honorFileSize');
            const fileType = document.getElementById('honorFileType');
            
            // 显示文件信息
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileType.textContent = file.type || '未知类型';
            fileInfo.style.display = 'block';
        });
        
        // 点击上传区域触发文件选择
        document.getElementById('honorUploadArea').addEventListener('click', function() {
            document.getElementById('honorImage').click();
        });
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 添加荣誉
        document.getElementById('addHonorBtn').addEventListener('click', async () => {
            const title = document.getElementById('honorTitle').value;
            const description = document.getElementById('honorDescription').value;
            const imageInput = document.getElementById('honorImage');
            
            if (!title || !description) {
                alert('请填写标题和描述');
                return;
            }
            
            // 从本地存储加载管理员状态
            const storedIsAdmin = localStorage.getItem('isAdmin') === 'true';
            const storedIsTeacher = localStorage.getItem('isTeacher') === 'true';
            
            if (!storedIsTeacher && !storedIsAdmin) {
                alert('只有教师或管理员可以上传荣誉墙内容');
                return;
            }
            
            const honorData = {
                id: Date.now().toString(),
                title: title,
                description: description,
                timestamp: new Date().toISOString()
            };
            
            // 将数据编码为Base64作为文件名
            const dataBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(honorData))));
            const fileName = `${dataBase64}.json.png`;
            
            let fileContent = '';
            if (imageInput.files.length) {
                const file = imageInput.files[0];
                
                if (file.size > 20 * 1024 * 1024) {
                    alert('图片大小不能超过20MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function() {
                    fileContent = reader.result.split(',')[1];
                    uploadHonorFile(fileName, fileContent);
                };
                reader.readAsDataURL(file);
            } else {
                uploadHonorFile(fileName, fileContent);
            }
        });
        
        // 上传荣誉文件
        async function uploadHonorFile(fileName, content) {
            try {
                const response = await fetch(`${HONOR_PATH}${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        message: `Add honor: ${fileName}`,
                        content: content
                    })
                });
                
                if (response.ok) {
                    alert('荣誉添加成功');
                    document.getElementById('honorTitle').value = '';
                    document.getElementById('honorDescription').value = '';
                    document.getElementById('honorImage').value = '';
                    loadHonors();
                } else {
                    const errorData = await response.json();
                    alert(`添加荣誉失败: ${errorData.message || response.status}`);
                }
            } catch (error) {
                console.error('添加荣誉错误:', error);
                alert(`添加荣誉时出错: ${error.message}`);
            }
        }
        
        // 头像上传处理（优化版）
        document.getElementById('avatarUpload')?.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 更严格的图片类型验证
            const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validImageTypes.includes(file.type)) {
                alert('请选择有效的图片格式（JPEG, PNG, GIF, WEBP）');
                e.target.value = ''; // 清空文件选择
                return;
            }
            
            // 预览图片并保存数据
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const avatarUrl = event.target.result;
                    const avatarInitial = document.getElementById('avatarInitial');
                    const avatar = document.getElementById('userAvatar');
                    
                    // 更新本地显示
                    if (avatarInitial) {
                        avatarInitial.remove();
                    }
                    if (avatar) {
                        avatar.style.background = `center/cover no-repeat url(${avatarUrl})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.textContent = '';
                    }
                    
                    // 保存头像数据到 localStorage 和 userAvatars 数组
                    localStorage.setItem('userAvatar', avatarUrl);
                    
                    const userAvatars = JSON.parse(localStorage.getItem('userAvatars')) || [];
                    const userIndex = userAvatars.findIndex(item => item.email === currentUser);
                    
                    if (userIndex !== -1) {
                        userAvatars[userIndex].avatar = avatarUrl;
                    } else {
                        userAvatars.push({
                            email: currentUser,
                            avatar: avatarUrl
                        });
                    }
                    
                    localStorage.setItem('userAvatars', JSON.stringify(userAvatars));
                    
                    // 同步更新用户数据到云端
                    if (currentUser) {
                        await saveUserData(localStorage.getItem('userName') || currentUser);
                    }
                } catch (error) {
                    console.error('头像处理错误:', error);
                }
            };
            reader.onerror = function() {
                console.error('文件读取失败');
            };
            reader.readAsDataURL(file);
        });
            
        document.addEventListener('DOMContentLoaded', () => {
            // 预填充邮箱和姓名
            const savedEmail = localStorage.getItem('userEmail');
            const savedUserName = localStorage.getItem('userName');
            const savedAvatar = localStorage.getItem('userAvatar');
            const emailInput = document.getElementById('email');
            const userNameInput = document.getElementById('userName');
         
            // 加载用户头像
            if (savedAvatar) {
                document.getElementById('avatarInitial').style.display = 'none';
                document.getElementById('userAvatar').style.backgroundImage = `url(${savedAvatar})`;
                document.getElementById('userAvatar').style.backgroundSize = 'cover';
            }
            
            if (savedEmail && emailInput) {
                emailInput.value = savedEmail;
            }
            if (savedUserName && userNameInput) {
                userNameInput.value = savedUserName;
            }
            
            // 初始加载数据
            fetchUserData();
            loadMaterials();
            loadPosts();
            loadChatMessages();
            loadHonors();
            
            // 页面切换时初始化滚动
            if (document.getElementById('chatPage').classList.contains('active')) {
                initChatScroll();
            }
            
            // 设置定时器，每5秒静默刷新局部数据（不刷新整个页面）
            const refreshInterval = setInterval(() => {
                try {
                    fetchUserData();
                    loadChatMessages();
                } catch (error) {
                    console.error('静默刷新失败:', error);
                }
            }, 5000);
            
            // 绑定上传按钮事件
            document.getElementById('uploadMaterialBtn')?.addEventListener('click', async () => {
                const fileInput = document.getElementById('materialFileInput');
                
                if (!fileInput || !currentUser) return;
                
                // 从本地存储加载管理员状态
                const storedIsAdmin = localStorage.getItem('isAdmin') === 'true';
                const storedIsTeacher = localStorage.getItem('isTeacher') === 'true';
                
                if (!storedIsTeacher && !storedIsAdmin) {
                    alert('只有教师或管理员可以上传学习资料');
                    return;
                }
                
                const files = fileInput.files;
                
                if (files.length === 0) {
                    alert('请选择文件');
                    return;
                }
                
                const file = files[0];
                if (file.size > 20 * 1024 * 1024) {
                    alert('文件大小不能超过20MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async function() {
                    const content = reader.result.split(',')[1];
                    const fileName = file.name;
                    const filePath = `${MATERIALS_PATH}${encodeURIComponent(currentUser)}/${encodeURIComponent(fileName)}`;
                    
                    try {
                        const response = await fetch(filePath, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${API_KEY}`,
                                'Accept': 'application/json; charset=utf-8',
                                'Content-Type': 'application/json; charset=utf-8'
                            },
                            body: JSON.stringify({
                                message: `Upload material: ${fileName}`,
                                content: content
                            })
                        });
                        
                        if (response.ok) {
                            alert('文件上传成功');
                            fileInput.value = '';
                            loadMaterials();
                        } else {
                            alert('文件上传失败');
                        }
                    } catch (error) {
                        console.error('上传文件错误:', error);
                        alert('上传文件时出错');
                    }
                };
                reader.readAsDataURL(file);
            });
            
            // 点击上传区域触发文件选择
            document.querySelector('.upload-area')?.addEventListener('click', () => {
                document.getElementById('materialFileInput').click();
            });
        });
        </Script>
        <script>

class WebSocketExtension {
  constructor() {
    this.instances = {};
  }

  /**
   * window.onWebSocketMessage=当接收到消息时调用的函数
   * @param {string} url
   * @param {string} [instanceId="default"]
   * @returns {Promise<void>}
   */
  connect(url, instanceId = "default") {
    return new Promise((resolve, reject) => {
      if (!/^(ws|wss):/i.test(url)) {
        if (/^(?!(ws|http)s?:\/\/).*$/i.test(url)) {
          url = `wss://${url}`;
        } else if (/^(http|https):/i.test(url)) {
          const urlParts = url.split(":");
          urlParts[0] = url.toLowerCase().startsWith("https") ? "wss" : "ws";
          url = urlParts.join(":");
        } else {
          reject(new Error("Invalid URL format"));
          return;
        }
      }

      const oldInstance = this.instances[instanceId];
      if (oldInstance) {
        oldInstance.destroyed = true;
        if (oldInstance.websocket) {
          oldInstance.websocket.close();
        }
      }

      const instance = {
        destroyed: false,
        errored: false,
        closeMessage: "",
        closeCode: 0,
        data: "",
        websocket: null,
        messageQueue: [],
        listeners: {
          open: [],
          message: [],
          error: [],
          close: []
        }
      };
      this.instances[instanceId] = instance;

      try {
        const websocket = new WebSocket(url);
        instance.websocket = websocket;

        websocket.onopen = (e) => {
          if (instance.destroyed) {
            websocket.close();
            return;
          }
          instance.listeners.open.forEach(callback => callback(e));
          // Send handshake message
          websocket.send(JSON.stringify({
            method: "handshake",
            project_id: "websocket example",
            user: "player1234"
          }));
          resolve();
        };

        websocket.onclose = (e) => {
          if (!instance.errored) {
            instance.closeMessage = e.reason || "";
            instance.closeCode = e.code;
            instance.listeners.close.forEach(callback => callback(e));
          }
        };

        websocket.onerror = (e) => {
          console.error("WebSocket error", e);
          instance.errored = true;
          instance.listeners.error.forEach(callback => callback(e));
        };

        websocket.onmessage = (e) => {
          if (instance.destroyed) return;
          let data = e.data;
          if (data instanceof Blob) {
            const fr = new FileReader();
            fr.onload = () => {
              instance.data = fr.result;
              instance.listeners.message.forEach(callback => callback(fr.result));
              // Call user-defined function with the received data
              if (typeof window.onWebSocketMessage === 'function') {
                try {
                  const parsedData = JSON.parse(fr.result);
                  // 处理特殊格式的消息
                  if (parsedData.method === "set" && parsedData.name === "variable") {
                    const valueStr = parsedData.value.replace(/\//g, ':');
                    const valueData = JSON.parse(valueStr);
                    window.onWebSocketMessage(valueData);
                  } else {
                    window.onWebSocketMessage(parsedData);
                  }
                } catch (error) {
                  console.error('解析 WebSocket 消息时出错:', error);
                }
              }
            };
            fr.readAsDataURL(data);
          } else {
            instance.data = data;
            instance.listeners.message.forEach(callback => callback(data));
            // Call user-defined function with the received data
            if (typeof window.onWebSocketMessage === 'function') {
              try {
                const parsedData = JSON.parse(data);
                // 处理特殊格式的消息
                if (parsedData.method === "set" && parsedData.name === "variable") {
                  const valueStr = parsedData.value.replace(/\//g, ':');
                  const valueData = JSON.parse(valueStr);
                  window.onWebSocketMessage(valueData);
                } else {
                  window.onWebSocketMessage(parsedData);
                }
              } catch (error) {
                console.error('解析 WebSocket 消息时出错:', error);
              }
            }
          }
        };
      } catch (error) {
        console.error("Failed to open WebSocket connection", error);
        instance.errored = true;
        instance.listeners.error.forEach(callback => callback(error));
        reject(error);
      }
    });
  }

  /**
   * Sends a message through the WebSocket.
   * @param {string} message - The message to send.
   * @param {string} [instanceId="default"] - Optional instance ID.
   */
  send(message, instanceId = "default") {
    const instance = this.instances[instanceId];
    if (!instance || !instance.websocket) return;
    if (instance.websocket.readyState === WebSocket.CONNECTING) {
      setTimeout(() => this.send(message, instanceId), 100);
    } else if (instance.websocket.readyState === WebSocket.OPEN) {
      // Replace colons with underscores in the message
      const sanitizedMessage = message.replace(/:/g, "/");
      // Wrap the message in the specified JSON structure
      const wrappedMessage = JSON.stringify({
        method: "set",
        name: "variable",
        value: sanitizedMessage
      });
      instance.websocket.send(wrappedMessage);
    }
  };
}
  /**
   * Sends a chat message through the WebSocket.
   * @param {object} messageData - The message data to send.
   */
class WebSocketManager {
  constructor() {
    this.instances = {};
  }

  /**
   * Connects to a WebSocket server.
   * @param {string} url - WebSocket server URL.
   * @param {string} [instanceId="default"] - Optional instance ID.
   */
  async connect(url, instanceId = "default") {
    if (this.instances[instanceId] && this.instances[instanceId].websocket) {
      return;
    }

    this.instances[instanceId] = {
      websocket: new WebSocket(url),
      destroyed: false
    };

    const socket = this.instances[instanceId].websocket;

    socket.onopen = () => {
      console.log('WebSocket connected');
    };

    socket.onclose = (event) => {
      if (!this.instances[instanceId].destroyed) {
        console.log('WebSocket disconnected, attempting to reconnect...');
        setTimeout(() => this.connect(url, instanceId), 3000);
      }
    };

    socket.onerror = (error) => {
      console.error('WebSocket error:', error);
    };
  }

  /**
   * Sends a chat message through the WebSocket.
   * @param {object} messageData - The message data to send.
   */
  async sendMessageToWebSocket(messageData) {
    try {
      if (!this.instances.default || !this.instances.default.websocket) {
        console.error('WebSocket instance not initialized');
        await this.connect('wss://clouddata.turbowarp.org/');
        if (!this.instances.default || !this.instances.default.websocket) {
          console.error('Failed to initialize WebSocket');
          return;
        }
      }
      const socket = this.instances.default.websocket;
      if (socket.readyState === WebSocket.OPEN) {
        const processedData = JSON.stringify(messageData).replace(/:/g, '/');
        const message = JSON.stringify({
          method: 'set',
          name: 'variable',
          value: processedData
        });
        // 上传到服务器
        this.send(message);
        socket.send(message);
      } else {
        console.error('WebSocket is not connected');
      }
    } catch (error) {
      console.error('Failed to send message:', error);
    }
  }

  /**
   * Closes the WebSocket connection.
   * @param {number} [code=1000] - Close code.
   * @param {string} [reason=""] - Close reason.
   * @param {string} [instanceId="default"] - Optional instance ID.
   */
  close(code = 1000, reason = "", instanceId = "default") {
    const instance = this.instances[instanceId];
    if (!instance || !instance.websocket) return;
    instance.destroyed = true;
    instance.websocket.close(code, reason);
  }

  /**
   * Adds an event listener.
   * @param {string} event - Event type ("open", "message", "error", "close").
   * @param {Function} callback - Callback function.
   * @param {string} [instanceId="default"] - Optional instance ID.
   */
  on(event, callback, instanceId = "default") {
    const instance = this.instances[instanceId];
    if (!instance) return;
    if (instance.listeners[event]) {
      instance.listeners[event].push(callback);
    }
  }

  /**
   * Removes an event listener.
   * @param {string} event - Event type ("open", "message", "error", "close").
   * @param {Function} callback - Callback function.
   * @param {string} [instanceId="default"] - Optional instance ID.
   */
  off(event, callback, instanceId = "default") {
    const instance = this.instances[instanceId];
    if (!instance) return;
    if (instance.listeners[event]) {
      instance.listeners[event] = instance.listeners[event].filter(
        cb => cb !== callback
      );
    }
  }
}
    

    // Export for use in HTML
    const webSocketExtension = new WebSocketExtension();
    window.WebSocketExtension = webSocketExtension;

    // Connect to the WebSocket server automatically
    webSocketExtension.connect("wss://clouddata.turbowarp.org/");
    </script>
</body>
</html>
