<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>23级护理四班交流论坛</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://operate-js.github.io/root/ws.js"></script>
    <style>
    .author-avatar, .avatar-img {
        border-radius: 50%;
        overflow: hidden;
        width: 40px;
        height: 40px;
        background-image: url('https://operate-js.github.io/text/logo.svg');
        background-size: cover;
        background-position: center;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255,255,255,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .loading-spinner {
        background-color: #fff;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        font-size: 16px;
        color: #4e73df;
    }
    
    .loading-spinner i {
        margin-right: 10px;
    }
        :root {
            --primary: #4e73df;
            --secondary: #858796;
            --success: #1cc88a;
            --info: #36b9cc;
            --warning: #f6c23e;
            --danger: #e74a3b;
            --light: #f8f9fc;
            --dark: #5a5c69;
            --admin: #e74a3b;
            --teacher: #4e73df;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        html {
            font-size: 16px;
        }

        body {
            background-color: #f8f9fc;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 头部导航样式 */
        header {
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            color: white;
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 10px;
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }
        
        .message-btn {
            position: relative;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: white;
        }

        .unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .admin-avatar {
            background-color: var(--admin);
        }

        .teacher-avatar {
            background-color: var(--teacher);
        }

        /* 导航栏样式 */
        .sidebar {
            width: 250px;
            background-color: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            padding: 20px 0;
            position: sticky;
            top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        

        .nav-item {
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s;
        }

        .nav-item i {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .nav-item:hover {
            background-color: #f0f3ff;
        }

        .nav-item.active {
            background-color: #4e73df;
            color: white;
        }

        /* 主内容区样式 */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 60px);
        }

        .page-content {
            display: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }

        .page-content.active {
            display: block;
        }



        .page-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f3ff;
            color: var(--dark);
        }

        /* 学习资料卡片样式 */
        .material-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            overflow: hidden;
            transition: transform 0.3s;
        }

        .material-card:hover {
            transform: translateY(-5px);
        }

        .material-header {
            background: linear-gradient(to right, #4e73df, #224abe);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .teacher-badge {
            background-color: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .material-body {
            padding: 20px;
        }

        .file-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .file-list li:last-child {
            border-bottom: none;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        /* 帖子列表样式 */
        .post-item {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 20px;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .post-author {
            display: flex;
            align-items: center;
        }

        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--info);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .author-name {
            font-weight: 600;
        }

        .post-time {
            font-size: 0.85rem;
            color: var(--secondary);
        }

        .post-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .post-content {
            line-height: 1.7;
        }

        /* 评论功能样式 */
        .comment-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .comment-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .comment-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 80px;
        }

        .comment-submit {
            align-self: flex-end;
        }

        .comment-list {
            margin-top: 15px;
        }

        .comment-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: none;
        }
        
        .comment-item:first-child,
        .comment-item.show {
            display: block;
        }
        
        .expand-comments {
            color: var(--primary);
            cursor: pointer;
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            background: none;
            border: none;
        }
        
        .expand-comments:hover {
            text-decoration: underline;
        }

        .comment-author {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .comment-time {
            font-size: 0.8rem;
            color: var(--secondary);
        }

        .comment-content {
            margin-bottom: 10px;
        }

        .reply-btn {
            padding: 5px 10px;
            font-size: 0.9rem;
        }
        
        .reply-arrow {
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 15px;
            height: 2px;
            background-color: #999;
            border-left: 2px solid #999;
            transition: all 0.3s ease;
            z-index: 1;
        }

        /* 评论功能样式 */
        .comment-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .comment-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .comment-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 80px;
        }

        .comment-submit {
            align-self: flex-end;
        }

        .comment-list {
            margin-top: 15px;
        }

        .comment-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: none;
        }
        
        .comment-item:first-child,
        .comment-item.show {
            display: block;
        }
        
        .expand-comments {
            color: var(--primary);
            cursor: pointer;
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            background: none;
            border: none;
        }
        
        .expand-comments:hover {
            text-decoration: underline;
        }

        .comment-author {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .comment-time {
            font-size: 0.8rem;
            color: var(--secondary);
        }

        .comment-content {
            margin-bottom: 10px;
        }

        .reply-btn {
            padding: 5px 10px;
            font-size: 0.9rem;
        }
        
        .reply-arrow {
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 15px;
            height: 2px;
            background-color: #999;
            border-left: 2px solid #999;
            transition: all 0.3s ease;
            z-index: 1;
        }

        /* 聊天区域样式 */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9ff;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            margin-bottom: 20px;
            max-width: 80%;
            display: flex;
            flex-direction: column;
        }

        .current-user-message {
            align-self: flex-end;
        }

        .message-header {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 5px;
        }
        
        .message-header .post-author {
            display: flex;
            align-items: center;
        }
        
        .message-header .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
        }

        .message-sender {
            font-weight: 600;
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--secondary);
        }

        .message-content {
            background: #e9ecef;
            padding: 12px 15px;
            border-radius: 18px;
            display: inline-block;
        }

        .current-user-message .message-content {
            background: #4e73df;
            color: white;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 30px;
            margin-right: 10px;
            font-size: 1rem;
        }

        /* 荣誉墙样式 */
        .honor-wall {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .honor-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .honor-img-container {
            height: 200px;
            overflow: hidden;
            position: relative;
        }

        
        /* 移动端优化 */
        @media (max-width: 768px) {
            html {
                font-size: 14px;
            }
            
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
            }
            
            .main-content {
                padding: 12px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            
            /* 标题统一调整 */
            .page-title {
                font-size: 1.5rem;
            }
            
            .material-header {
                font-size: 1rem;
            }
            
            .nav-item {
                font-size: 0.9rem;
            }
            
            /* 帖子内容调整 */
            .post-item {
                padding: 15px;
            }
            
            .post-title {
                font-size: 1rem;
                margin-bottom: 8px;
            }
            
            .post-content {
                font-size: 0.9rem;
                line-height: 1.6;
            }
            
            /* 头像调整 */
            .author-avatar, .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }
            
            .comment-input {
                min-height: 70px;
                font-size: 0.85rem;
                padding: 8px;
            }
            
            .comment-submit {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            .reply-btn {
                padding: 4px 8px;
                font-size: 0.8rem;
            }
            
        }
            .comment-content {

            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-color: #f0f3ff;
            transition: transform 0.3s;
        }

        .honor-img:hover {
            transform: scale(1.05);
        }

        .honor-body {
            padding: 20px;
        }

        .honor-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .honor-desc {
            margin-bottom: 15px;
            color: var(--secondary);
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background-color: #f8fbff;
        }

        /* 模态框样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.2);
            transform: translateY(-20px);
            transition: transform 0.4s;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--dark);
        }

        .close-modal {
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--secondary);
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--dark);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            text-align: right;
        }

                

        /* 响应式设计 */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
            }
            
            .main-content {
                max-height: none;
            }
            
            .chat-container {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .honor-wall {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
            }
        }
    .skeleton-card {
    background: #fff;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}
.skeleton-img {
    height: 150px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 4px;
}
.skeleton-text {
    height: 12px;
    background: #f0f0f0;
    margin: 10px 0;
    border-radius: 4px;
}
.skeleton-list {
    margin-top: 15px;
}
.skeleton-item {
    height: 50px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    margin-bottom: 10px;
    border-radius: 4px;
}
.error-message {
    color: #e74a3b;
    padding: 15px;
    text-align: center;
}
@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
</style>
</head>
<body>
    <!-- 添加隐藏的通知容器 -->
    <div class="hidden-notifications-container" style="display: none;"></div>
    <!-- 头部导航 -->
    <header>
        <div class="logo">
            <img src="https://operate-js.github.io/text/logo.svg" alt="logo" style="width: 24px; height: 24px;">
            <span>23级护理四班交流论坛</span>
        </div>
        <div class="user-controls">
            <button id="loginBtn" class="btn btn-primary">登录</button>
            <button class="message-btn" onclick="messagebtn()">
                <i class="fas fa-envelope"></i>
                <div class="unread-badge"></div>
            </button>
            <div id="userAvatar" class="user-avatar" style="display: none; position: relative; cursor: pointer; overflow: hidden;">
    <span id="avatarInitial">U</span>
    <input type="file" id="avatarUpload" accept="image/*" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; font-size: 0; z-index: 1000;">
</div>

<script>

    // 从 GitHub API 下载用户数据并处理（仿造论坛数据下载功能）
    async function fetchUserData() {
        let retryCount = 0;
        const maxRetries = 3;
        
        while (retryCount < maxRetries) {
            try {
                // 检查API_KEY是否有效
                if (!API_KEY || API_KEY.trim() === '') {
                    throw new Error('GitHub API密钥未配置，请设置有效的API_KEY');
                }
                
                const response = await fetch(USER_DATA_PATH, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json',
                        'X-GitHub-Api-Version': '2022-11-28'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`获取用户数据失败: ${response.status} ${response.statusText}`);
                }
                
                // 验证响应内容类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`无效的响应类型: ${contentType}`);
                }
                
                // 读取响应文本以便调试
                const responseText = await response.text();
                if (!responseText) {
                    throw new Error('空响应内容');
                }
                
                // 尝试解析JSON
                const files = JSON.parse(responseText);
                const sha = response.headers.get('X-GitHub-SHA');
                
                // 处理403 Forbidden错误
                if (response.status === 403) {
                    const rateLimitRemaining = response.headers.get('X-RateLimit-Remaining');
                    const rateLimitReset = response.headers.get('X-RateLimit-Reset');
                    
                    if (rateLimitRemaining === '0') {
                        const resetTime = new Date(parseInt(rateLimitReset) * 1000);
                        throw new Error(`API请求次数已达上限，请在 ${resetTime.toLocaleTimeString()} 后重试`);
                    }
                    throw new Error('无权访问该资源，请检查API密钥权限');
                }
                
                // 验证数据格式
                if (!Array.isArray(files)) {
                    // 尝试处理可能的非数组响应
                    if (files && typeof files === 'object') {
                        files = [files]; // 转换为数组
                    } else {
                        throw new Error(`响应数据格式无效: ${typeof files}`);
                    }
                }
                
                for (const file of files) {
                    if (file.name.endsWith('.json')) {
                        const userResponse = await fetch(file.download_url, {
                            headers: {
                                'Authorization': `Bearer ${API_KEY}`,
                                'Accept': 'application/vnd.github+json'
                            }
                        });
                        
                        const userDataText = await userResponse.text();
                        const userData = JSON.parse(userDataText);

                        // 检查是否已存在相同的 email 或 avatar
                        const isDuplicate = userAvatars.some(item => 
                            item.email === userData.email || item.avatar === userData.avatar
                        );
                        
                        // 如果不重复，则添加到数组
                        if (!isDuplicate) {
                            userAvatars.push({
                                avatar: userData.avatar,
                                email: userData.email,
                                sha: sha || file.sha
                            });
                        }
                    }
                }
                
                // 保存到 localStorage，与论坛数据下载功能一致
                localStorage.setItem('userAvatars', JSON.stringify(userAvatars));
                localStorage.setItem('userDataSha', sha || '');
                console.log('用户头像数据已保存到 localStorage:', userAvatars);
                
                // 成功则退出重试循环
                return;
                
            } catch (error) {
                console.error(`下载或处理用户数据时出错(尝试 ${retryCount + 1}/${maxRetries}):`, error);
                
                if (retryCount === maxRetries - 1) {
                    // 最后一次尝试失败
                    if (error.message.includes('API请求次数已达上限')) {
                        // 显示更友好的限流提示
                        showErrorToast(error.message);
                    }
                    throw error;
                }
                
                // 根据错误类型设置不同的重试间隔
                const retryDelay = error.message.includes('API请求次数已达上限') 
                    ? 60000 // 限流时等待1分钟
                    : 3000 * (retryCount + 1); // 其他错误使用指数退避
                retryCount++;
            }
        }
    }

    // 调用函数
    fetchUserData();
    function initAvatarUpload() {
        const avatar = document.getElementById('userAvatar');
        const uploadInput = document.getElementById('avatarUpload');
        const avatarInitial = document.getElementById('avatarInitial');
        
        if (!avatar || !uploadInput) return;
        
        // 确保文件输入框在DOM中
        if (!document.body.contains(uploadInput)) {
            avatar.appendChild(uploadInput);
        }
        
        avatar.onclick = function() {
            console.log('触发文件选择');
            uploadInput.click();
        };
        
        console.log('验证上传输入框是否存在:', !!uploadInput);
            // 移除可能存在的重复事件监听器
            uploadInput.removeEventListener('change', arguments.callee);
            // 确保事件只绑定一次并完全阻止默认行为
            if (window.__fileUploadListenerBound) return;
            window.__fileUploadListenerBound = true;
            uploadInput.addEventListener('change', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('文件选择事件触发，已阻止默认行为和事件冒泡');

            const file = e.target.files[0];
            if (!file) return;
            
            // 预览图片
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const avatarInitial = document.getElementById('avatarInitial');
                    const avatar = document.getElementById('userAvatar');
                    
                    // 更新头像显示
                    if (avatarInitial && avatarInitial.parentNode) {
                        avatarInitial.remove(); // 完全移除DOM元素
                    }
                    if (avatar) {
                        avatar.style.background = `center/cover no-repeat url(${event.target.result})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.textContent = ''; // 确保没有残留文本
                    }
                } catch (e) {
                    console.error('图片处理错误:', e);
                }
            };
            reader.onerror = function() {
                console.error('文件读取失败');
            };
            reader.readAsDataURL(file);
        });
    }
    
    // 上传到云端的函数
    function uploadToCloud(file) {
        if (!file) {
            console.warn('没有可上传的文件');
            return;
        }
    }

    // 确保在DOM加载完成后初始化
    if (document.readyState === 'complete') {
        initAvatarUpload();
    } else {
        window.addEventListener('DOMContentLoaded', initAvatarUpload);
    }
</script>
        </div>
    </header>

    <div class="container">
        <!-- 侧边导航栏 -->
        <div class="sidebar">
            <div class="nav-item active" data-page="home" onclick="loadMaterials()">
                <i class="fas fa-home"></i>
                <span>首页</span>
            </div>
            <div class="nav-item" data-page="forum" onclick="loadPosts().then(updateUnreadCount);">
                <i class="fas fa-comments"></i>
                <span>班级论坛</span>
            </div>
            <div class="nav-item" data-page="chat">
                <i class="fas fa-comment-dots"></i>
                <span>实时聊天</span>
            </div>
            <div class="nav-item" data-page="honor" onclick="loadHonorWall()">
                <i class="fas fa-trophy"></i>
                <span>荣誉墙</span>
            </div>
            
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 首页 -->
            <div id="homePage" class="page-content active">
                <div id="homeLoading" class="loading-overlay" style="display:none;">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
                <h2 class="page-title">班级公告</h2>
                <div id="announcementLoading" class="loading-overlay" style="display: none;">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
                <div id="announcementContainer" class="announcement">
                    <p>欢迎来到23级护理四班交流论坛！</p>
                    <p>这里是班级信息发布、学习资源共享和同学交流的平台。</p>
                </div>
                <div id="announcementError" class="error-message" style="display:none;"></div>
                
                <h2 class="page-title">学习资料</h2>
                <div id="materialsContainer">
                    <div class="skeleton-list" style="display:none;">
                        <div class="skeleton-item"></div>
                        <div class="skeleton-item"></div>
                        <div class="skeleton-item"></div>
                    </div>
                </div>
                <div id="materialError" class="error-message" style="display:none;"></div>
                <div id="materialLoading" style="display: none;"></div>
                <div id="materialUploadSection" style="display: none; margin-top: 20px;">
                    <h3>上传学习资料</h3>
                    <div class="form-group">
                        <label class="form-label">上传文件</label>
                        <div class="upload-area">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: #ccc; margin-bottom: 10px;"></i>
                            <p>点击或拖拽文件到此处上传</p>
                            <input type="file" id="materialFileInput" style="display: none;">
                        </div>
                    </div>
                    <button id="uploadMaterialBtn" class="btn btn-primary">上传</button>
                </div>
            </div>

            <!-- 班级论坛 -->
            <div id="forumPage" class="page-content">
                <div id="forumLoading" class="loading-overlay" style="display:none;">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
                <h2 class="page-title">班级论坛</h2>
                <div class="form-group">
                    <input type="text" id="postTitle" class="form-control" placeholder="帖子标题">
                </div>
                <div class="form-group">
                    <textarea id="postContent" class="form-control" placeholder="帖子内容"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">上传图片（可选）</label>
                    <input type="file" id="postImage" accept="image/*">
                </div>
                <button id="postSubmitBtn" class="btn btn-primary">发布帖子</button>
                
                <div class="posts-container" style="margin-top: 30px;">
                    <h3>最新帖子</h3>
                    <ul id="postList" class="post-list">
                        
                    </ul>
                </div>
            </div>

            <!-- 实时聊天 -->
            <div id="chatPage" class="page-content">
                <h2 class="page-title">班级聊天室</h2>
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages">
                        <!-- 聊天消息动态加载 -->
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="输入消息...">
                        <button id="sendMessageBtn" class="btn btn-primary">发送</button>
                    </div>
                </div>
            </div>

            <!-- 荣誉墙 -->
            <div id="honorPage" class="page-content">
            

                <div id="honorLoading" class="loading-overlay" style="display:none;">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
                <h2 class="page-title">班级荣誉墙</h2>
                <div id="honorWall" class="honor-wall">
                    <div class="skeleton-card" style="display:none;">
                        <div class="skeleton-img"></div>
                        <div class="skeleton-text"></div>
                        <div class="skeleton-text"></div>
                    </div>
                </div>
                <div id="honorError" class="error-message" style="display:none;"></div>
                <div id="honorLoading" style="display: none;"></div>
                
                <div id="honorEditSection" style="margin-top: 40px; display: none;">
                    <h3>添加荣誉</h3>
                    <div class="form-group">
                        <input type="text" id="honorTitle" class="form-control" placeholder="荣誉标题">
                    </div>
                    <div class="form-group">
                        <textarea id="honorDescription" class="form-control" placeholder="荣誉描述"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">荣誉图片</label>
                        <div class="upload-area" id="honorUploadArea">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: #ccc; margin-bottom: 10px;"></i>
                            <p>点击或拖拽文件到此处上传</p>
                            <input type="file" id="honorImage" accept="image/*,.svg" style="display: none;">
                            <div id="honorFileInfo" style="margin-top: 10px; display: none;">
                                <p>文件名: <span id="honorFileName"></span></p>
                                <p>文件大小: <span id="honorFileSize"></span></p>
                                <p>文件类型: <span id="honorFileType"></span></p>
                            </div>
                        </div>
                    </div>
                    <button id="addHonorBtn" class="btn btn-primary">添加荣誉</button>
                </div>
            </div>


            </div>

    <!-- 登录模态框 -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">用户登录</h3>
                <span class="close-modal" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">邮箱地址</label>
                    <input type="email" id="email" class="form-control" placeholder="请输入邮箱">
                </div>
                <div class="form-group">
                    <label class="form-label">姓名</label>
                    <input type="text" id="userName" class="form-control" placeholder="请输入您的真实姓名">
                </div>
                <div class="form-group">
                    <label class="form-label">验证码</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="code" class="form-control" placeholder="请输入验证码">
                        <button id="getCodeBtn" class="btn btn-primary">获取验证码</button>
                    </div>
                </div>
                <div id="loginStatus" style="margin-top: 15px; color: var(--danger);"></div>
            </div>
            <div class="modal-footer">
                <button id="submitLogin" class="btn btn-primary">登录</button>
            </div>
        </div>
    </div>

    <script>
    // 初始化 userAvatars 数组，从 localStorage 加载数据
    localStorage.setItem('userAvatars', JSON.stringify([]));
    let userAvatars = JSON.parse(localStorage.getItem('userAvatars')) || [];

    // 从 GitHub API 下载用户数据并处理
    async function fetchUserData() {
        try {
            // 检查GitHub访问令牌是否有效
            if (!API_KEY || API_KEY.trim() === '') {
                throw new Error('GitHub访问令牌未配置，请设置有效的API_KEY');
            }
            
            const response = await fetch(USER_DATA_PATH, {
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Accept': 'application/vnd.github+json'
                }
            });
            
            // 检查API响应状态
            if (!response.ok) {
                throw new Error(`GitHub API请求失败: ${response.status} ${response.statusText}`);
            }
            
            const files = await response.json();

            for (const file of files) {
                if (file.name.endsWith('.json')) {
                    const userResponse = await fetch(file.download_url);
                    const userData = await userResponse.json();

                    // 检查是否已存在相同的 email 或 avatar
                    const isDuplicate = userAvatars.some(item => 
                        item.email === userData.email || item.avatar === userData.avatar
                    );
                    
                    // 如果不重复，则添加到数组
                    if (!isDuplicate) {
                        userAvatars.push({
                            avatar: userData.avatar,
                            email: userData.email
                        });
                    }
                }
            }
            // 保存到 localStorage
            localStorage.setItem('userAvatars', JSON.stringify(userAvatars));
        } catch (error) {
            console.error('下载或处理用户数据时出错:', error);
        }
    }

    // 荣誉墙加载函数
    async function loadHonorWall() {
        const honorWall = document.getElementById('honorWall');
        if (!honorWall) return;
        
        try {
            honorWall.innerHTML = '<div class="loading">正在加载荣誉墙...</div>';
            
            await fetchUserData();
            await loadHonors(); // 使用统一的荣誉加载函数
        } catch (error) {
            console.error('荣誉墙加载失败:', error);
            honorWall.innerHTML = '<div class="error">荣誉墙加载失败</div>';
        }
    }
        // 全局错误处理
        window.addEventListener('error', function(event) {
            console.error('全局错误:', event.error);
            
            // 显示网络错误提示
            const errorContainer = document.createElement('div');
            errorContainer.style.position = 'fixed';
            errorContainer.style.bottom = '20px';
            errorContainer.style.right = '20px';
            errorContainer.style.padding = '15px';
            errorContainer.style.backgroundColor = '#ff4444';
            errorContainer.style.color = 'white';
            errorContainer.style.borderRadius = '5px';
            errorContainer.style.zIndex = '9999';
            errorContainer.innerHTML = '网络连接异常，请检查网络设置后刷新页面';
            
            document.body.appendChild(errorContainer);
            
            // 5秒后自动消失
            setTimeout(() => {
                errorContainer.remove();
            }, 5000);
        });

        // 全局变量
        const USER_DATA_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Forum/User%20Data/";
        const CHAT_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Chat/Chat%20room/";
        const POST_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Chat/Post/";
        const TEACHER_PATH = "https://api.github.com/repos/operate-js/text-3/contents/root/Teacher%20List/";
        const ADMIN_PATH = "https://api.github.com/repos/operate-js/text-3/contents/administrator/";
        const HONOR_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Wall%20of%20Fame/";
        const MATERIALS_PATH = "https://api.github.com/repos/operate-js/text-3/contents/Learning%20materials/";
        const EMAIL_API = "https://api.github.com/repos/operate-js/Emailregistration/dispatches";
        const MSG_PATH = "https://api.github.com/repos/operate-js/text-3/contents/message";
        

        // 初始化全部用户头像存储
        if (!localStorage.getItem('userAvatars')) {
            localStorage.setItem('userAvatars', JSON.stringify([]));
        }
        
        // 添加手动加载按钮事件
        document.getElementById('loadMaterialsBtn')?.addEventListener('click', loadMaterials);
        document.getElementById('loadForumBtn')?.addEventListener('click', loadPosts);
        document.getElementById('loadHonorBtn')?.addEventListener('click', loadHonorWall);
        
        // 解密5次的密钥
        const decryptBase64 = (str, times) => {
            for (let i = 0; i < times; i++) {
                str = atob(str);
            }
            return str;
        };
        
        const API_KEY = decryptBase64("VmpKd1MyTXdNVWhTYTJ4WFlsZDRXbFJVUWt0aU1YQkdWMVJTYkZKVVJsZFZNblJUVldzeFIyTkdhRlZXUlVwNVdrUktWMUpYU2tkaFJuQnBVak5vTVZkc1pEUlNNRFZIVjJ0V1UySkhhRnBVVlZKelpHeHNXV05IT1ZaU01GcDVXbFZTVDFaWFNsZFRWRUpYVWpOb2VsWnJWVEZXTVZaeVpFZHdUbUpGY0hwV1YzUnJWREF3ZVZWdVVsTmhiRnBSVld0a2IxVkdXa2RWYXpsVFZtdHNNMXBJY0ZkaFJscDBXa1JPVm1GclduSlpiWGhhWld4T1ZWRnNTbGRXVm5CS1ZteFdWMk14V1hoVVdHUlRZa1p3VkZsc1pGTmxiR3QzVm01a1QxcDZNRGs9", 5);

        
        
        
        let currentUser = null;
        let isAdmin = false;
        let isTeacher = false;
        
        // DOM元素
        const loginBtn = document.getElementById('loginBtn');
        const userAvatar = document.getElementById('userAvatar');
        const loginModal = document.getElementById('loginModal');
        const closeModal = document.getElementById('closeModal');
        const getCodeBtn = document.getElementById('getCodeBtn');
        const submitLogin = document.getElementById('submitLogin');
        const loginStatus = document.getElementById('loginStatus');
        const navItems = document.querySelectorAll('.nav-item');
        const pageContents = document.querySelectorAll('.page-content');
        
        // 页面导航
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                try {
                    // 安全处理导航项样式
                    navItems.forEach(i => {
                        if (i && i.classList) {
                            i.classList.remove('active');
                        }
                    });
                    
                    if (this && this.classList) {
                        this.classList.add('active');
                    }
                    
                    // 安全切换页面内容
                    const pageId = this.dataset.page + 'Page';
                    const targetPage = document.getElementById(pageId);
                    
                    if (pageContents && pageContents.length > 0) {
                        pageContents.forEach(page => {
                            if (page && page.classList) {
                                page.classList.remove('active');
                            }
                        });
                    }
                    
                    if (targetPage && targetPage.classList) {
                        targetPage.classList.add('active');
                    }
                    
                    // 清除残留样式并显示加载提示
                    document.querySelectorAll('.loading-overlay').forEach(el => {
                        if (el && el.style) {
                            el.style.display = 'none';
                        }
                    });
                    
                    const loadingElement = document.getElementById(`${this.dataset.page}Loading`);
                    if (loadingElement && loadingElement.style) {
                        loadingElement.style.display = 'flex';
                    }
                    
                    // 清除页面缓存数据
                    switch(this.dataset.page) {
                        case 'home':
                            const materialsContainer = document.querySelector('#materialsContainer');
                            if (materialsContainer) {
                                materialsContainer.innerHTML = '';
                            }
                            break;
                        case 'forum':
                            const postList = document.querySelector('#postList');
                            if (postList) {
                                postList.innerHTML = '';
                            }
                            break;
                        case 'honor':
                            const honorWall = document.querySelector('#honorWall');
                            if (honorWall) {
                                honorWall.innerHTML = '';
                            }
                            break;
                    }
                    
                    switch(pageId) {
                        case 'homePage':
                            loadMaterials().finally(() => {
                                if (loadingElement && loadingElement.style) {
                                    loadingElement.style.display = 'none';
                                }
                            });
                            break;
                        case 'forumPage':
                            loadPosts().finally(() => {
                                if (loadingElement && loadingElement.style) {
                                    loadingElement.style.display = 'none';
                                }
                            });
                            break;
                        case 'chatPage':
                            loadChatMessages().then(() => {
                                // 确保聊天区加载完成后再滚动
                                scrollChatToBottom();
                            });
                            break;
                        case 'honorPage':
                            loadHonorWall().finally(() => {
                                if (loadingElement && loadingElement.style) {
                                    loadingElement.style.display = 'none';
                                }
                            });
                            break;
                    }
                } catch (error) {
                    console.error('页面导航出错:', error);
                }
            });
        });
        
        // 登录模态框控制
        loginBtn.addEventListener('click', () => {
            loginModal.classList.add('active');
            
            // 预填充邮箱和姓名
            const savedEmail = localStorage.getItem('userEmail');
            const savedUserName = localStorage.getItem('userName');
            const savedAvatar = localStorage.getItem('userAvatar');
            const emailInput = document.getElementById('email');
            const userNameInput = document.getElementById('userName');
            
            // 加载用户头像
            if (savedAvatar) {
                document.getElementById('avatarInitial').style.display = 'none';
                document.getElementById('userAvatar').style.backgroundImage = `url(${savedAvatar})`;
                document.getElementById('userAvatar').style.backgroundSize = 'cover';
            }
            
            if (savedEmail && emailInput) {
                emailInput.value = savedEmail;
            }
            if (savedUserName && userNameInput) {
                userNameInput.value = savedUserName;
            }
        });
        
        closeModal.addEventListener('click', () => {
            loginModal.classList.remove('active');
        });
        
        loginModal.addEventListener('click', (e) => {
            if (e.target === loginModal) {
                loginModal.classList.remove('active');
            }
        });
        
        // 获取验证码
        getCodeBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!emailRegex.test(email)) {
                loginStatus.textContent = '请输入有效的邮箱地址';
                return;
            }
            
            // 验证姓名
            const userName = document.getElementById('userName').value;
            const nameRegex = /^[\u4e00-\u9fa5·]+$/;
            if (!nameRegex.test(userName)) {
                loginStatus.textContent = '请输入有效的中国姓名（仅限汉字和·）';
                return;
            }
            
            getCodeBtn.disabled = true;
            let countdown = 30;
            
            // 生成6位随机验证码
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            
            // 存储验证码和时间戳
            localStorage.setItem('verificationCode', code);
            localStorage.setItem('codeTimestamp', Date.now());
            localStorage.setItem('userEmail', email);
            localStorage.setItem('userName', userName);
            
            try {
                const response = await fetch(EMAIL_API, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        event_type: 'send_email_request',
                        client_payload: {
                            email: email,
                            code: code
                        }
                    })
                });
                
                if (response.ok) {
                    loginStatus.textContent = `验证码已发送至 ${email}，有效期为5分钟`;
                } else {
                    const errorData = await response.json();
                    loginStatus.textContent = `发送失败: ${errorData.message || response.status}`;
                }
            } catch (error) {
                loginStatus.textContent = `API错误: ${error.message}`;
            }
            
            // 倒计时
            const timer = setInterval(() => {
                getCodeBtn.textContent = `重新获取(${countdown})`;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(timer);
                    getCodeBtn.disabled = false;
                    getCodeBtn.textContent = '获取验证码';
                }
            }, 1000);
        });
        
        // 提交登录
        submitLogin.addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const userName = document.getElementById('userName').value;
            const code = document.getElementById('code').value;
            
            if (!email) {
                loginStatus.textContent = '请输入邮箱地址';
                return;
            }
            
            if (!userName) {
                loginStatus.textContent = '请输入姓名';
                return;
            }
            
            if (!code || code.length !== 6) {
                loginStatus.textContent = '请输入6位验证码';
                return;
            }
            
            const storedCode = localStorage.getItem('verificationCode');
            const timestamp = localStorage.getItem('codeTimestamp');
            
            if (!storedCode || !timestamp) {
                loginStatus.textContent = '请先获取验证码';
                return;
            }
            
            // 检查验证码是否在5分钟内
            const currentTime = Date.now();
            const timeDiff = (currentTime - parseInt(timestamp)) / (1000 * 60);
            
            if (timeDiff > 5) {
                loginStatus.textContent = '验证码已过期';
                return;
            }
            
            if (code === storedCode) {
                loginStatus.textContent = '登录成功！';
                
                setTimeout(() => {
                    loginModal.classList.remove('active');
                    loginBtn.style.display = 'none';
                    userAvatar.style.display = 'flex';
                    
                    // 确保没有文字内容
                    const avatarInitial = document.getElementById('avatarInitial');
                    if (avatarInitial) {
                        avatarInitial.remove();
                    }
                    userAvatar.textContent = '';
                    
                    currentUser = email;
                    isAdmin = (email === '3343363350@qq.com');
                    isTeacher = isAdmin || email.includes('teacher');
                    
                    updateUIPermissions();
                    saveUserData(userName);
                }, 1000);
            } else {
                loginStatus.textContent = '验证码错误，请重新输入';
            }
        });
        
        // 更新UI权限
        function updateUIPermissions() {
            // 确保邮箱匹配
            if (!currentUser) return;
            
            // 获取管理员列表并更新权限
            getAdminList().then(admins => {
                const adminEmails = admins.map(admin => admin.email);
                if (adminEmails.includes(currentUser)) {
                    isAdmin = true;
                    userAvatar.classList.add('admin-avatar');
                }
                
                // 管理员和教师都可以看到编辑区域
                const isEditor = isAdmin || isTeacher;
                document.getElementById('honorEditSection').style.display = isEditor ? 'block' : 'none';
                document.getElementById('materialUploadSection').style.display = isEditor ? 'block' : 'none';
                
                // 更新头像样式
                if (isAdmin) {
                    userAvatar.classList.add('admin-avatar');
                } else if (isTeacher) {
                    userAvatar.classList.add('teacher-avatar');
                }
                
                // 同步权限到本地存储
                localStorage.setItem('isAdmin', isAdmin);
                localStorage.setItem('isTeacher', isTeacher);
            });
        }
        
        // 保存用户数据到云存储
        async function saveUserData(userName, sha = null) {
            if (!currentUser) {
                console.warn('未登录用户，跳过保存');
                return;
            }
            
            const userData = {
                email: currentUser,
                name: userName,
                isAdmin: isAdmin,
                isTeacher: isTeacher,
                lastLogin: new Date().toISOString(),
                avatar: localStorage.getItem('userAvatar') || ""
            };
            
            console.log('准备保存用户数据:', userData);
            
            try {
                // 检查是否已存在用户数据
                let existingSha = null;
                try {
                    const checkResponse = await fetch(`${USER_DATA_PATH}${encodeURIComponent(currentUser)}.json`, {
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'Accept': 'application/vnd.github+json'
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const existingData = await checkResponse.json();
                        existingSha = existingData.sha;
                    }
                } catch (checkError) {
                    console.log('未找到现有用户数据，将创建新记录');
                }
                
                const payload = {
                    message: `Update user data for ${currentUser}`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(userData))))
                };
                
                // 如果存在SHA值，添加到payload中
                if (existingSha || sha) {
                    payload.sha = existingSha || sha;
                }
                
                const response = await fetch(`${USER_DATA_PATH}${encodeURIComponent(currentUser)}.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API返回错误: ${errorData.message || response.status}`);
                }
                
                const result = await response.json();
                console.log('用户数据保存成功:', result);
                return result;
            } catch (error) {
                console.error('保存用户数据失败:', error);
                throw error; // 重新抛出错误以便外部捕获
            }
        }
        
        // 安全的数据解析函数
        const safeParseData = (content) => {
            try {
                return JSON.parse(content);
            } catch (e1) {
                try {
                    const decoded = atob(content);
                    return JSON.parse(decoded);
                } catch (e2) {
                    console.error('无法解析的数据内容:', content);
                    return null;
                }
            }
        };
        
        // 获取用户头像
        function getUserAvatar(email, fallbackText) {
            if (!email) return fallbackText;
            
            try {
                // 从 userAvatars 数组中查找匹配的邮箱
                const userAvatars = JSON.parse(localStorage.getItem('userAvatars')) || [];
                const userData = userAvatars.find(item => item.email === email);
                
                if (userData && userData.avatar) {
                    return `<img src="${userData.avatar}" alt="用户头像" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                }
                
                
                // 检查旧版存储方式
                const avatars = localStorage.getItem('userAvatars = []');
                if (avatars) {
                    try {
                        const parsedAvatars = JSON.parse(avatars);
                        if (parsedAvatars && parsedAvatars[email]) {
                            return `<img src="${parsedAvatars[email]}" alt="用户头像" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        }
                    } catch (e) {
                        console.log('非JSON格式的头像数据，直接使用');
                        if (avatars[email]) {
                            return `<img src="${avatars[email]}" alt="用户头像" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        }
                    }
                }
            } catch (e) {
                console.error('获取头像数据错误:', e);
            }
            return fallbackText;
        }
        
        // 加载学习资料
        async function loadMaterials() {
            const materialsContainer = document.getElementById('materialsContainer');
            if (!materialsContainer) return;
            
            // 保留现有内容，仅追加新数据
            const existingFiles = new Set();
            materialsContainer.querySelectorAll('.material-card').forEach(card => {
                card.querySelectorAll('li').forEach(li => {
                    existingFiles.add(li.querySelector('span').textContent);
                });
            });
            
            try {
                const response = await fetch(`${MATERIALS_PATH}?recursive=1`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                const teachers = {};
                
                // 组织教师资料
                data.forEach(item => {
                    if (item.type === 'dir') {
                        teachers[item.name] = {
                            name: item.name,
                            files: []
                        };
                    }
                });
                
                for (const teacher of Object.values(teachers)) {
                    try {
                        const teacherResponse = await fetch(`${MATERIALS_PATH}${encodeURIComponent(teacher.name)}`, {
                            headers: {
                                'Authorization': `Bearer ${API_KEY}`,
                                'Accept': 'application/vnd.github+json'
                            }
                        });
                        
                        if (teacherResponse.ok) {
                            const teacherData = await teacherResponse.json();
                            teacher.files = teacherData
                                .filter(file => !file.name.endsWith('.E')) // 屏蔽.E文件
                                .map(file => ({
                                    name: file.name,
                                    download_url: file.download_url
                                }));
                        }
                    } catch (error) {
                        console.error('加载教师资料错误:', error);
                    }
                }
                
                materialsContainer.innerHTML = '';
                Object.values(teachers).forEach(teacher => {
                    if (teacher.files.length === 0) return;
                    
                    const materialCard = document.createElement('div');
                    materialCard.className = 'material-card';
                    materialCard.innerHTML = `
                        <div class="material-header">
                            <h3>${teacher.name}</h3>
                            <span class="teacher-badge">教师</span>
                        </div>
                        <div class="material-body">
                            <ul class="file-list">
                                ${teacher.files.map(file => `
                                    <li>
                                        <span>${file.name}</span>
                                        <div class="file-actions">
                                            <button class="btn btn-primary download-btn" data-url="${file.download_url}">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            ${(isTeacher || isAdmin) ? `<button class="btn btn-danger delete-file-btn" data-path="${MATERIALS_PATH}${encodeURIComponent(teacher.name)}/${encodeURIComponent(file.name)}">
                                                <i class="fas fa-trash"></i>
                                            </button>` : ''}
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                    materialsContainer.insertBefore(materialCard, materialsContainer.firstChild);
                });
                
                // 添加下载和删除事件
                document.querySelectorAll('.download-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const url = btn.dataset.url;
                        // 直接下载文件
                        fetch(url)
                            .then(response => response.blob())
                            .then(blob => {
                                const a = document.createElement('a');
                                a.href = URL.createObjectURL(blob);
                                a.download = url.split('/').pop();
                                a.style.display = 'none';
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(a.href);
                            })
                            .catch(() => {
                                alert('下载失败，请联系管理员');
                            });
                    });
                });
                
                document.querySelectorAll('.delete-file-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('确定要删除这个文件吗？')) {
                            try {
                                const response = await fetch(btn.dataset.path, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${API_KEY}`,
                                        'Accept': 'application/vnd.github+json',
                                        'X-GitHub-Api-Version': '2022-11-28'
                                    },
                                    body: JSON.stringify({
                                        message: `Delete file ${btn.dataset.path.split('/').pop()}`,
                                        sha: btn.dataset.sha
                                    })
                                });
                                
                                if (response.ok) {
                                    loadMaterials();
                                } else {
                                    alert('删除文件失败');
                                }
                            } catch (error) {
                                console.error('删除文件错误:', error);
                            }
                        }
                    });
                });
                
            } catch (error) {
                console.error('加载学习资料错误:', error);
            }
        }
        
        // 加载公告
        async function loadAnnouncements() {
            const announcementContainer = document.getElementById('announcementContainer');
            const announcementLoading = document.getElementById('announcementLoading');
            const announcementError = document.getElementById('announcementError');
            
            if (!announcementContainer) return;
            
            try {
                announcementLoading.style.display = 'flex';
                announcementError.style.display = 'none';
                
                const response = await fetch(ANNOUNCEMENT_PATH, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`公告加载失败: ${response.status}`);
                }
                
                const files = await response.json();
                announcementContainer.innerHTML = '';
                
                for (const file of files) {
                    if (file.name.endsWith('.json')) {
                        const announcementResponse = await fetch(file.download_url);
                        const announcementData = await announcementResponse.json();
                        
                        const announcementElement = document.createElement('div');
                        announcementElement.className = 'announcement-item';
                        announcementElement.innerHTML = `
                            <h3>${announcementData.title}</h3>
                            <p>${announcementData.content}</p>
                            <div class="announcement-meta">
                                <span>发布者: ${announcementData.author}</span>
                                <span>发布时间: ${new Date(announcementData.timestamp).toLocaleString()}</span>
                            </div>
                        `;
                        announcementContainer.appendChild(announcementElement);
                    }
                }
            } catch (error) {
                console.error('加载公告时出错:', error);
                announcementError.style.display = 'block';
                announcementError.textContent = '公告加载失败，请稍后再试';
            } finally {
                announcementLoading.style.display = 'none';
            }
        }
        
        // 下载状态标志
        let isDownloadingComments = false;
        
        // 全局维护已存在评论ID集合
        const existingCommentIds = new Set();
        
        // 初始化时收集已有评论ID
        function collectExistingCommentIds() {
            document.querySelectorAll('.comment-item').forEach(el => {
                if (el.dataset.id) existingCommentIds.add(el.dataset.id);
            });
        }
        

        // 下载评论/回复数据(强制重新下载)
        async function downloadComments() {
            try {
                console.log('开始下载评论/回复数据...');
                
                // 清空已存在评论ID集合
                existingCommentIds.clear();
                
                const response = await fetch(MSG_PATH + '?sort=updated&direction=desc', {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP状态码: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`从服务器获取到${data.length}条评论/回复数据`);
                
                const validItems = data
                    .filter(item => !item.name.endsWith('.E')) // 屏蔽.E文件
                    .sort((a, b) => {
                        // 按修改时间降序排序
                        const dateA = new Date(a.updated_at || a.created_at);
                        const dateB = new Date(b.updated_at || b.created_at);
                        return dateB - dateA;
                    });
                console.log(`过滤后有效评论/回复数据: ${validItems.length}条`);
                
                let addedCount = 0;
                
                // 先确保帖子加载完成
                await new Promise(resolve => setTimeout(resolve, 500));
                
                for (const item of validItems) {
                    try {
                        const fileName = item.name;
                        const dataPart = fileName.split('.')[0];
                        const base64Decoded = atob(dataPart);
                        const decodedStr = decodeURIComponent(escape(base64Decoded));
                        const commentData = JSON.parse(decodedStr);
                        
                        // 强制重新添加所有评论（即使已存在）
                        existingCommentIds.delete(commentData.senderTimestamp);
                        
                        // 尝试添加评论，最多重试3次
                        let retryCount = 0;
                        while (retryCount < 3) {
                            try {
                                addCommentToUI(commentData);
                                addedCount++;
                                break;
                            } catch (e) {
                                console.warn(`添加评论失败，重试 ${retryCount + 1}/3`, e);
                                retryCount++;
                                await new Promise(resolve => setTimeout(resolve, 500));
                            }
                        }
                    } catch (e) {
                        console.error('解析评论错误:', e, '原始数据:', item);
                    }
                }
                
                console.log(`成功添加${addedCount}条新评论/回复`);
                

            } catch (error) {
                console.error('下载评论错误:', error);
            } finally {
                isDownloadingComments = false;
            }
        }
        
        // 评论加载状态标志
        let hasLoadedComments = false;
        
        // 评论加载功能(强制重新加载)
        function loadForumComments() {
            try {
                console.log('开始加载评论数据...');
                
                // 显示加载状态
                const loadingElement = document.getElementById('forumLoading');
                if (loadingElement) loadingElement.style.display = 'flex';

                
                // 然后下载远程评论
                downloadComments().finally(() => {
                    if (loadingElement) loadingElement.style.display = 'none';
                });
                
            } catch (e) {
                console.error('加载评论失败:', e);
                alert('加载评论功能暂时不可用，请稍后再试');
                
                const loadingElement = document.getElementById('forumLoading');
                if (loadingElement) loadingElement.style.display = 'none';
            }
        }
        
        // 页面加载时不自动加载任何评论
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成，不自动加载评论');
        });
        
        // 绑定论坛按钮点击事件
        const forumBtn = document.getElementById('forumBtn');
        if (forumBtn) {
            forumBtn.addEventListener('click', loadForumComments);
        } else {
            console.warn('未找到论坛按钮元素，需要手动调用loadForumComments()加载评论');
        }
        // 更新未读消息数量
        function updateUnreadCount() {
            // 检查论坛是否加载完成
            const forumLoading = document.getElementById('forumLoading');
            if (forumLoading && forumLoading.style.display !== 'none') {
                // 如果仍在加载，延迟100ms后重试
                setTimeout(updateUnreadCount, 100);
                return;
            }
            
            const commentItems = document.querySelectorAll('.comment-item');
            const uniqueCommentIds = new Set();
            commentItems.forEach(item => {
                if(item.dataset.id) uniqueCommentIds.add(item.dataset.id);
            });
            const unreadMessages = uniqueCommentIds.size;
            const unreadBadge = document.querySelector('.unread-badge');
            
            if (unreadMessages > 0) {
                if (!unreadBadge) {
                    const badge = document.createElement('div');
                    badge.className = 'unread-badge';
                    badge.textContent = unreadMessages > 999 ? '...' : unreadMessages;
                    document.querySelector('.user-controls').appendChild(badge);
                } else {
                    unreadBadge.textContent = unreadMessages > 999 ? '...' : unreadMessages;
                }
            } else if (unreadBadge) {
                unreadBadge.remove();
            }
        }
        
        
        
        
        

        
        // 检查登录状态
        function checkLoginBeforeComment(button) {
            const userName = localStorage.getItem('userName');
            if (!userName) {
                alert('请先登录后再发表评论');
                return false;
            }
            return sendComment(button);
        }

        // 添加评论到UI（带重试机制和消息中心处理）
        async function addCommentToUI(commentData) {
            // 调试日志
            console.log('处理评论数据:', commentData);
            
            // 根据消息类型确定内容字段
            const isReply = commentData.send_to === 1;
            const contentField = isReply ? 'content' : 'comment';
            const content = commentData[contentField] || '';
            
            // 确保评论数据有效
            if (!content) {
                console.error(`评论内容为空 (${contentField})，跳过添加`, commentData);
                return;
            }
            

            
            // 创建评论项
            const commentItem = document.createElement('div');
            commentItem.className = 'comment-item';
            commentItem.dataset.id = commentData.senderTimestamp;
            commentItem.dataset.sender = commentData.sender || '匿名用户'; // 确保sender被正确赋值
            
            // 处理时间戳格式
            const timestamp = typeof commentData.timestamp === 'number' ? 
                new Date(commentData.senderTimestamp) : new Date(commentData.timestamp);
                
            const userName = localStorage.getItem('userName') || commentData.sender || '匿名用户';
            const commentContent = content.trim(); // 去除前后空格
            
            // 调试日志
            console.log('创建新评论:', commentData.senderTimestamp, content);
            
            // 如果是回复消息，添加@目标用户信息
            const replyInfo = isReply ? 
                `<div class="reply-to" style="font-size: 0.8em; color: var(--secondary); margin-left: 61px; margin-top: -20px;">
                    @${commentData.Target_mailbox || commentData.sender || '目标用户'}
                </div>` : '';
                
            commentItem.innerHTML = `
                <div class="comment-author">
                    <div class="author-avatar"></div>
                    <div class="author-name">${userName}</div>
                    <div class="comment-time">${new Date(commentData.timestamp).toLocaleString()}</div>
                </div>
                ${replyInfo}
                <div class="comment-content">${commentContent}</div>
                <button class="btn btn-primary reply-btn" onclick="showReplyInput(this)">回复</button>
            `;
            
            // 保存评论数据到localStorage并确保不重复(增强版)
            try {
                let comments = [];
                try {
                    comments = JSON.parse(localStorage.getItem('forumComments') || '[]');
                } catch (e) {
                    console.warn('解析评论数据失败，重置为空数组:', e);
                    comments = [];
                }
                
                // 更严格地去重检查
                const isDuplicate = comments.some(c => {
                    const sameId = c.senderTimestamp === commentData.senderTimestamp;
                    const sameTarget = c.targetTimestamp === commentData.targetTimestamp;
                    const sameContent = c[isReply ? 'content' : 'comment'] === commentData[isReply ? 'content' : 'comment'];
                    return sameId && sameTarget && sameContent;
                });
                
                if (!isDuplicate) {
                    // 限制评论数量，防止存储过多数据
                    if (comments.length > 100) {
                        comments = comments.slice(-100);
                    }
                    comments.push(commentData);
                    // 双重写入确保数据不丢失
                    localStorage.setItem('forumComments', JSON.stringify(comments));
                    sessionStorage.setItem('forumCommentsBackup', JSON.stringify(comments));
                } else {
                    console.log('检测到重复评论，跳过保存:', commentData.senderTimestamp);
                }
            } catch (e) {
                console.error('保存评论数据失败:', e);
            }
            
            // 最大重试次数（防止无限循环）
            const MAX_RETRY = 100;
            let retryCount = 0;
            
            while (retryCount < MAX_RETRY) {
                try {
                    // 处理源评论（send_to为0）
                    if (commentData.send_to === 0 || commentData.send_to === 'post') {
                        const postId = commentData.targetTimestamp;
                        if (!postId) {
                            console.error('添加评论失败：缺少目标帖子ID');
                            break;
                        }
                        
                        const postItem = document.querySelector(`.post-item[data-id="${postId}"]`);
                        if (!postItem) {
                            retryCount++;
                            await new Promise(resolve => setTimeout(resolve, 500));
                            continue;
                        }
                        
                        // 确保帖子有评论区域
                        let commentSection = postItem.querySelector('.comment-section');
                        if (!commentSection) {
                            commentSection = document.createElement('div');
                            commentSection.className = 'comment-section';
                            commentSection.innerHTML = `
                                <div class="comment-input-container">
                                    <textarea class="comment-input" placeholder="写下你的评论..."></textarea>
                                    <button class="btn btn-primary comment-submit" onclick="checkLoginBeforeComment(this)">发送评论</button>
                                </div>
                                <div class="comment-list"></div>
                            `;
                            postItem.appendChild(commentSection);
                        }
                        
                        const commentList = commentSection.querySelector('.comment-list');
                        if (!commentList) {
                            console.error('添加评论失败：未找到评论列表');
                            break;
                        }
                        
                        // 为当前帖子创建专属隐藏容器(如果不存在)
                        const commentPostId = commentData.targetTimestamp || 'default';
                        let hiddenCommentContainer = document.querySelector(`.hidden-comment-container[data-post-id="${commentPostId}"]`);
                        if (!hiddenCommentContainer) {
                            hiddenCommentContainer = document.createElement('div');
                            hiddenCommentContainer.className = 'hidden-comment-container';
                            hiddenCommentContainer.dataset.postId = commentPostId;
                            hiddenCommentContainer.style.display = 'none';
                            document.body.appendChild(hiddenCommentContainer);
                        }
                        
                        // 如果目标邮箱是当前用户，将消息添加到隐藏容器
                        const userEmail = localStorage.getItem('userEmail');
                        // 根据send_to值确定目标邮箱来源
                        let targetEmail = 'unknown@example.com';
                        if (commentData.send_to === 0) {
                            // 评论数据，使用帖子作者的邮箱
                            targetEmail = postItem.dataset.email || 'unknown@example.com';
                            // 确保评论数据也包含正确的邮箱
                            commentData.email = targetEmail;
                            console.log('评论数据，使用帖子邮箱:', targetEmail);
                        } else {
                            // 回复数据，从评论获取Target_mailbox
                            targetEmail = commentData.Target_mailbox || 'unknown@example.com';
                            console.log('回复数据，从评论获取目标邮箱:', targetEmail);
                        }
                        
                        // 调试日志：显示当前用户邮箱和目标邮箱
                        console.log('当前用户邮箱:', userEmail, '目标邮箱:', targetEmail);
                        
                        // 确保邮箱比较时不区分大小写
                        if (userEmail && targetEmail && userEmail.toLowerCase() === targetEmail.toLowerCase()) {
                            const hiddenContainer = document.querySelector('.hidden-notifications-container');
                            if (!hiddenContainer) {
                                console.error('未找到隐藏通知容器');
                                return;
                            }
                            
                            // 检查是否已存在相同ID的通知
                            const existingNotification = hiddenContainer.querySelector(`.notification-item[data-id="${commentData.senderTimestamp}"]`);
                            if (existingNotification) {
                                console.log('检测到重复通知，跳过添加:', commentData.senderTimestamp);
                                return;
                            }
                            
                            // 调试日志：显示邮箱匹配成功
                            console.log('邮箱匹配成功，准备添加通知');
                            
                            // 创建通知项
                            const notificationItem = document.createElement('div');
                            notificationItem.className = 'notification-item';
                            notificationItem.dataset.id = commentData.senderTimestamp;
                            notificationItem.dataset.type = isReply ? '回复' : '评论';
                            notificationItem.dataset.sender = userName || '匿名用户';
                            notificationItem.dataset.postId = commentData.targetTimestamp || commentData.targetPostId;
                            notificationItem.dataset.hasImage = commentData.hasImage ? 'true' : 'false';
                            notificationItem.innerHTML = `
                                <div class="notification-content">
                                    <p>${commentData.content || commentData.comment}</p>
                                    <small>${new Date(commentData.timestamp).toLocaleString()}</small>
                                </div>
                            `;
                            
                            // 添加到容器
                            hiddenContainer.appendChild(notificationItem);
                            console.log('已添加通知:', {
                                content: commentData.content,
                                sender: userName,
                                timestamp: commentData.timestamp
                            });
                            
                            // 更新未读计数
                            const unreadBadge = document.querySelector('.unread-badge');
                            if (unreadBadge) {
                                const currentCount = parseInt(unreadBadge.textContent) || 0;
                                unreadBadge.textContent = currentCount + 1;
                                unreadBadge.style.display = 'flex';
                            }
                        } else {
                            console.log('邮箱不匹配或未设置用户邮箱', {
                                userEmail,
                                targetEmail
                            });
                        }
                        
                        // 确保评论数据包含目标邮箱
                        commentData.email = postItem.dataset.email || 'unknown@example.com';
                        
                        // 严格去重检查(包括隐藏容器中的评论)
                        const allComments = Array.from(hiddenCommentContainer.querySelectorAll('.comment-item'));
                        const isDuplicate = allComments.some(comment => {
                            const isSameContent = comment.querySelector('.comment-content').textContent === commentData.content;
                            const isSameTimestamp = comment.dataset.id === commentData.senderTimestamp.toString();
                            const replyToElement = comment.querySelector('.reply-to');
                            const isSameReplyTo = replyToElement ? 
                                replyToElement.textContent.trim() === `@${commentData.replyTo || ''}` : 
                                !commentData.replyTo;
                            return isSameContent && isSameTimestamp && isSameReplyTo;
                        });
                        if (isDuplicate) return;
                        
                        // 添加新评论到对应帖子的隐藏容器
                        hiddenCommentContainer.appendChild(commentItem);
                        
                        // 清空当前显示的评论列表
                        commentList.innerHTML = '';
                        
                        // 从隐藏容器获取所有评论并按时间排序(确保不重复)
                        const existingIds = new Set();
                        const sortedComments = Array.from(hiddenCommentContainer.querySelectorAll('.comment-item'))
                            .filter(comment => {
                                if (existingIds.has(comment.dataset.id)) {
                                    return false;
                                }
                                existingIds.add(comment.dataset.id);
                                return true;
                            })
                            .sort((a, b) => parseInt(b.dataset.id) - parseInt(a.dataset.id));
                        
                        // 清空当前显示的评论列表
                        commentList.innerHTML = '';
                        
                        // 确保移除所有旧的展开按钮
                        const oldButtons = commentList.querySelectorAll('.expand-comments');
                        oldButtons.forEach(btn => btn.remove());
                        
                        // 总是显示展开按钮(检测隐藏容器中的评论)
                        const hiddenComments = Array.from(hiddenCommentContainer.querySelectorAll('.comment-item'));
                        const expandButton = document.createElement('div');
                        expandButton.className = 'expand-comments';
                        expandButton.textContent = `展开评论(${hiddenComments.length})`;
                        expandButton.style.display = 'block';
                        expandButton.onclick = () => {
                            // 清空当前显示
                            commentList.innerHTML = '';
                            
                            // 显示所有评论
                            hiddenComments.forEach(comment => {
                                const clonedComment = comment.cloneNode(true);
                                clonedComment.classList.add('show');
                                commentList.appendChild(clonedComment);
                            });
                            
                            // 隐藏展开按钮
                            expandButton.style.display = 'none';
                            
                            // 添加收起按钮到评论区域顶部
                            const collapseButton = document.createElement('button');
                            collapseButton.className = 'btn btn-secondary collapse-comments';
                            collapseButton.textContent = '收起全部评论';
                            collapseButton.style.marginBottom = '10px';
                            collapseButton.style.display = 'block';
                            collapseButton.onclick = () => {
                                // 清空当前显示的评论
                                commentList.innerHTML = '';
                                // 重新显示展开按钮
                                expandButton.style.display = 'block';
                                // 移除收起按钮
                                collapseButton.remove();
                            };
                            // 添加到评论区域顶部
                            commentSection.insertBefore(collapseButton, commentSection.firstChild);
                        };
                        commentList.appendChild(expandButton);
                        
                        return; // 添加成功，退出函数
                    } else {
                        // 处理回复评论
                        if (!commentData.targetPostId) {
                            console.error('添加回复失败：缺少目标帖子ID');
                            break;
                        }
                        
                        // 尝试查找目标帖子，最多等待3秒
                        let postItem = null;
                        let waitCount = 0;
                        const maxWaitCount = 6; // 6 * 500ms = 3秒
                        
                        while (!postItem && waitCount < maxWaitCount) {
                            postItem = document.querySelector(`.post-item[data-id="${commentData.targetPostId}"]`);
                            if (!postItem) {
                                waitCount++;
                                await new Promise(resolve => setTimeout(resolve, 500));
                            }
                        }
                        
                        if (!postItem) {
                            console.error(`无法找到目标帖子: ${commentData.targetPostId}`);
                            break;
                        }
                        
                        // 确保帖子有评论区域
                        let commentSection = postItem.querySelector('.comment-section');
                        if (!commentSection) {
                            commentSection = document.createElement('div');
                            commentSection.className = 'comment-section';
                            commentSection.innerHTML = `
                                <div class="comment-input-container">
                                    <textarea class="comment-input" placeholder="写下你的评论..."></textarea>
                                    <button class="btn btn-primary comment-submit" onclick="checkLoginBeforeComment(this)">发送评论</button>
                                </div>
                                <div class="comment-list"></div>
                            `;
                            postItem.appendChild(commentSection);
                        }
                        
                        const commentList = commentSection.querySelector('.comment-list');
                        if (!commentList) {
                            console.error('添加回复失败：未找到评论列表');
                            break;
                        }
                        
                        // 确保评论项已正确创建
                        if (!commentItem || !commentItem.innerHTML) {
                            console.error('评论项未正确创建');
                            break;
                        }
                        
                        // 为当前帖子创建专属隐藏容器(如果不存在)
                        const commentPostId = commentData.targetPostId || 'default';
                        let hiddenCommentContainer = document.querySelector(`.hidden-comment-container[data-post-id="${commentPostId}"]`);
                        if (!hiddenCommentContainer) {
                            hiddenCommentContainer = document.createElement('div');
                            hiddenCommentContainer.className = 'hidden-comment-container';
                            hiddenCommentContainer.dataset.postId = commentPostId;
                            hiddenCommentContainer.style.display = 'none';
                            document.body.appendChild(hiddenCommentContainer);
                        }
                        
                        // 严格去重检查(包括隐藏容器中的评论)
                        const allComments = Array.from(hiddenCommentContainer.querySelectorAll('.comment-item'));
                        const isDuplicate = allComments.some(comment => {
                            const isSameContent = comment.querySelector('.comment-content').textContent === commentData.content;
                            const isSameTimestamp = comment.dataset.id === commentData.senderTimestamp.toString();
                            const replyToElement = comment.querySelector('.reply-to');
                            const isSameReplyTo = replyToElement ? 
                                replyToElement.textContent.trim() === `@${commentData.replyTo || ''}` : 
                                !commentData.replyTo;
                            return isSameContent && isSameTimestamp && isSameReplyTo;
                        });
                        if (isDuplicate) return;
                        
                        // 确保回复数据包含目标邮箱
                        // 对于回复消息，使用被回复评论的邮箱作为目标邮箱
                        commentData.Target_mailbox = commentData.replyToEmail || postItem.dataset.sender || 'unknown@example.com';
                        
                        // 添加新评论到隐藏容器
                        hiddenCommentContainer.appendChild(commentItem);
                        
                        // 清空当前显示的评论列表
                        commentList.innerHTML = '';
                        
                        // 从隐藏容器获取所有评论并按时间排序(确保不重复)
                        const existingIds = new Set();
                        const sortedComments = Array.from(hiddenCommentContainer.querySelectorAll('.comment-item'))
                            .filter(comment => {
                                if (existingIds.has(comment.dataset.id)) {
                                    return false;
                                }
                                existingIds.add(comment.dataset.id);
                                return true;
                            })
                            .sort((a, b) => parseInt(b.dataset.id) - parseInt(a.dataset.id));
                        
                        // 创建展开按钮
                        const expandButton = document.createElement('div');
                        expandButton.className = 'expand-comments';
                        expandButton.textContent = `展开更多评论(${sortedComments.length})`;
                        expandButton.style.display = 'block';
                        expandButton.onclick = () => {
                            // 清空当前显示
                            commentList.innerHTML = '';
                            
                            // 显示所有评论
                            sortedComments.forEach(comment => {
                                const clonedComment = comment.cloneNode(true);
                                clonedComment.classList.add('show');
                                commentList.appendChild(clonedComment);
                            });
                            
                            // 隐藏展开按钮
                            expandButton.style.display = 'none';
                        };
                        commentList.appendChild(expandButton);
                        
                        console.log('回复消息已添加到帖子:', commentData);
                        return; // 添加成功，退出函数
                    }
                } catch (e) {
                    retryCount++;
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            console.error(`添加评论失败：已达到最大重试次数(${MAX_RETRY})`);
        }
        
        // 加载帖子
        async function loadPosts() {
            const postList = document.getElementById('postList');
            if (!postList) return;
            
            // 清空已存在评论ID集合，确保所有评论都会被重新处理
            existingCommentIds.clear();
            loadForumComments();
            try {
                const response = await fetch(POST_PATH + '?sort=updated&direction=desc', {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                const existingPostIds = new Set();
                
                // 先收集所有隐藏评论容器的数据
                const hiddenContainers = {};
                document.querySelectorAll('.hidden-comment-container').forEach(container => {
                    hiddenContainers[container.dataset.postId] = container.innerHTML;
                });
                
                // 保留现有帖子中的评论数据
                const existingPosts = {};
                postList.querySelectorAll('[data-id]').forEach(el => {
                    existingPostIds.add(el.dataset.id);
                    const commentSection = el.querySelector('.comment-section');
                    if (commentSection) {
                        existingPosts[el.dataset.id] = commentSection.innerHTML;
                    }
                });
                
                data
                    .filter(item => !item.name.endsWith('.E')) // 屏蔽.E文件
                    .forEach(item => {
                    try {
                        // 从文件名解析数据
                        const fileName = item.name;
                        const dataPart = fileName.split('.')[0];
                        const base64Decoded = atob(dataPart);
                        const decodedStr = decodeURIComponent(escape(base64Decoded));
                        const postData = JSON.parse(decodedStr);
                        
                        // 跳过已存在的帖子
                        if (existingPostIds.has(postData.id)) return;
                        
                        // 确保email字段被正确提取
                        const email = postData.email || 'unknown@example.com';
                        console.log('解析到的帖子邮箱:', email);
                        const userName = localStorage.getItem('userName') || email;
                        
                        const postItem = document.createElement('li');
                        postItem.className = 'post-item';
                        postItem.dataset.id = postData.id;
                        postItem.dataset.email = email; // 确保帖子作者邮箱被正确保存
                        postItem.dataset.email = email; // 确保email值被保存到容器
                        postItem.innerHTML = `
                            <div class="post-header">
                                <div class="post-author">
                                    <div class="author-avatar ${postData.isAdmin ? 'admin-avatar' : (postData.isTeacher ? 'teacher-avatar' : '')}">
                                        ${(() => {
                                            const userAvatar = userAvatars.find(item => item.email === postData.email);
                                            return userAvatar ? 
                                                `<img src="${userAvatar.avatar}" alt="用户头像" class="avatar-img" />` : 
                                                getUserAvatar(postData.email, (postData.name || userName).charAt(0).toUpperCase());
                                        })()}
                                    </div>
                                    <div>
                                        <div class="author-name">${postData.name || userName}</div>
                                        <div class="post-time">${new Date(postData.timestamp).toLocaleString()}</div>
                                    </div>
                                </div>
                                <div class="post-actions">
                                    ${(currentUser === email || isAdmin || isTeacher) ? 
                                        `<button class="btn btn-danger delete-post-btn" 
                                            data-id="${postData.id}"
                                            data-filename="${fileName}"
                                            data-sha="${item.sha}">
                                            <i class="fas fa-trash"></i>
                                        </button>` : ''}
                                </div>
                            </div>
                            <h3 class="post-title">${postData.title}</h3>
                            <div class="post-content">
                                <p>${postData.content}</p>
                            </div>
                            <!-- 评论功能区域 -->
                            <div class="comment-section">
                                <div class="comment-input-container">
                                    <textarea class="comment-input" placeholder="写下你的评论..."></textarea>
                                    <button class="btn btn-primary comment-submit" onclick="checkLoginBeforeComment(this)">发送评论</button>
                                </div>
                                <div class="comment-list">
                                    
                                </div>
                            </div>
                        `;
                        
                        // 如果有图片，显示图片
                        if (item.size > 0) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'image-preview-container';
                            imgContainer.style.maxWidth = '100%';
                            imgContainer.style.overflow = 'hidden';
                            
                            // 确保图片内容正确加载
                            fetch(item.download_url)
                                .then(response => response.blob())
                                .then(blob => {
                                    const reader = new FileReader();
                                    reader.onload = function() {
                                        const img = document.createElement('img');
                                        img.src = reader.result;
                                        img.alt = '帖子图片';
                                        img.className = 'image-preview';
                                        img.style.maxWidth = '100%';
                                        img.style.height = 'auto';
                                        img.style.cursor = 'pointer';
                                        
                                        // 点击图片时打开原始URL
                                        img.addEventListener('click', () => {
                                            window.open(item.download_url, '_blank');
                                        });
                                        
                                        imgContainer.appendChild(img);
                                    };
                                    reader.readAsDataURL(blob);
                                })
                                .catch(() => {
                                    console.error('图片加载失败');
                                });
                            
                            postItem.querySelector('.post-content').appendChild(imgContainer);
                        }
                        
                        postList.insertBefore(postItem, postList.firstChild);
                        
                        // 恢复该帖子的评论数据
                        const postId = postItem.dataset.id;
                        if (hiddenContainers[postId]) {
                            const hiddenContainer = document.querySelector(`.hidden-comment-container[data-post-id="${postId}"]`);
                            if (!hiddenContainer) {
                                const newContainer = document.createElement('div');
                                newContainer.className = 'hidden-comment-container';
                                newContainer.dataset.postId = postId;
                                newContainer.style.display = 'none';
                                newContainer.innerHTML = hiddenContainers[postId];
                                document.body.appendChild(newContainer);
                            }
                        }
                        
                        // 恢复可见评论区域
                        if (existingPosts[postId]) {
                            const commentSection = postItem.querySelector('.comment-section');
                            if (commentSection) {
                                commentSection.innerHTML = existingPosts[postId];
                            }
                        }
                    } catch (e) {
                        console.error('解析帖子错误:', e, item);
                    }
                });
                
                // 添加删除事件
                document.querySelectorAll('.delete-post-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('确定要删除这个帖子吗？')) {
                            try {
                                // 直接使用按钮中存储的文件名和SHA值
                                const fileName = btn.dataset.filename;
                                const fileSha = btn.dataset.sha;
                                
                                if (!fileName || !fileSha) {
                                    alert('删除失败：缺少必要的文件信息');
                                    return;
                                }
                                
                                // 执行删除操作
                                const response = await fetch(`${POST_PATH}${fileName}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${API_KEY}`,
                                        'Accept': 'application/vnd.github+json',
                                        'X-GitHub-Api-Version': '2022-11-28'
                                    },
                                    body: JSON.stringify({
                                        message: `Delete post ${btn.dataset.id}`,
                                        sha: fileSha
                                    })
                                });
                                
                                if (response.ok) {
                                    loadPosts();
                                } else {
                                    alert('删除帖子失败');
                                }
                            } catch (error) {
                                console.error('删除帖子错误:', error);
                            }
                        }
                    });
                });
                
                // 加载完成后显示帖子列表
                const postLoadingElement = document.getElementById('postLoading');
                if(postLoadingElement) {
                    postLoadingElement.style.display = 'none';
                }
                if(postList) {
                    postList.style.display = 'block';
                }
                
            } catch (error) {
                console.error('加载帖子错误:', error);
                postLoading.innerHTML = `<p style="color: var(--danger);">加载失败: ${error.message}</p>`;
            }

        }
        
        // 发布帖子
        document.getElementById('postSubmitBtn').addEventListener('click', async () => {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const imageInput = document.getElementById('postImage');
            
            if (!title || !content) {
                alert('请填写标题和内容');
                return;
            }
            
            if (!currentUser) {
                alert('请先登录');
                return;
            }
            
            const postData = {
                id: Date.now().toString(),
                title: title,
                content: content,
                email: currentUser,
                isAdmin: isAdmin,
                isTeacher: isTeacher,
                timestamp: new Date().toISOString(),
                name: localStorage.getItem('userName') || currentUser
            };
            
            // 将数据编码为Base64作为文件名
            const dataBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(postData))));
            const fileName = `${dataBase64}.json.png`;
            
            let fileContent = '';
            if (imageInput.files.length) {
                const file = imageInput.files[0];
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片大小不能超过5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function() {
                    fileContent = reader.result.split(',')[1];
                    uploadPostFile(fileName, fileContent);
                };
                reader.readAsDataURL(file);
            } else {
                uploadPostFile(fileName, fileContent);
            }
        });
        
        // 上传帖子文件
        async function uploadPostFile(fileName, content) {
            try {
                const response = await fetch(`${POST_PATH}${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        message: `New post by ${currentUser}`,
                        content: content
                    })
                });
                
                if (response.ok) {
                    alert('帖子发布成功');
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postContent').value = '';
                    document.getElementById('postImage').value = '';
                    loadPosts();
                } else {
                    alert('帖子发布失败');
                }
            } catch (error) {
                console.error('发布帖子错误:', error);
            }
        }
        
        // 加载聊天消息（智能滚动模式）
        async function loadChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            // 保存当前滚动位置和高度
            const scrollBefore = chatMessages.scrollTop;
            const scrollHeightBefore = chatMessages.scrollHeight;
            
            try {
                const response = await fetch(CHAT_PATH, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                if (!Array.isArray(data)) return;
                
                // 获取当前已显示的消息ID
                const existingMessageIds = new Set();
                chatMessages.querySelectorAll('.message').forEach(el => {
                    const id = el.dataset.id;
                    if (id) existingMessageIds.add(id);
                });
                
                // 只添加新消息
                let hasNewMessages = false;
                for (const item of data.filter(item => !item.name.endsWith('.E'))) { // 屏蔽.E文件
                    try {
                        // 从文件名解析数据
                        const fileName = item.name;
                        const dataPart = fileName.split('.')[0];
                        const base64Decoded = atob(dataPart);
                        const decodedStr = decodeURIComponent(escape(base64Decoded));
                        const messageData = JSON.parse(decodedStr);
                        
                        // 如果消息已存在则跳过
                        if (existingMessageIds.has(messageData.id)) continue;
                        
                        const userName = localStorage.getItem('userName') || messageData.sender;
                        
                        const messageEl = document.createElement('div');
                        messageEl.className = `message ${messageData.sender === currentUser ? 'current-user-message' : ''}`;
                        messageEl.dataset.id = messageData.id;
                        messageEl.innerHTML = `
                            <div class="message-header">
                                <div class="post-author">
                                    <div class="author-avatar">
                                        ${getUserAvatar(messageData.sender, (messageData.name || messageData.sender || userName).charAt(0).toUpperCase())}
                                    </div>
                                    <div>
                                        <span class="message-sender">${messageData.name || messageData.sender || userName}</span>
                                        <span class="message-time">${new Date(messageData.timestamp).toLocaleTimeString()}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="message-content">${messageData.content}</div>
                        `;
                        
                        chatMessages.appendChild(messageEl);
                        hasNewMessages = true;
                    } catch (e) {
                        console.error('解析聊天消息错误:', e, item);
                    }
                }
                
                // 如果有新消息
                if (hasNewMessages) {
                    // 计算是否在底部附近（距离底部小于100px）
                    const isNearBottom = (scrollHeightBefore - scrollBefore - chatMessages.clientHeight) < 100;
                    
                    // 如果在底部附近或者这是初始加载，则滚动到底部
                    if (isNearBottom || scrollHeightBefore === chatMessages.clientHeight) {
                        scrollChatToBottom();
                    }
                }
                
            } catch (error) {
                console.error('加载聊天记录错误:', error);
            }
        }
        
        // 滚动到聊天底部
        function scrollChatToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                // 使用平滑滚动
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }
        
        
        
        // 智能聊天滚动控制器
        function initSmartChatScroll() {
            // 确保只在聊天界面激活时执行
            const chatContainer = document.querySelector('.chat-container');
            if (!chatContainer || window.getComputedStyle(chatContainer).display === 'none') {
                console.log('[ChatScroll] 聊天界面未激活，跳过初始化');
                return;
            }
            
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) {
                console.error('[ChatScroll] 错误：未找到聊天区域元素');
                return;
            }
            
            // 定义滚动执行函数
            const executeScroll = () => {
                console.log('[ChatScroll] 执行滚动');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };
            
            // 立即执行一次
            executeScroll();
            
            // 监听内容变化（仅当界面可见时）
            const observer = new MutationObserver((mutations) => {
                if (window.getComputedStyle(chatContainer).display !== 'none') {
                    executeScroll();
                }
            });
            
            observer.observe(chatMessages, {
                childList: true,
                subtree: true
            });
            
            // 暴露控制器方法
            window.chatScrollController = {
                refresh: executeScroll,
                dispose: () => observer.disconnect()
            };
        }
        
        // 延迟初始化（确保界面切换完成）
        const initDelayedScroll = () => {
            setTimeout(initSmartChatScroll, 300);
        };
        
        // 通过事件监听触发（替代直接执行）
        document.addEventListener('chatActivated', initDelayedScroll);
        
        // 开发调试接口
        window.debugChatScroll = initSmartChatScroll;
        
        // 初始化 WebSocket 连接
        const WS_SERVER = 'wss://clouddata.turbowarp.org';
        let socket;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        function connectWebSocket() {
            console.log(`正在连接 WebSocket 服务器: ${WS_SERVER} (尝试 ${reconnectAttempts + 1}/${MAX_RECONNECT_ATTEMPTS})`);
            
            socket = new WebSocket(WS_SERVER);
            
            // 连接成功时发送握手消息
            socket.onopen = function(event) {
                reconnectAttempts = 0;
                console.log('WebSocket 连接已建立');
                try {
                    const handshakeMsg = JSON.stringify({
                        method: 'handshake',
                        project_id: 'Livechat',
                        user: 'player8080'
                    });
                    socket.send(handshakeMsg);
                    console.log('握手消息已发送:', handshakeMsg);
                } catch (error) {
                    console.error('发送握手消息失败:', error);
                }
            };

            // 连接错误处理
            socket.onerror = function(error) {
                console.error('WebSocket 连接错误:', error);
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 3000);
                } else {
                    console.error(`已达到最大重连次数(${MAX_RECONNECT_ATTEMPTS})，停止尝试`);
                }
            };

            // 连接关闭处理
            socket.onclose = function(event) {
                console.log(`WebSocket 连接关闭，代码: ${event.code}, 原因: ${event.reason || '无'}`);
                if (event.code !== 1000 && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 3000);
                }
            };
        }

        // 初始连接
        connectWebSocket();

        // 测试服务器连通性
        function testConnection() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                console.warn('WebSocket 未连接，正在尝试重新连接...');
                connectWebSocket();
                return false;
            }
            return true;
        }

        // 每30秒检查一次连接状态
        setInterval(testConnection, 30000);

        // 连接错误处理
        socket.onerror = function(error) {
            console.error('WebSocket 错误:', error);
        };

        // 连接关闭处理
        socket.onclose = function(event) {
            console.log('WebSocket 连接已关闭:', event.reason);
        };

        // 接收消息并添加到聊天列表
        socket.onmessage = async function(event) {
            console.log('收到 WebSocket 原始消息:', event.data);
            
            // 统一处理不同格式的 WebSocket 数据
            let rawData;
            try {
                if (typeof event.data === 'string') {
                    rawData = event.data;
                } else if (event.data instanceof Blob) {
                    rawData = await event.data.text();
                } else if (event.data instanceof ArrayBuffer) {
                    rawData = String.fromCharCode.apply(null, new Uint8Array(event.data));
                } else {
                    console.warn('未知的 WebSocket 数据类型:', event.data);
                    return;
                }
                
                if (!rawData || rawData.trim() === '') {
                    console.warn('收到空消息');
                    return;
                }
                
                const data = JSON.parse(rawData);
                console.log('解析后的消息:', data);
                
                // 检查是否是握手响应
                if (data.method === 'handshake' && data.success) {
                    console.log('握手成功:', data);
                    return;
                }
                
                // 处理聊天消息
                if (data.method === 'set' && data.name === 'variable1') {
                    try {
                        // 硬编码 Base64 字符集（包含填充字符'='）
                        const base64Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';
                        
                        // 将数字解码回 Base64 字符串（严格匹配字符集）
                        const numberToBase64 = (numStr) => {
                            let base64Str = '';
                            for (let i = 0; i < numStr.length; i += 2) {
                                const code = parseInt(numStr.substr(i, 2));
                                // 确保 code 在 Base64 字符集范围内（0-64，64对应'='）
                                if (code >= 0 && code <= 64) {
                                    base64Str += base64Chars[code];
                                } else {
                                    console.error('无效的 Base64 数字编码:', code);
                                    return '';
                                }
                            }
                            return base64Str;
                        };
                        
                        const base64Data = numberToBase64(data.value);
                        if (!base64Data) {
                            console.error('Base64 解码失败: 无效的数字编码');
                            return;
                        }
                        console.log('Base64 解码结果:', base64Data);
                        
                        // 处理 UTF-8 编码的 Base64 字符串
                        // 直接解码 Base64 并解析 JSON
                        // 确保 Base64 解码正确
                        let utf8Str;
                        let messageData;
                        try {
                            const firstDecoded = atob(base64Data);
                            const secondDecoded = atob(firstDecoded.replace(/^"/, '').replace(/"$/, ''));
                            messageData = JSON.parse(secondDecoded);
                            console.log('解析后的消息数据:', messageData);
                            
                            // 验证必要字段
                            if (!messageData.id || !messageData.timestamp || !messageData.content || !messageData.sender || !messageData.name) {
                                console.error('消息缺少必要字段:', messageData);
                                return;
                            }
                            
                            // 修复编码问题
                            messageData.content = decodeURIComponent(escape(messageData.content));
                            messageData.name = decodeURIComponent(escape(messageData.name));
                        } catch (error) {
                            console.error('Base64 解码或 JSON 解析失败:', error);
                            return;
                        }
                        console.log('聊天消息内容:', messageData);
                        
                        const chatMessages = document.getElementById('chatMessages');
                        if (!chatMessages) {
                            console.warn('未找到聊天消息容器');
                            return;
                        }

                        // 检查是否已存在相同 ID 的消息（确保 messageData.id 存在）
                        if (messageData.id && document.querySelector(`[data-id="${messageData.id}"]`)) {
                            console.log('消息已存在，跳过:', messageData.id);
                            return;
                        }

                        // 确保 content 字段存在且有效
                        const messageContent = messageData.content || '无内容';
                        
                        const messageEl = document.createElement('div');
                        messageEl.className = `message ${messageData.sender === currentUser ? 'current-user-message' : ''}`;
                        messageEl.dataset.id = messageData.id;
                        messageEl.dataset.timestamp = messageData.timestamp; // 添加时间戳属性
                        messageEl.innerHTML = `
                            <div class="message-header">
                                <div class="post-author">
                                    <div class="author-avatar">
                                        ${getUserAvatar(messageData.sender, (messageData.name || messageData.sender || localStorage.getItem('userName') || currentUser).charAt(0).toUpperCase())}
                                    </div>
                                    <div>
                                        <span class="message-sender">${messageData.name || messageData.sender || localStorage.getItem('userName') || currentUser}</span>
                                        <span class="message-time">${new Date(messageData.timestamp).toLocaleTimeString()}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="message-content">${messageContent}</div>
                        `;

                        // 按时间戳排序后插入消息
                        const allMessages = Array.from(chatMessages.children);
                        const newMessageTime = new Date(messageData.timestamp).getTime();
                        
                        let insertIndex = allMessages.findIndex(msg => {
                            return newMessageTime < new Date(msg.dataset.timestamp).getTime();
                        });
                        
                        if (insertIndex === -1) {
                            chatMessages.appendChild(messageEl);
                        } else {
                            chatMessages.insertBefore(messageEl, allMessages[insertIndex]);
                        }
                        
                        scrollChatToBottom();
                        
                        // 静默加载一次聊天消息（延迟100ms确保DOM更新完成）
                        setTimeout(() => {
                            loadChatMessages();
                        }, 100);
                    } catch (error) {
                        console.error('解析聊天消息错误:', error);
                    }
                } else {
                    console.log('收到其他类型消息:', data);
                }
            } catch (error) {
                console.error('处理 WebSocket 消息错误:', error);
            }
        };

        // 发送消息
        document.getElementById('sendMessageBtn').addEventListener('click', async () => {
            const messageInput = document.getElementById('chatInput');
            let content = messageInput.value.trim();
            
            if (!content) {
                alert('请输入消息内容');
                return;
            }
            
            if (!currentUser) {
                alert('请先登录');
                return;
            }
            
            // 确保UTF-8编码处理
            content = content;
            
            const messageData = {
                id: Date.now().toString(),
                sender: currentUser,
                content: content,
                timestamp: new Date().toISOString(),
                name: localStorage.getItem('userName') || currentUser
            };

            // 将消息先添加到聊天栏
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                const messageEl = document.createElement('div');
                messageEl.className = `message current-user-message`;
                messageEl.dataset.id = messageData.id;
                messageEl.innerHTML = `
                    <div class="message-header">
                        <div class="post-author">
                            <div class="author-avatar">
                                ${getUserAvatar(messageData.sender, (messageData.name || messageData.sender).charAt(0).toUpperCase())}
                            </div>
                            <div>
                                <span class="message-sender">${messageData.name || messageData.sender}</span>
                                <span class="message-time">${new Date(messageData.timestamp).toLocaleTimeString()}</span>
                            </div>
                        </div>
                    </div>
                    <div class="message-content">${messageData.content}</div>
                `;
                chatMessages.appendChild(messageEl);
                scrollChatToBottom();
            }

            // 将数据编码为Base64作为文件名
            const dataBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(messageData))));
            const fileName = `${dataBase64}.json.png`;
            
            try {
                const response = await fetch(`${CHAT_PATH}${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        message: `New chat message from ${currentUser}`,
                        content: '' // 聊天消息没有图片
                    })
                });
                
                if (response.ok) {
                    messageInput.value = '';
                    loadChatMessages();
                    scrollChatToBottom();
                    
                    // 通过 WebSocket 广播消息
                    if (socket.readyState === WebSocket.OPEN) {
                        try {
                            // 硬编码 Base64 字符集
                            const base64Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
                            
                            // 将 JSON 数据转为 UTF-8 Base64 字符串
                            const jsonToBase64 = (obj) => {
                                const jsonStr = JSON.stringify(obj);
                                return btoa(unescape(encodeURIComponent(jsonStr)));
                            };
                            
                            // 将 Base64 字符串转换为数字（严格匹配字符集）
                            const base64ToNumber = (str) => {
                                return str.split('').map(c => {
                                    const index = base64Chars.indexOf(c);
                                    if (index === -1) {
                                        console.error('无效的 Base64 字符:', c);
                                        return '';
                                    }
                                    return index.toString().padStart(2, '0');
                                }).join('');
                            };
                            
                            const base64Data = jsonToBase64(dataBase64);
                            const numericData = base64ToNumber(base64Data);
                            if (!numericData) {
                                console.error('Base64 转数字失败: 无效字符');
                                return;
                            }
                            
                            const messageToSend = JSON.stringify({
                                method: 'set',
                                name: 'variable1',
                                value: numericData
                            });
                            socket.send(messageToSend);
                            console.log('WebSocket 消息已发送:', messageToSend);
                        } catch (error) {
                            console.error('发送 WebSocket 消息失败:', error);
                            // 尝试重新连接
                            socket = new WebSocket('wss://clouddata.turbowarp.org');
                        }
                    } else {
                        console.warn('WebSocket 未连接，当前状态:', socket.readyState);
                        // 尝试重新连接
                        socket = new WebSocket('wss://clouddata.turbowarp.org');
                    }
                } else {
                    alert('发送消息失败');
                }
            } catch (error) {
                console.error('发送消息错误:', error);
            }
        });
        
        // 获取管理员列表
        async function getAdminList() {
            try {
                const response = await fetch(ADMIN_PATH, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return [];
                
                const data = await response.json();
                if (!Array.isArray(data)) return [];
                
                // 只获取文件名中的邮箱
                return data.filter(item => !item.name.endsWith('.E')).map(item => {
                    const fileName = item.name;
                    const emailMatch = fileName.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/);
                    return emailMatch ? { email: emailMatch[0] } : null;
                }).filter(Boolean);
            } catch (error) {
                console.error('获取管理员列表错误:', error);
                return [];
            }
        }

        // 加载荣誉墙
        async function loadHonors() {
            const honorWall = document.getElementById('honorWall');
            if (!honorWall) return;
            
            // 保留现有内容，仅追加新数据
            const existingIds = new Set();
            honorWall.querySelectorAll('.honor-card').forEach(card => {
                existingIds.add(card.dataset.id);
            });
            
            try {
                const response = await fetch(HONOR_PATH, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                honorWall.innerHTML = '';
                
                if (!Array.isArray(data)) return;
                
                data
                    .filter(item => !item.name.endsWith('.E')) // 屏蔽.E文件
                    .forEach(item => {
                    try {
                        // 从文件名解析数据
                        const fileName = item.name;
                        const dataPart = fileName.split('.')[0];
                        const base64Decoded = atob(dataPart);
                        // 修复编码问题
                        const decodedStr = decodeURIComponent(escape(base64Decoded)); // 确保UTF-8编码正确解析 // 确保UTF-8编码正确解析
                        const honorData = JSON.parse(decodedStr);
                        
                        const honorCard = document.createElement('div');
                        honorCard.className = 'honor-card';
                        honorCard.innerHTML = `
                            <div class="honor-body">
                                <h3 class="honor-title">${honorData.title}</h3>
                                <p class="honor-desc">${honorData.description}</p>
                                <button class="btn btn-primary">
                                    <i class="fas fa-share"></i> 分享荣誉
                                </button>
                                ${(isTeacher || isAdmin) ? `<button class="btn btn-danger delete-honor-btn" data-id="${honorData.id}">
                                    <i class="fas fa-trash"></i>
                                </button>` : ''}
                            </div>
                        `;
                        
                        // 如果有图片，显示图片（与论坛帖子相同的方式）
                        if (item.size > 0) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'image-preview-container';
                            imgContainer.style.maxWidth = '100%';
                            imgContainer.style.overflow = 'hidden';
                            
                            // 确保图片内容正确加载
                            if (item.name.toLowerCase().endsWith('.svg')) {
                                // 对于SVG文件，直接使用fetch获取内容
                                fetch(item.download_url)
                                    .then(response => response.text())
                                    .then(svgContent => {
                                        // 创建div容器来显示SVG
                                        const svgContainer = document.createElement('div');
                                        svgContainer.innerHTML = svgContent;
                                        svgContainer.style.maxWidth = '100%';
                                        svgContainer.style.height = 'auto';
                                        svgContainer.style.cursor = 'pointer';
                                        
                                        // 点击时打开原始URL
                                        svgContainer.addEventListener('click', () => {
                                            window.open(item.download_url, '_blank');
                                        });
                                        
                                        imgContainer.appendChild(svgContainer);
                                    })
                                    .catch(() => {
                                        console.error('SVG加载失败');
                                    });
                            } else {
                                // 处理非SVG图片
                                fetch(item.download_url)
                                    .then(response => response.blob())
                                    .then(blob => {
                                        const reader = new FileReader();
                                        reader.onload = function() {
                                            const img = document.createElement('img');
                                            img.src = reader.result;
                                            img.alt = '荣誉图片';
                                            img.className = 'image-preview';
                                            img.style.maxWidth = '100%';
                                            img.style.height = 'auto';
                                            img.style.cursor = 'pointer';
                                            
                                            // 点击图片时打开原始URL
                                            img.addEventListener('click', () => {
                                                window.open(item.download_url, '_blank');
                                            });
                                            
                                            imgContainer.appendChild(img);
                                        };
                                        reader.readAsDataURL(blob);
                                    })
                                    .catch(() => {
                                        console.error('图片加载失败');
                                    });
                            }
                            
                            honorCard.insertBefore(imgContainer, honorCard.firstChild);
                        }
                        honorWall.insertBefore(honorCard, honorWall.firstChild);
                        
                        if (isTeacher) {
                            honorCard.querySelector('.delete-honor-btn').addEventListener('click', async () => {
                                if (confirm('确定要删除这个荣誉吗？')) {
                                    try {
                                        const response = await fetch(item.url, {
                                            method: 'DELETE',
                                            headers: {
                                                'Authorization': `Bearer ${API_KEY}`,
                                                'Accept': 'application/vnd.github+json',
                                                'X-GitHub-Api-Version': '2022-11-28'
                                            },
                                            body: JSON.stringify({
                                                message: `Delete honor ${item.name}`,
                                                sha: item.sha
                                            })
                                        });
                                        
                                        if (response.ok) {
                                            loadHonors();
                                        } else {
                                            alert('删除荣誉失败');
                                        }
                                    } catch (error) {
                                        console.error('删除荣誉错误:', error);
                                    }
                                }
                            });
                        }
                    } catch (e) {
                        console.error('解析荣誉数据错误:', e, item);
                    }
                });
                
            } catch (error) {
                console.error('加载荣誉墙错误:', error);
            }
        }
        
        // 荣誉图片文件选择处理
        document.getElementById('honorImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 验证文件类型
            const isImage = file.type.startsWith('image/');
            const isSVG = file.name.toLowerCase().endsWith('.svg');
            
            if (!isImage && !isSVG) {
                alert('请选择图片文件（支持格式：jpg, png, gif, svg等）');
                e.target.value = '';
                return;
            }
            
            const fileInfo = document.getElementById('honorFileInfo');
            const fileName = document.getElementById('honorFileName');
            const fileSize = document.getElementById('honorFileSize');
            const fileType = document.getElementById('honorFileType');
            
            // 显示文件信息
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileType.textContent = file.type || '未知类型';
            fileInfo.style.display = 'block';
        });
        
        // 点击上传区域触发文件选择
        document.getElementById('honorUploadArea').addEventListener('click', function() {
            document.getElementById('honorImage').click();
        });
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 添加荣誉
        document.getElementById('addHonorBtn').addEventListener('click', async () => {
            const title = document.getElementById('honorTitle').value;
            const description = document.getElementById('honorDescription').value;
            const imageInput = document.getElementById('honorImage');
            
            if (!title || !description) {
                alert('请填写标题和描述');
                return;
            }
            
            // 从本地存储加载管理员状态
            const storedIsAdmin = localStorage.getItem('isAdmin') === 'true';
            const storedIsTeacher = localStorage.getItem('isTeacher') === 'true';
            
            if (!storedIsTeacher && !storedIsAdmin) {
                alert('只有教师或管理员可以上传荣誉墙内容');
                return;
            }
            
            const honorData = {
                id: Date.now().toString(),
                title: title,
                description: description,
                timestamp: new Date().toISOString()
            };
            
            // 将数据编码为Base64作为文件名
            const dataBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(honorData))));
            const fileName = `${dataBase64}.json.png`;
            
            let fileContent = '';
            if (imageInput.files.length) {
                const file = imageInput.files[0];
                
                if (file.size > 20 * 1024 * 1024) {
                    alert('图片大小不能超过20MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function() {
                    fileContent = reader.result.split(',')[1];
                    uploadHonorFile(fileName, fileContent);
                };
                reader.readAsDataURL(file);
            } else {
                uploadHonorFile(fileName, fileContent);
            }
        });
        
        // 上传荣誉文件
        async function uploadHonorFile(fileName, content) {
            try {
                const response = await fetch(`${HONOR_PATH}${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/json; charset=utf-8',
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({
                        message: `Add honor: ${fileName}`,
                        content: content
                    })
                });
                
                if (response.ok) {
                    alert('荣誉添加成功');
                    document.getElementById('honorTitle').value = '';
                    document.getElementById('honorDescription').value = '';
                    document.getElementById('honorImage').value = '';
                    loadHonors();
                } else {
                    const errorData = await response.json();
                    alert(`添加荣誉失败: ${errorData.message || response.status}`);
                }
            } catch (error) {
                console.error('添加荣誉错误:', error);
                alert(`添加荣誉时出错: ${error.message}`);
            }
        }
        
        // 头像上传处理（优化版）
        document.getElementById('avatarUpload')?.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 更严格的图片类型验证
            const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validImageTypes.includes(file.type)) {
                alert('请选择有效的图片格式（JPEG, PNG, GIF, WEBP）');
                e.target.value = ''; // 清空文件选择
                return;
            }
            
            // 预览图片并保存数据
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const avatarUrl = event.target.result;
                    const avatarInitial = document.getElementById('avatarInitial');
                    const avatar = document.getElementById('userAvatar');
                    
                    // 更新本地显示
                    if (avatarInitial) {
                        avatarInitial.remove();
                    }
                    if (avatar) {
                        avatar.style.background = `center/cover no-repeat url(${avatarUrl})`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.textContent = '';
                    }
                    
                    // 保存头像数据到 localStorage 和 userAvatars 数组
                    localStorage.setItem('userAvatar', avatarUrl);
                    
                    const userAvatars = JSON.parse(localStorage.getItem('userAvatars')) || [];
                    const userIndex = userAvatars.findIndex(item => item.email === currentUser);
                    
                    if (userIndex !== -1) {
                        userAvatars[userIndex].avatar = avatarUrl;
                    } else {
                        userAvatars.push({
                            email: currentUser,
                            avatar: avatarUrl
                        });
                    }
                    
                    localStorage.setItem('userAvatars', JSON.stringify(userAvatars));
                    
                    // 同步更新用户数据到云端
                    if (currentUser) {
                        await saveUserData(localStorage.getItem('userName') || currentUser);
                    }
                } catch (error) {
                    console.error('头像处理错误:', error);
                }
            };
            reader.onerror = function() {
                console.error('文件读取失败');
            };
            reader.readAsDataURL(file);
        });
            
        document.addEventListener('DOMContentLoaded', () => {
            // 预填充邮箱和姓名
            const savedEmail = localStorage.getItem('userEmail');
            const savedUserName = localStorage.getItem('userName');
            const savedAvatar = localStorage.getItem('userAvatar');
            const emailInput = document.getElementById('email');
            const userNameInput = document.getElementById('userName');
         
            // 加载用户头像
            if (savedAvatar) {
                document.getElementById('avatarInitial').style.display = 'none';
                document.getElementById('userAvatar').style.backgroundImage = `url(${savedAvatar})`;
                document.getElementById('userAvatar').style.backgroundSize = 'cover';
            }
            
            if (savedEmail && emailInput) {
                emailInput.value = savedEmail;
            }
            if (savedUserName && userNameInput) {
                userNameInput.value = savedUserName;
            }
            
            // 初始加载数据
            fetchUserData();
            loadMaterials();
            loadChatMessages();
            loadPosts();
            updateUnreadCount();
            loadHonors();
            
            // 页面切换时初始化滚动
            if (document.getElementById('chatPage').classList.contains('active')) {
                initChatScroll();
            }
            
            // 设置定时器，每5秒静默刷新局部数据（不刷新整个页面）
            const refreshInterval = setInterval(() => {
                try {
                    fetchUserData();
                } catch (error) {
                    console.error('静默刷新失败:', error);
                }
            }, 60000);
            
            // 绑定上传按钮事件
            document.getElementById('uploadMaterialBtn')?.addEventListener('click', async () => {
                const fileInput = document.getElementById('materialFileInput');
                
                if (!fileInput || !currentUser) return;
                
                // 从本地存储加载管理员状态
                const storedIsAdmin = localStorage.getItem('isAdmin') === 'true';
                const storedIsTeacher = localStorage.getItem('isTeacher') === 'true';
                
                if (!storedIsTeacher && !storedIsAdmin) {
                    alert('只有教师或管理员可以上传学习资料');
                    return;
                }
                
                const files = fileInput.files;
                
                if (files.length === 0) {
                    alert('请选择文件');
                    return;
                }
                
                const file = files[0];
                if (file.size > 20 * 1024 * 1024) {
                    alert('文件大小不能超过20MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async function() {
                    const content = reader.result.split(',')[1];
                    const fileName = file.name;
                    const filePath = `${MATERIALS_PATH}${encodeURIComponent(currentUser)}/${encodeURIComponent(fileName)}`;
                    
                    try {
                        const response = await fetch(filePath, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${API_KEY}`,
                                'Accept': 'application/json; charset=utf-8',
                                'Content-Type': 'application/json; charset=utf-8'
                            },
                            body: JSON.stringify({
                                message: `Upload material: ${fileName}`,
                                content: content
                            })
                        });
                        
                        if (response.ok) {
                            alert('文件上传成功');
                            fileInput.value = '';
                            loadMaterials();
                        } else {
                            alert('文件上传失败');
                        }
                    } catch (error) {
                        console.error('上传文件错误:', error);
                        alert('上传文件时出错');
                    }
                };
                reader.readAsDataURL(file);
            });
            
            // 点击上传区域触发文件选择
            document.querySelector('.upload-area')?.addEventListener('click', () => {
                document.getElementById('materialFileInput').click();
            });
        });
        function showReplyInput(button) {
            // 隐藏回复按钮
            button.style.display = 'none';
            
            // 获取目标用户邮箱（从评论数据中获取）
            const commentItem = button.closest('.comment-item');
            const targetMailbox = commentItem.dataset.sender || 'unknown@example.com';
            
            // 创建回复输入框和发送按钮
            const replyContainer = document.createElement('div');
            replyContainer.className = 'reply-input-container';
            replyContainer.innerHTML = `
                <textarea class="comment-input" placeholder="写下你的回复..."></textarea>
                <button class="btn btn-primary" onclick="sendReply(this)">发送回复</button>
            `;
            
            // 插入到评论项中
            button.parentNode.insertBefore(replyContainer, button.nextSibling);
        }
        
        async function sendComment(button) {
            const commentInput = button.previousElementSibling;
            const commentContent = commentInput.value;
            
            if (!commentContent) {
                alert('请填写评论内容');
                return;
            }
            
            // 确保 MSG_PATH 和 API_KEY 已定义
            if (!MSG_PATH || !API_KEY) {
                alert('错误：MSG_PATH 或 API_KEY 未定义');
                return;
            }
            
            // 获取帖子ID
            const postId = button.closest('.post-item').dataset.id;
            
            // 获取帖子作者邮箱
            const postItem = button.closest('.post-item');
            const postAuthorEmail = postItem.querySelector('.post-author').dataset.email || 'unknown@example.com';
            
            // 构造评论数据（使用 targetTimestamp 关联源贴）
            const commentData = {
                comment: commentContent,
                send_to: 0,
                Target_mailbox: postItem.querySelector('.post-author').dataset.email || 'unknown@example.com', // 确保使用帖子作者的email
                timestamp: new Date().getTime(),
                sender: currentUser,
                senderTimestamp: new Date().getTime(),
                targetTimestamp: postId, // 直接使用帖子ID作为时间戳标识
                email: postItem.querySelector('.post-author').dataset.email // 添加email字段用于后续处理
            };
            
            // 将数据转换为 JSON 字符串并编码为 Base64
            const jsonStr = JSON.stringify(commentData);
            const base64FileName = btoa(unescape(encodeURIComponent(jsonStr)));
            const fileName = `${base64FileName}.json`;
            
            // 构造发送数据，符合 GitHub API 要求
            const data = {
                message: `New comment by ${currentUser}`,
                content: base64FileName, // 直接使用Base64编码的数据作为内容
                sha: '' // 如果需要更新现有文件，需提供 SHA
            };
            
            try {
                // 发送评论到 GitHub API
                const response = await fetch(`${MSG_PATH}/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json',
                        'X-GitHub-Api-Version': '2022-11-28'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('评论已发送');
                    commentInput.value = '';
                    
                    // 立即在页面添加评论
                    const commentList = button.closest('.comment-section').querySelector('.comment-list');
                    const existingComment = Array.from(commentList.querySelectorAll('.comment-item')).find(item => 
                        item.querySelector('.comment-content').textContent === commentContent
                    );
                    
                    if (!existingComment) {
                        const userName = localStorage.getItem('userName') || currentUser;
                        const commentItem = document.createElement('div');
                        commentItem.className = 'comment-item';
                        commentItem.dataset.sender = currentUser; // 保存评论者邮箱
                        commentItem.dataset.targetTimestamp = postId; // 保存关联的源贴ID
                        commentItem.innerHTML = `
                            <div class="comment-author">
                                <div class="author-avatar"></div>
                                <div class="author-name">${userName}</div>
                                <div class="comment-time">${new Date().toLocaleString()}</div>
                            </div>
                            <div class="comment-content">${commentContent}</div>
                            <button class="btn btn-primary reply-btn" onclick="showReplyInput(this)">回复</button>
                        `;
                        commentList.insertBefore(commentItem, commentList.firstChild);
                    }
                } else {
                    const errorData = await response.json();
                    console.error('评论发送失败:', errorData);
                    alert(`评论发送失败: ${errorData.message || '未知错误'}`);
                }
            } catch (error) {
                console.error('发送评论错误:', error);
                alert('发送评论时出错');
            }
        }
        
        async function sendReply(button) {
            // 获取回复内容
            const replyInput = button.previousElementSibling;
            const replyContent = replyInput.value;
            
            if (!replyContent) {
                alert('请填写回复内容');
                return;
            }
            
            // 确保 MSG_PATH 和 API_KEY 已定义
            if (!MSG_PATH || !API_KEY) {
                alert('错误：MSG_PATH 或 API_KEY 未定义');
                return;
            }
            
            // 获取评论项和目标用户邮箱
            const commentItem = button.closest('.comment-item');
            const targetMailbox = commentItem.dataset.sender || 'unknown@example.com';
            const targetCommentId = commentItem.dataset.id || ''; // 获取目标评论ID

            // 构造回复数据
            const replyData = {
                content: replyContent,
                send_to: 1,
                Target_mailbox: commentItem.dataset.sender || 'unknown@example.com', // 确保使用被回复评论的邮箱
                timestamp: new Date().toISOString(),
                sender: currentUser,
                targetTimestamp: commentItem.dataset.sender || new Date().getTime(), // 直接使用目标评论的timestamp键值
                senderTimestamp: new Date().getTime(),
                targetPostId: commentItem.closest('.post-item').dataset.id, // 添加目标帖子ID
                targetCommentId: targetCommentId // 添加目标评论ID
            };
            
            // 将数据转换为 JSON 字符串并编码为 Base64
            const jsonStr = JSON.stringify(replyData);
            const base64FileName = btoa(unescape(encodeURIComponent(jsonStr)));
            const fileName = `${base64FileName}.json`;
            
            // 构造发送数据，符合 GitHub API 要求
            const data = {
                message: `New reply by ${currentUser}`,
                content: base64FileName, // 直接使用Base64编码的数据作为内容
                sha: '' // 如果需要更新现有文件，需提供 SHA
            };
            
            try {
                // 发送回复到 GitHub API
                const response = await fetch(`${MSG_PATH}/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'Accept': 'application/vnd.github+json',
                        'X-GitHub-Api-Version': '2022-11-28'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('回复已发送');
                    replyInput.value = '';
                    button.parentNode.style.display = 'none';
                    const replyBtn = button.parentNode.parentNode.querySelector('.reply-btn');
                    replyBtn.style.display = 'inline-block';
                    
                    // 立即在页面添加回复
                    const commentItem = button.closest('.comment-item');
                    const userName = localStorage.getItem('userName') || currentUser;
                    const replyItem = document.createElement('div');
                    replyItem.className = 'comment-item';
                    replyItem.dataset.sender = currentUser; // 绑定发送者邮箱
                    replyItem.innerHTML = `
                        <div class="comment-author">
                            <div class="author-avatar"></div>
                            <div class="author-name">
                                ${userName}
                                <span style="color: #999; font-size: 0.8em;">@${targetMailbox}</span>
                            </div>
                            <div class="comment-time">${new Date().toLocaleString()}</div>
                        </div>
                        <div class="comment-content">${replyContent}</div>
                        <div class="reply-arrow" style="position: absolute; left: -15px; top: 50%; transform: translateY(-50%); width: 15px; height: 2px; background-color: #999; border-left: 2px solid #999; transition: all 0.3s ease; z-index: 1;"></div>
                        <button class="btn btn-primary reply-btn" onclick="showReplyInput(this)">回复</button>
                    `;
                    
                    // 插入到评论项下方
                    commentItem.parentNode.insertBefore(replyItem, commentItem.nextSibling);
                } else {
                    const errorData = await response.json();
                    console.error('回复发送失败:', errorData);
                    alert(`回复发送失败: ${errorData.message || '未知错误'}`);
                }
            } catch (error) {
                console.error('发送回复错误:', error);
                alert('发送回复时出错');
            }
        }
        function messagebtn() {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
            modal.style.zIndex = '1000';
            modal.style.overflow = 'auto';
            
            // 获取隐藏容器中的通知数据
            const notifications = Array.from(document.querySelectorAll('.notification-item'));
            let notificationContent = '<div style="padding: 20px;">';
            
            notifications.forEach(notification => {
                const content = notification.querySelector('.notification-content p').textContent;
                const timestamp = notification.querySelector('.notification-content small').textContent;
                const type = notification.dataset.type || '评论';
                const sender = notification.dataset.sender || '用户';
                const hasImage = notification.dataset.hasImage === 'true';
                
                notificationContent += `
                    <div style="margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #eee;">
                        <p><strong>${sender}</strong>@了你的${type}</p>
                        <p>${content}</p>
                        ${hasImage ? '<p>【图片】</p>' : ''}
                        <small>${timestamp}</small>
                        <button onclick="navigateToPost('${notification.dataset.postId}')" style="margin-top: 5px; padding: 5px 10px; background: #4e73df; color: white; border: none; border-radius: 4px; cursor: pointer;">查看帖子</button>
                    </div>
                `;
            });
            
            notificationContent += '</div>';
            
            modal.innerHTML = `
                <div style="position: relative;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 0; right: 0; background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                    <h3 style="padding: 20px 20px 0;">消息通知</h3>
                    ${notificationContent}
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function navigateToPost(postId) {
            // 这里实现导航到帖子的逻辑
            console.log('导航到帖子:', postId);
        }
</script>
</body>
</html>
